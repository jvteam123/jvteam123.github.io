<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Segment Randomizer</title>
    <script src="https://cdn.tailwindcss.com/3.4.3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- DARK THEME STYLES --- */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1e293b;
            color: #cbd5e1;
            font-family: "Inter", sans-serif;
            padding: 1rem;
        }
        h2, h3 { color: #f1f5f9; }
        .container {
            background-color: #334155;
            padding: 2.5rem;
            border-radius: 0.75rem;
            border: 1px solid #475569;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            text-align: center;
            width: 100%;
            max-width: 1400px;
        }
        .time-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            overflow: hidden;
            font-size: 0.9rem;
        }
        .time-table th, .time-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #475569;
            vertical-align: middle;
        }
        .time-table th {
            background-color: #475569;
            color: #f1f5f9;
            font-weight: 600;
        }
        .time-table td { font-family: monospace; font-size: 0.95rem; color: #e2e8f0; }
        .time-table tbody tr:last-child td { border-bottom: none; }
        .time-table tbody tr:hover { background-color: #404d61; }
        .time-table select {
            width: 100%; background-color: #334155; color: #f1f5f9;
            border: 1px solid #64748b; border-radius: 0.375rem; padding: 0.35rem;
            font-family: "Inter", sans-serif; font-size: 0.85rem;
        }
        .time-table select:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .time-table input.editable-date {
            background-color: transparent;
            border: none;
            color: #e2e8f0;
            padding: 0;
            font-size: 0.95rem;
            font-family: monospace;
            width: 100%;
        }
        .time-table input.editable-date:focus {
            background-color: #1e293b;
            outline: 1px solid #3b82f6;
            border-radius: 2px;
        }
        .button-remove {
            background-color: #be123c; color: white;
            padding: 0.3rem 0.6rem; border-radius: 0.25rem;
            font-size: 0.75rem; font-weight: 600; cursor: pointer;
            border: none; transition: background-color 0.2s;
        }
        .button-remove:hover { background-color: #9f1239; }
        .button {
            padding: 0.75rem 1.5rem; margin: 0.5rem; border-radius: 0.375rem;
            cursor: pointer; font-size: 1rem; font-weight: 500;
            transition: all 0.2s ease-in-out; border: none;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .button-primary { background-color: #3b82f6; color: white; }
        .button-primary:hover { background-color: #2563eb; }
        .button-secondary { background-color: #475569; color: #f1f5f9; }
        .button-secondary:hover { background-color: #64748b; }
        .message-box {
            margin-top: 1.5rem; padding: 0.85rem; border-radius: 0.375rem;
            font-weight: 500; visibility: hidden; opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.visible { visibility: visible; opacity: 1; }
        .message-box:not(.error) { background-color: #166534; color: #dcfce7; border: 1px solid #22c55e; }
        .message-box.error { background-color: #991b1b; color: #fee2e2; border: 1px solid #f87171; }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.75);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #334155; margin: auto; padding: 2rem;
            border: 1px solid #475569; width: 90%;
            border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            position: relative;
        }
        .close-button {
            color: #94a3b8; font-size: 28px; font-weight: bold;
            position: absolute; top: 15px; right: 25px;
            cursor: pointer; transition: color 0.2s ease;
        }
        .close-button:hover, .close-button:focus { color: #f1f5f9; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: #cbd5e1; margin-bottom: 0.5rem; text-align: left; }
        .form-group input, .form-group select {
            width: 100%; background-color: #334155; color: #f1f5f9;
            border: 1px solid #64748b; border-radius: 0.375rem; padding: 0.5rem 0.75rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
    </style>
</head>
<body>

    <div class="container">
        <h2 class="text-3xl font-bold mb-2">Time Segment Randomizer</h2>
        <p class="text-slate-300 mb-8">Generates time-logged rows based on a series of time points with randomized seconds.</p>
        <div id="durationWarning" class="hidden p-4 mb-4 text-sm text-yellow-200 bg-yellow-800 border border-yellow-700 rounded-lg text-left" role="alert"></div>
        <table class="time-table">
            <thead>
                <tr>
                    <th>TechNumber</th><th>Username</th><th>Shift</th><th>Date</th><th>Start Time</th><th>End Time</th>
                    <th>Hours</th><th>MainCategory</th><th>SubCategory</th><th>OT</th><th>Actions</th>
                </tr>
            </thead>
            <tbody id="timeTableBody"></tbody>
        </table>
        <button id="randomizeButton" class="button button-primary">Randomize & Recalculate</button>
        <button id="insertTaskButton" class="button bg-green-600 hover:bg-green-700 text-white">Insert Task</button>
        <button id="copyButton" class="button button-secondary">Copy Table</button>
        <button id="settingsButton" class="button button-secondary">Settings</button>
        <button id="clearDataButton" class="button bg-red-700 hover:bg-red-800 text-white">Clear Data</button>
        <div id="messageBox" class="message-box"></div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 896px;">
            <span id="closeSettingsModalButton" class="close-button">&times;</span>
            <h3 class="text-2xl font-semibold mb-6">Settings</h3>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-[#1e293b] border border-slate-700 p-5 rounded-md">
                    <h4 class="text-lg font-semibold text-slate-200 mb-4 pb-2 border-b border-slate-600">General Info & Schedule</h4>
                    <div class="form-group">
                        <label for="selectScheduleDropdown">Select Saved Schedule</label>
                        <div class="flex items-center gap-2">
                            <select id="selectScheduleDropdown" class="flex-grow"></select>
                            <button id="deleteScheduleButton" class="button-remove !m-0 !py-2.5">Delete</button>
                        </div>
                    </div>
                     <div class="form-group">
                       <label class="!mb-2">Or, Generate a New Schedule</label>
                       <button id="generateScheduleButton" class="button !m-0 bg-indigo-600 hover:bg-indigo-700 text-sm w-full py-2 px-3">Open Schedule Generator</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group"><label for="techNumberInput">Tech Number</label><input type="text" id="techNumberInput"></div>
                        <div class="form-group"><label for="usernameInput">Username</label><input type="text" id="usernameInput"></div>
                        <div class="form-group"><label for="shiftInput">Shift</label><select id="shiftInput"><option value="Day">Day</option><option value="Night">Night</option></select></div>
                        <div class="form-group"><label for="dateInput">Start Date</label><input type="date" id="dateInput"></div>
                         <div class="form-group col-span-2"><label for="otInput">OT</label><select id="otInput"><option value="NO">NO</option><option value="YES">YES</option></select></div>
                    </div>
                </div>
                <div class="bg-[#1e293b] border border-slate-700 p-5 rounded-md">
                    <h4 class="text-lg font-semibold text-slate-200 mb-4 pb-2 border-b border-slate-600">Default Category</h4>
                    <p class="text-slate-400 font-normal text-sm -mt-4 mb-4">Used for all non-break segments.</p>
                    <div class="form-group mt-4"><label for="mainCatSelect">Main Category</label><select id="mainCatSelect"></select></div>
                    <div class="form-group"><label for="subCatSelect">Sub Category</label><select id="subCatSelect"></select></div>
                </div>
            </div>
            <div class="flex justify-between items-center mt-6 pt-4 border-t border-slate-600">
                <button id="resetSettingsButton" class="button bg-yellow-600 hover:bg-yellow-700 text-white">Reset All Data</button>
                <div>
                    <button id="saveSettingsButton" class="button button-primary mr-2">Save & Apply</button>
                    <button id="cancelSettingsButton" class="button button-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="scheduleModal" class="modal">
        <div class="modal-content max-w-md">
             <h3 class="text-2xl font-semibold mb-6">Generate Time Points</h3>
             <div class="space-y-4">
                <div class="form-group !mb-6">
                    <label for="scheduleTemplateNameInput">Schedule Name (for saving)</label>
                    <input type="text" id="scheduleTemplateNameInput" placeholder="e.g., Weekday Shift">
                </div>
                <div class="form-group"><label for="schedTimeIn">Time IN</label><input type="time" id="schedTimeIn" class="w-full"></div>
                <div class="form-group"><label for="schedBreak1">1st Break Start (15 min)</label><input type="time" id="schedBreak1" class="w-full"></div>
                <div class="form-group"><label for="schedLunch">Lunch Start (1 hour)</label><input type="time" id="schedLunch" class="w-full"></div>
                <div class="form-group"><label for="schedBreak2">2nd Break Start (15 min)</label><input type="time" id="schedBreak2" class="w-full"></div>
                <div class="form-group"><label for="schedTimeOut">Time OUT</label><input type="time" id="schedTimeOut" class="w-full"></div>
             </div>
             <div id="scheduleErrorMessage" class="text-red-400 mt-4 text-sm h-4"></div>
             <div class="flex justify-between items-center mt-6 pt-4 border-t border-slate-600">
                <button id="saveScheduleTemplateButton" class="button button-secondary !m-0">Save Template</button>
                <div>
                    <button id="applyScheduleButton" class="button button-primary mr-2">Apply</button>
                    <button id="cancelScheduleButton" class="button button-secondary">Cancel</button>
                </div>
             </div>
        </div>
    </div>

    <div id="insertTaskModal" class="modal">
        <div class="modal-content max-w-lg">
             <span id="closeTaskModalButton" class="close-button">&times;</span>
             <h3 class="text-2xl font-semibold mb-6">Insert New Task</h3>
             <div class="space-y-4">
                <div class="form-group"><label for="taskSegmentSelect">Split this time segment:</label><select id="taskSegmentSelect"></select></div>
                <div class="form-group"><label for="taskDurationInput">New Task Duration (in minutes)</label><input type="number" id="taskDurationInput" placeholder="e.g., 20"></div>
                <div class="form-group"><label for="taskMainCatSelect">New Task Main Category</label><select id="taskMainCatSelect"></select></div>
                <div class="form-group"><label for="taskSubCatSelect">New Task Sub Category</label><select id="taskSubCatSelect"></select></div>
             </div>
             <div id="taskErrorMessage" class="text-red-400 mt-4 text-sm h-4"></div>
             <div class="flex justify-end items-center mt-6 pt-4 border-t border-slate-600">
                <button id="applyTaskButton" class="button button-primary mr-2">Insert Task</button>
                <button id="cancelTaskButton" class="button button-secondary">Cancel</button>
             </div>
        </div>
    </div>
    <script>
    // --- ELEMENT REFERENCES ---
    const timeTableBody = document.getElementById('timeTableBody'), randomizeButton = document.getElementById('randomizeButton'), copyButton = document.getElementById('copyButton'), messageBox = document.getElementById('messageBox'), insertTaskButton = document.getElementById('insertTaskButton'), settingsButton = document.getElementById('settingsButton'), durationWarning = document.getElementById('durationWarning'), clearDataButton = document.getElementById('clearDataButton');
    const settingsModal = document.getElementById('settingsModal'), saveSettingsButton = document.getElementById('saveSettingsButton'), cancelSettingsButton = document.getElementById('cancelSettingsButton'), closeSettingsModalButton = document.getElementById('closeSettingsModalButton'), resetSettingsButton = document.getElementById('resetSettingsButton');
    const selectScheduleDropdown = document.getElementById('selectScheduleDropdown'), deleteScheduleButton = document.getElementById('deleteScheduleButton');
    const scheduleModal = document.getElementById('scheduleModal'), generateScheduleButton = document.getElementById('generateScheduleButton'), applyScheduleButton = document.getElementById('applyScheduleButton'), cancelScheduleButton = document.getElementById('cancelScheduleButton'), saveScheduleTemplateButton = document.getElementById('saveScheduleTemplateButton'), scheduleErrorMessage = document.getElementById('scheduleErrorMessage');
    const insertTaskModal = document.getElementById('insertTaskModal'), closeTaskModalButton = document.getElementById('closeTaskModalButton'), applyTaskButton = document.getElementById('applyTaskButton'), cancelTaskButton = document.getElementById('cancelTaskButton'), taskErrorMessage = document.getElementById('taskErrorMessage');

    // --- GLOBAL STATE & CONSTANTS ---
    const LOCAL_STORAGE_KEY = 'timeRandomizerSettings_v26_editIcon';
    const SCHEDULE_TEMPLATES_KEY = 'timeRandomizerScheduleTemplates_v1';
    const DURATION_LIMIT_SECONDS = 27000;
    const categoryData = { "BREAK": ["BREAK"], "SARANAC": ["CF"], "ACCUPLUS": ["DEM", "I3", "PCS", "REFIX", "i3QA", "RQA"], "DOWNTIME": ["System", "NoProject"], "TRAINING": ["Formal - Accuplus"] };
    let currentSettings = {}, currentDisplayedData = [], randomizedTimes = [];

    // --- INITIALIZATION & SETTINGS MANAGEMENT ---
    function generateHardcodedDefaultTimePoints() {
         const originalTimeSegments = [ { start: "13:45:00", end: "15:30:00" }, { start: "13:30:00", end: "13:45:00" }, { start: "12:00:00", end: "13:30:00" }, { start: "11:00:00", end: "12:00:00" }, { start: "08:45:00", end: "11:00:00" }, { start: "08:30:00", end: "08:45:00" }, { start: "06:30:00", end: "08:30:00" } ];
        const timePointStrings = new Set();
        originalTimeSegments.forEach(entry => { timePointStrings.add(entry.start); timePointStrings.add(entry.end); });
        const sortedTimePoints = Array.from(timePointStrings).sort((a, b) => {
             let minutesA = timeStringToMinutes(a), minutesB = timeStringToMinutes(b);
             if (minutesA > 1000 && minutesB < 500) return -1; if (minutesB > 1000 && minutesA < 500) return 1; return minutesA - minutesB;
        });
        return sortedTimePoints.map(timeStr => timeString24hrToPointObject(timeStr));
    }

    function getDefaultSettings() {
        const today = new Date(), offset = today.getTimezoneOffset(), localToday = new Date(today.getTime() - (offset*60*1000)), formattedDate = localToday.toISOString().split('T')[0];
        return {
            techNumber: '7236', username: 'lorens.ebrado', shift: 'Day', date: formattedDate, ot: 'NO',
            categoryPair1: { main: 'DOWNTIME', sub: 'NoProject' }, timePoints: generateHardcodedDefaultTimePoints()
        };
    }

    function initializeSettings(forceReset = false) {
        if (forceReset) { localStorage.removeItem(LOCAL_STORAGE_KEY); localStorage.removeItem(SCHEDULE_TEMPLATES_KEY); }
        const storedSettings = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (storedSettings) {
            try {
                const loaded = JSON.parse(storedSettings); if (loaded.timePoints && loaded.categoryPair1) { currentSettings = loaded; return; }
            } catch (e) { console.error("Failed to parse settings", e); }
        }
        currentSettings = getDefaultSettings();
    }

    // --- UTILITY FUNCTIONS ---
    function formatTimeComponent(c) { return String(c).padStart(2, '0'); }
    function timeStringToMinutes(timeStr) { const [h=0, m=0] = (timeStr || "0:0").split(':').map(Number); return h * 60 + m; }
    function timeString24hrToSeconds(timeStr) { const parts = (timeStr || "0:0:0").split(':'); return (parseInt(parts[0],10) * 3600) + (parseInt(parts[1],10) * 60) + (parseInt(parts[2],10) || 0); }
    function secondsToTimeString(totalSeconds) { const h = Math.floor(totalSeconds / 3600), m = Math.floor((totalSeconds % 3600) / 60), s = totalSeconds % 60; return `${formatTimeComponent(h)}:${formatTimeComponent(m)}:${formatTimeComponent(s)}`; }
    function addMinutesToTime(timeStr, minutesToAdd) { const totalMinutes = timeStringToMinutes(timeStr) + minutesToAdd; const newHours = Math.floor(totalMinutes / 60) % 24, newMinutes = totalMinutes % 60; return `${formatTimeComponent(newHours)}:${formatTimeComponent(newMinutes)}`; }
    function convert12hrTo24hr(h12, period) { let h24 = parseInt(h12, 10); if (period.toUpperCase() === 'PM' && h24 !== 12) h24 += 12; else if (period.toUpperCase() === 'AM' && h24 === 12) h24 = 0; return h24; }
    function convert24hrTo12hr(h24, min) { const period = h24 >= 12 ? 'PM' : 'AM'; let hour12 = h24 % 12; if (hour12 === 0) hour12 = 12; return { hour: hour12, minute: parseInt(min, 10), period: period }; }
    function timeString24hrToPointObject(timeStr) { const parts = timeStr.split(':'), hour24 = parts[0], minute = parts[1], second = parts[2] || '00'; const converted = convert24hrTo12hr(parseInt(hour24, 10), parseInt(minute, 10)); return { originalReferenceTime: `${hour24}:${minute}:${second}`, currentHour: converted.hour, currentMinute: converted.minute, currentPeriod: converted.period, override: null, isInsertedTaskEndPoint: false, uniqueId: `tp-${Date.now()}-${Math.random()}` }; }
    
    // --- CORE LOGIC ---
    function run(randomize = true) {
        const { timePoints } = currentSettings;
        if (!timePoints || timePoints.length <= 1) { currentDisplayedData = []; updateDisplay(); return; }
        const datesForTimePoints = new Array(timePoints.length);
        if (timePoints.length > 0) {
            let currentDate = new Date(currentSettings.date + 'T12:00:00Z'); datesForTimePoints[0] = currentDate.toISOString().slice(0, 10);
            for (let i = 1; i < timePoints.length; i++) {
                const prevMins = convert12hrTo24hr(timePoints[i-1].currentHour, timePoints[i-1].currentPeriod) * 60 + timePoints[i-1].currentMinute;
                const currMins = convert12hrTo24hr(timePoints[i].currentHour, timePoints[i].currentPeriod) * 60 + timePoints[i].currentMinute;
                if (currMins < prevMins) { currentDate.setDate(currentDate.getDate() + 1); }
                datesForTimePoints[i] = currentDate.toISOString().slice(0, 10);
            }
        }
        if (randomize || randomizedTimes.length !== timePoints.length) { randomizedTimes = timePoints.map(tp => { const h24 = convert12hrTo24hr(tp.currentHour, tp.currentPeriod); return `${formatTimeComponent(h24)}:${formatTimeComponent(tp.currentMinute)}:${formatTimeComponent(Math.floor(Math.random()*60))}`; }); }
        const newTableData = [];
        for (let i = 0; i < timePoints.length - 1; i++) {
            const startPoint = timePoints[i], nextPoint = timePoints[i+1];
            let assignedCategory, assignedOT;
            if (startPoint.override) { assignedCategory = startPoint.override; assignedOT = startPoint.override.ot || currentSettings.ot; } 
            else {
                let startMins = convert12hrTo24hr(startPoint.currentHour, startPoint.currentPeriod) * 60 + startPoint.currentMinute;
                let endMins = convert12hrTo24hr(nextPoint.currentHour, nextPoint.currentPeriod) * 60 + nextPoint.currentMinute;
                if (endMins < startMins) { endMins += 24 * 60; }
                const durationMins = endMins - startMins;
                if (durationMins === 15 || durationMins === 60) { assignedCategory = { main: 'BREAK', sub: 'BREAK' }; assignedOT = 'NO'; } 
                else { assignedCategory = currentSettings.categoryPair1; assignedOT = currentSettings.ot; }
            }
            const startTime24Hr = randomizedTimes[i], endTime24Hr = randomizedTimes[i + 1];
            let startTotalSecs = timeString24hrToSeconds(startTime24Hr), endTotalSecs = timeString24hrToSeconds(endTime24Hr);
            if (endTotalSecs < startTotalSecs) endTotalSecs += 24 * 3600;
            const durationSecs = endTotalSecs - startTotalSecs;
            const [startH, startM, startS] = startTime24Hr.split(':'), start12hr = convert24hrTo12hr(startH, startM);
            const [endH, endM, endS] = endTime24Hr.split(':'), end12hr = convert24hrTo12hr(endH, endM);
            newTableData.push({ ...currentSettings, date: datesForTimePoints[i], start: `${start12hr.hour}:${formatTimeComponent(start12hr.minute)}:${startS} ${start12hr.period}`, end: `${end12hr.hour}:${formatTimeComponent(end12hr.minute)}:${endS} ${end12hr.period}`, startTime24: startTime24Hr, endTime24: endTime24Hr, duration: secondsToTimeString(durationSecs), mainCategory: assignedCategory.main, subCategory: assignedCategory.sub, ot: assignedOT });
        }
        currentDisplayedData = newTableData.reverse(); updateDisplay(); checkTotalWorkHours();
    }
    function checkTotalWorkHours() {
        let totalWorkSecs = 0;
        currentDisplayedData.forEach(e => { if (e.mainCategory !== 'BREAK') { totalWorkSecs += timeString24hrToSeconds(e.duration); } });
        durationWarning.classList.toggle('hidden', totalWorkSecs <= DURATION_LIMIT_SECONDS);
        if (totalWorkSecs > DURATION_LIMIT_SECONDS) { durationWarning.textContent = `Warning: Total work hours are ${secondsToTimeString(totalWorkSecs)}, which exceeds the 07:30:00 limit.`; }
    }

    function updateDisplay() {
        timeTableBody.innerHTML = '';
        const createCell = (text) => {
            const cell = document.createElement('td');
            cell.textContent = text;
            return cell;
        };
        currentDisplayedData.forEach((entry, displayIndex) => {
            const chronoIndex = (currentSettings.timePoints.length - 2) - displayIndex;
            const endPoint = currentSettings.timePoints[chronoIndex + 1];
            const row = document.createElement('tr');
            
            row.appendChild(createCell(entry.techNumber));
            row.appendChild(createCell(entry.username));
            row.appendChild(createCell(entry.shift));
            
            const dateCell = document.createElement('td');
            if (displayIndex === currentDisplayedData.length - 1) {
                // MODIFICATION: Add a container and icon
                const container = document.createElement('div');
                container.className = 'flex items-center gap-2';

                const dateInput = document.createElement('input');
                dateInput.type = 'text';
                dateInput.value = entry.date;
                dateInput.className = 'editable-date flex-grow';
                dateInput.addEventListener('change', (e) => {
                    const newValue = e.target.value;
                    const isValidFormat = /^\d{4}-\d{2}-\d{2}$/.test(newValue);
                    const isValidDate = !isNaN(Date.parse(newValue));
                    if (isValidFormat && isValidDate) {
                        currentSettings.date = newValue;
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings));
                        run(false);
                        showMessageBox("Shift start date updated.");
                    } else {
                        e.target.value = entry.date;
                        showMessageBox("Invalid date. Please use YYYY-MM-DD format.", true);
                    }
                });

                const iconSpan = document.createElement('span');
                iconSpan.className = 'text-slate-500'; // Icon color
                iconSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L6.75 6.774a2.75 2.75 0 0 0-.596.892l-1.023 3.068a.75.75 0 0 0 .963.963l3.068-1.023a2.75 2.75 0 0 0 .892-.596l4.262-4.263a1.75 1.75 0 0 0 0-2.474Z" /><path d="M4.75 3.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h6.5c.69 0 1.25-.56 1.25-1.25V9.5A.75.75 0 0 1 14 9.5v2.25A2.75 2.75 0 0 1 11.25 14h-6.5A2.75 2.75 0 0 1 2 11.25v-6.5A2.75 2.75 0 0 1 4.75 2H7a.75.75 0 0 1 0 1.5H4.75Z" /></svg>`;

                container.appendChild(dateInput);
                container.appendChild(iconSpan);
                dateCell.appendChild(container);
            } else {
                dateCell.textContent = entry.date;
            }
            row.appendChild(dateCell);

            row.appendChild(createCell(entry.start));
            row.appendChild(createCell(entry.end));
            row.appendChild(createCell(entry.duration));
            
            const mainCatCell = document.createElement('td'), mainCatSelect = document.createElement('select');
            mainCatSelect.innerHTML = Object.keys(categoryData).map(k => `<option value="${k}" ${k === entry.mainCategory ? 'selected' : ''}>${k}</option>`).join(''); mainCatCell.appendChild(mainCatSelect);
            const subCatCell = document.createElement('td'), subCatSelect = document.createElement('select');
            updateSubCategoryDropdown(mainCatSelect, subCatSelect, entry.subCategory, false); subCatCell.appendChild(subCatSelect);
            const otCell = document.createElement('td'), otSelect = document.createElement('select');
            otSelect.innerHTML = `<option value="NO" ${entry.ot === 'NO' ? 'selected' : ''}>NO</option><option value="YES" ${entry.ot === 'YES' ? 'selected' : ''}>YES</option>`; otCell.appendChild(otSelect);
            const actionCell = document.createElement('td');
            if (endPoint.isInsertedTaskEndPoint) { const removeBtn = document.createElement('button'); removeBtn.textContent = 'Remove'; removeBtn.className = 'button-remove'; removeBtn.onclick = () => removeTask(chronoIndex + 1); actionCell.appendChild(removeBtn); }
            row.appendChild(mainCatCell); row.appendChild(subCatCell); row.appendChild(otCell); row.appendChild(actionCell);
            timeTableBody.appendChild(row);

            mainCatSelect.onchange = () => { updateSubCategoryDropdown(mainCatSelect, subCatSelect, null, true); updateRowOverride(chronoIndex, mainCatSelect.value, subCatSelect.value, otSelect.value); };
            subCatSelect.onchange = () => updateRowOverride(chronoIndex, mainCatSelect.value, subCatSelect.value, otSelect.value);
            otSelect.onchange = () => updateRowOverride(chronoIndex, mainCatSelect.value, subCatSelect.value, otSelect.value);
        });
    }

    function copyTableDataToClipboard() {
        if (currentDisplayedData.length === 0) { showMessageBox('No data to copy.', true); return; }
        let textToCopy = currentDisplayedData.map(e => `${e.techNumber}\t${e.username}\t${e.shift}\t${e.date}\t${e.startTime24}\t${e.endTime24}\t${e.duration}\t${e.mainCategory}\t${e.subCategory}\t${e.ot}`).join('\n');
        navigator.clipboard.writeText(textToCopy).then(() => showMessageBox('Table data copied (24hr format, no headers)!'), () => showMessageBox('Failed to copy table data.', true));
    }
    function showMessageBox(message, isError = false) {
        messageBox.textContent = message; messageBox.className = 'message-box visible';
        messageBox.classList.toggle('error', isError);
        setTimeout(() => messageBox.className = 'message-box', 4000);
    }
    // --- MODAL & ACTION LOGIC ---
    function updateSubCategoryDropdown(mainSelect, subSelect, selectedSub = null, isChangeEvent = false) { const subOptions = categoryData[mainSelect.value] || []; subSelect.innerHTML = subOptions.map(opt => `<option value="${opt}">${opt}</option>`).join(''); if (!isChangeEvent && selectedSub && subOptions.includes(selectedSub)) { subSelect.value = selectedSub; } else if (subOptions.length > 0) { subSelect.value = subOptions[0]; } }
    function updateRowOverride(chronoIndex, main, sub, ot) { const startPoint = currentSettings.timePoints[chronoIndex]; if (!startPoint.override) startPoint.override = {}; startPoint.override.main = main; startPoint.override.sub = sub; startPoint.override.ot = ot; localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings)); run(false); }
    function removeTask(timePointIndexToRemove) { currentSettings.timePoints[timePointIndexToRemove - 1].override = null; currentSettings.timePoints.splice(timePointIndexToRemove, 1); localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings)); run(true); showMessageBox("Task removed and merged."); }
    function openSettingsModal() { document.getElementById('techNumberInput').value = currentSettings.techNumber; document.getElementById('usernameInput').value = currentSettings.username; document.getElementById('shiftInput').value = currentSettings.shift; document.getElementById('dateInput').value = currentSettings.date; document.getElementById('otInput').value = currentSettings.ot; const mainCatSelect = document.getElementById('mainCatSelect'), subCatSelect = document.getElementById('subCatSelect'); mainCatSelect.innerHTML = Object.keys(categoryData).filter(k=>k!=="BREAK").map(k => `<option value="${k}">${k}</option>`).join(''); mainCatSelect.value = currentSettings.categoryPair1.main; updateSubCategoryDropdown(mainCatSelect, subCatSelect, currentSettings.categoryPair1.sub); populateScheduleDropdown(); settingsModal.style.display = 'flex'; }
    function saveSettings() { currentSettings.techNumber = document.getElementById('techNumberInput').value; currentSettings.username = document.getElementById('usernameInput').value; currentSettings.shift = document.getElementById('shiftInput').value; currentSettings.date = document.getElementById('dateInput').value; currentSettings.ot = document.getElementById('otInput').value; currentSettings.categoryPair1 = { main: document.getElementById('mainCatSelect').value, sub: document.getElementById('subCatSelect').value }; localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings)); settingsModal.style.display = 'none'; run(true); showMessageBox('Settings saved!'); }
    
    // --- SCHEDULE MANAGEMENT ---
    function getScheduleTemplates() { return JSON.parse(localStorage.getItem(SCHEDULE_TEMPLATES_KEY)) || []; }
    function saveScheduleTemplates(templates) { localStorage.setItem(SCHEDULE_TEMPLATES_KEY, JSON.stringify(templates)); }
    function populateScheduleDropdown() {
        const templates = getScheduleTemplates(); selectScheduleDropdown.innerHTML = '<option value="-1">Select to apply...</option>';
        const defaultOption = document.createElement('option'); defaultOption.value = 'default'; defaultOption.textContent = 'Default'; selectScheduleDropdown.appendChild(defaultOption);
        templates.forEach((template, index) => { const option = document.createElement('option'); option.value = index; option.textContent = template.name; selectScheduleDropdown.appendChild(option); });
    }
    function deleteSelectedSchedule() {
        const selectedValue = selectScheduleDropdown.value;
        if (selectedValue === "-1") { showMessageBox('Select a schedule to delete.', true); return; }
        if (selectedValue === "default") { showMessageBox('The Default schedule cannot be deleted.', true); return; }
        if (confirm(`Are you sure you want to delete the "${selectScheduleDropdown.options[selectScheduleDropdown.selectedIndex].text}" schedule?`)) {
            let templates = getScheduleTemplates(); templates.splice(parseInt(selectedValue, 10), 1);
            saveScheduleTemplates(templates); populateScheduleDropdown(); showMessageBox('Schedule deleted.');
        }
    }
    function saveScheduleTemplate() {
        const name = document.getElementById('scheduleTemplateNameInput').value.trim();
        if (!name) { scheduleErrorMessage.textContent = 'Please enter a name for the schedule.'; return; }
        if (name.toLowerCase() === 'default') { scheduleErrorMessage.textContent = 'Cannot use the reserved name "Default".'; return; }
        const times = { timeIn: document.getElementById('schedTimeIn').value, break1: document.getElementById('schedBreak1').value, lunch:  document.getElementById('schedLunch').value, break2: document.getElementById('schedBreak2').value, timeOut: document.getElementById('schedTimeOut').value };
        if (!times.timeIn || !times.timeOut) { scheduleErrorMessage.textContent = 'Time IN and OUT are required to save.'; return; }
        let templates = getScheduleTemplates();
        const existingIndex = templates.findIndex(t => t.name.toLowerCase() === name.toLowerCase());
        if (existingIndex > -1) { if (confirm(`A schedule named "${name}" already exists. Overwrite it?`)) { templates[existingIndex].times = times; } else { return; } } 
        else { templates.push({ name, times }); }
        saveScheduleTemplates(templates); showMessageBox(`Schedule "${name}" saved!`); populateScheduleDropdown(); scheduleModal.style.display = 'none';
    }
    function generateTimePointsFromSchedule(scheduleTimes, onError) {
        for (const key in scheduleTimes) { if (!scheduleTimes[key]) { onError(`Error: Please fill in all time fields.`); return null; } }
        const calculatedPoints = [ scheduleTimes.timeIn, scheduleTimes.break1, addMinutesToTime(scheduleTimes.break1, 15), scheduleTimes.lunch, addMinutesToTime(scheduleTimes.lunch, 60), scheduleTimes.break2, addMinutesToTime(scheduleTimes.break2, 15), scheduleTimes.timeOut ];
        const pointsInMins = calculatedPoints.map(t => timeStringToMinutes(t));
        for (let i = 1; i < pointsInMins.length; i++) { if (pointsInMins[i] < pointsInMins[i-1] && (pointsInMins[i-1] - pointsInMins[i] < 720)) { onError('Error: Times must be in chronological order.'); return null; } }
        return calculatedPoints.map(t => timeString24hrToPointObject(t));
    }
    function handleApplySchedule() {
        const scheduleTimes = { timeIn: document.getElementById('schedTimeIn').value, break1: document.getElementById('schedBreak1').value, lunch: document.getElementById('schedLunch').value, break2: document.getElementById('schedBreak2').value, timeOut: document.getElementById('schedTimeOut').value };
        const newTimePoints = generateTimePointsFromSchedule(scheduleTimes, (msg) => scheduleErrorMessage.textContent = msg);
        if (newTimePoints) { currentSettings.timePoints = newTimePoints; localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings)); scheduleModal.style.display = 'none'; settingsModal.style.display = 'none'; run(true); showMessageBox('New schedule has been applied!'); }
    }
    
    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        randomizeButton.addEventListener('click', () => run(true));
        copyButton.addEventListener('click', copyTableDataToClipboard);
        settingsButton.addEventListener('click', openSettingsModal);
        insertTaskButton.addEventListener('click', openInsertTaskModal);
        clearDataButton.addEventListener('click', () => {
             if (confirm("Are you sure you want to clear all data? This action cannot be undone and will remove all saved settings and schedule templates.")) {
                initializeSettings(true); run(true); showMessageBox("All data has been cleared.");
            }
        });
        
        saveSettingsButton.addEventListener('click', saveSettings);
        cancelSettingsButton.addEventListener('click', () => settingsModal.style.display = 'none');
        closeSettingsModalButton.addEventListener('click', () => settingsModal.style.display = 'none');
        resetSettingsButton.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear all data? This action cannot be undone and will remove all saved settings and schedule templates.")) {
                initializeSettings(true); settingsModal.style.display = 'none'; run(true);
                showMessageBox("All data has been cleared.");
            }
        });
        selectScheduleDropdown.addEventListener('change', () => {
            const selectedValue = selectScheduleDropdown.value;
            if (selectedValue === "-1") return;
            if (selectedValue === 'default') {
                currentSettings.timePoints = generateHardcodedDefaultTimePoints();
                run(true); showMessageBox(`Applied schedule: Default`);
            } else {
                const templates = getScheduleTemplates(), selectedTemplate = templates[parseInt(selectedValue, 10)];
                const newTimePoints = generateTimePointsFromSchedule(selectedTemplate.times, (msg) => showMessageBox(msg, true));
                if (newTimePoints) { currentSettings.timePoints = newTimePoints; run(true); showMessageBox(`Applied schedule: ${selectedTemplate.name}`); }
            }
            selectScheduleDropdown.value = "-1";
        });
        deleteScheduleButton.addEventListener('click', deleteSelectedSchedule);

        generateScheduleButton.addEventListener('click', () => { 
            scheduleErrorMessage.textContent = ''; document.getElementById('scheduleTemplateNameInput').value = '';
            ['schedTimeIn', 'schedBreak1', 'schedLunch', 'schedBreak2', 'schedTimeOut'].forEach(id => document.getElementById(id).value = '');
            scheduleModal.style.display = 'flex'; 
        });
        applyScheduleButton.addEventListener('click', handleApplySchedule);
        cancelScheduleButton.addEventListener('click', () => scheduleModal.style.display = 'none');
        saveScheduleTemplateButton.addEventListener('click', saveScheduleTemplate);
        
        document.getElementById('taskMainCatSelect').addEventListener('change', () => updateSubCategoryDropdown(document.getElementById('taskMainCatSelect'), document.getElementById('taskSubCatSelect')));
        applyTaskButton.addEventListener('click', handleApplyTask);
        cancelTaskButton.addEventListener('click', () => insertTaskModal.style.display = 'none');
        closeTaskModalButton.addEventListener('click', () => insertTaskModal.style.display = 'none');
        
        initializeSettings(); run(true);
    });

    // Minimized Insert Task functions to save space, logic is unchanged
    function openInsertTaskModal() {
        const taskSegmentSelect = document.getElementById('taskSegmentSelect'); taskSegmentSelect.innerHTML = '';
        currentDisplayedData.forEach((entry, i) => { if (entry.mainCategory !== 'BREAK') { const option = document.createElement('option'); option.value = i; option.textContent = `[${entry.date}] ${entry.start} -> ${entry.end} (${entry.mainCategory})`; taskSegmentSelect.appendChild(option); } });
        if (taskSegmentSelect.options.length === 0) { showMessageBox("No non-break segments available to insert a task into.", true); return; }
        taskErrorMessage.textContent = ''; const taskMainCatSelect = document.getElementById('taskMainCatSelect'), taskSubCatSelect = document.getElementById('taskSubCatSelect');
        taskMainCatSelect.innerHTML = Object.keys(categoryData).filter(k=>k!=="BREAK").map(k => `<option value="${k}">${k}</option>`).join('');
        updateSubCategoryDropdown(taskMainCatSelect, taskSubCatSelect); insertTaskModal.style.display = 'flex';
    }
    function handleApplyTask() {
        taskErrorMessage.textContent = '';
        const chronoIndex = (currentSettings.timePoints.length - 2) - parseInt(document.getElementById('taskSegmentSelect').value, 10);
        const durationMins = parseInt(document.getElementById('taskDurationInput').value, 10);
        if (isNaN(durationMins) || durationMins <= 0) { taskErrorMessage.textContent = 'Error: Please enter a valid number of minutes.'; return; }
        const newTaskDurationSecs = durationMins * 60, startPoint = currentSettings.timePoints[chronoIndex], endPoint = currentSettings.timePoints[chronoIndex + 1];
        let startPointSecs = timeString24hrToSeconds(startPoint.originalReferenceTime), endPointSecs = timeString24hrToSeconds(endPoint.originalReferenceTime);
        if (endPointSecs < startPointSecs) endPointSecs += 24 * 3600;
        if(newTaskDurationSecs >= (endPointSecs - startPointSecs)) { taskErrorMessage.textContent = 'Error: New task duration is longer than the selected segment.'; return; }
        const newPointTotalSecs = startPointSecs + newTaskDurationSecs, newPointTimeString = secondsToTimeString(newPointTotalSecs % (24 * 3600));
        const newTimePointObject = timeString24hrToPointObject(newPointTimeString); newTimePointObject.isInsertedTaskEndPoint = true;
        const main = document.getElementById('taskMainCatSelect').value, sub = document.getElementById('taskSubCatSelect').value;
        if (!startPoint.override) startPoint.override = {}; startPoint.override.main = main; startPoint.override.sub = sub; startPoint.override.ot = currentSettings.ot;
        currentSettings.timePoints.splice(chronoIndex + 1, 0, newTimePointObject);
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentSettings)); run(true); showMessageBox('New task inserted successfully!');
        document.getElementById('taskDurationInput').value = ''; insertTaskModal.style.display = 'none';
    }
</script>

</body>
</html>
