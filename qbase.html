<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team123 Advanced Bonus Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #tech-results-container, #admin-dashboard, #tl-summary-card {
             max-height: 0;
             overflow: hidden;
             opacity: 0;
             transition: all 0.5s ease-in-out;
        }
        #tech-results-container.visible, #admin-dashboard.visible, #tl-summary-card.visible {
            max-height: 1500px; /* Adjust as needed */
            opacity: 1;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .info-icon {
            cursor: pointer;
            display: inline-block;
            margin-left: 4px;
            color: #6b7280;
            vertical-align: middle;
        }
        .info-icon:hover {
            color: #1d4ed8;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content {
            transform: scale(1);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        textarea:read-only {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        #update-notification {
            transition: opacity 0.5s, transform 0.5s;
        }
        /* Style for multi-select */
        select[multiple] {
            height: 10rem; /* Or any other suitable height */
            background-color: white;
            padding: 0.5rem;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary::before {
            content: 'â–º';
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="update-notification" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2">
        Project list updated automatically.
    </div>

    <div class="w-full max-w-screen-xl mx-auto p-4 md:p-8">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="p-6 md:p-8 bg-gray-800 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">Team123 Advanced Bonus Calculator</h1>
                    <p class="mt-2 text-gray-300">Save, load, and calculate bonuses for multiple projects.</p>
                </div>
                 <div class="flex gap-4">
                    <button id="how-it-works-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">How It Works</button>
                    <button id="admin-login-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-300 shadow-md">Admin Login</button>
                    <button id="logout-btn" class="hidden bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-300 shadow-md">Logout</button>
                </div>
            </div>

            <div id="main-grid" class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-5 gap-8">

                <div class="lg:col-span-2 space-y-6">
                     <div class="bg-gray-50 p-6 rounded-xl border">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Project Management</h2>
                        
                         <div class="flex items-center gap-2">
                            <select id="project-select" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all duration-300">
                                <option value="">Loading Projects...</option>
                            </select>
                             <button id="delete-project-btn" title="Delete Selected Project" class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-red-300 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                             </button>
                        </div>
                        <div class="mt-4">
                            <button id="calculateCurrentBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">
                                Calculate Selected Project
                            </button>
                        </div>
                         <div class="mt-4 border-t pt-4">
                             <div class="flex items-center">
                                <input id="customize-calc-all-cb" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="customize-calc-all-cb" class="ml-3 block text-sm font-medium text-gray-700">Select specific projects to calculate</label>
                            </div>
                            <button id="calculate-all-btn" class="mt-2 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300 shadow-md">Calculate All Projects</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-xl border">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Calculation Settings</h2>
                        <div>
                            <label for="bonusMultiplierDirect" class="block text-sm font-medium text-gray-600 mb-1">
                                Bonus Multiplier (PHP)
                                <span class="info-icon" data-key="bonusMultiplier">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                </span>
                            </label>
                            <input type="number" id="bonusMultiplierDirect" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Default: 1 (No multiplier)">
                        </div>
                    </div>
                     <div id="tl-summary-card" class="bg-gray-50 p-6 rounded-xl border">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">TL Summary</h2>
                        <div id="tl-summary-content" class="space-y-2 text-sm"></div>
                    </div>
                </div>

                <div id="project-data-entry" class="lg:col-span-3 space-y-6">
                    <div>
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">Project Data Entry</h2>
                            <button id="edit-data-btn" title="Edit Project Data" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>
                            </button>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-4">
                             <div class="flex items-center mb-2">
                                <input id="is-ir-project-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="is-ir-project-checkbox" class="ml-3 block text-sm font-medium text-yellow-800">
                                    Mark Project as IR (for Fix Tasks)
                                    <span class="block text-xs text-yellow-700">Applies 1.5x points multiplier to the sum of all categories in a Fix Task row.</span>
                                </label>
                            </div>
                            <div class="flex items-center">
                                <label for="gsd-value-select" class="block text-sm font-medium text-gray-700 mr-2">GSD Point Value:</label>
                                <select id="gsd-value-select" class="w-1/2 px-3 py-1 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                                    <option value="3in">3in Value</option>
                                    <option value="4in">4in Value</option>
                                    <option value="6in">6in Value</option>
                                    <option value="9in">9in Value</option>
                                </select>
                            </div>
                        </div>

                        <label for="techData" class="block text-sm font-medium text-gray-600 mb-2">Paste your raw, tab-separated project data here.</label>
                        <textarea id="techData" rows="12" class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-sm" placeholder="Paste all rows and columns from your project data..."></textarea>
                    </div>
                    <div class="flex gap-4">
                        <input type="text" id="project-name" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter Project Name to Save/Update">
                        <button id="save-project-btn" class="bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md whitespace-nowrap">Save Project</button>
                    </div>
                    <div class="mt-4">
                        <button id="calculatePastedDataBtn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300 shadow-md">
                            Calculate Pasted Data
                        </button>
                    </div>
                </div>
            </div>

            <div id="admin-dashboard" class="px-6 md:px-8 pb-8">
                <div class="border-t pt-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Admin Dashboard</h2>
                    <p class="text-sm text-gray-600 mb-4">As an admin, you can save and delete projects directly to the central database.</p>
                    
                    <div id="team-management-section" class="mt-6 border-t pt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Team Management</h3>
                        <p class="text-sm text-gray-600 mb-4">Define teams and assign Tech IDs. Paste a comma-separated list of IDs for each team. Click "Save Team Settings" to apply changes for all users.</p>
                        <div id="team-list-container" class="space-y-4">
                            </div>
                        <div class="mt-4 flex gap-4">
                            <input type="text" id="new-team-name" placeholder="New Team Name" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <button id="add-team-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 whitespace-nowrap">Add Team</button>
                        </div>
                        <div class="mt-6">
                            <button id="save-teams-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Save Team Settings</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tech-results-container" class="px-6 md:px-8 pb-8">
                 <h2 id="results-title" class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Technician Bonus Results</h2>
                 <div class="mb-4">
                    <label for="search-tech-id" class="block text-sm font-medium text-gray-700">Search by Tech ID</label>
                    <input type="text" id="search-tech-id" class="w-full md:w-1/3 mt-1 px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Search by Tech ID...">
                    
                    <div id="team-filter-container" class="mt-3 flex flex-wrap gap-x-6 gap-y-2 items-center border-t pt-3">
                         <span class="text-sm font-medium text-gray-700">Filter by Team:</span>
                         </div>
                 </div>
                 <div id="results-summary" class="text-sm text-gray-600 bg-blue-50 p-3 rounded-md mb-4"></div>
                 <div class="table-container border rounded-lg bg-white">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="results-thead" class="bg-gray-50 sticky top-0">
                            </thead>
                        <tbody id="tech-results-body" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                 </div>
            </div>
        </div>
        <p class="text-center text-xs text-gray-500 mt-4 px-4">Disclaimer: This calculator is based on the formulas and tables in the "Phili IC Fixpoints App Documentation v1.0".</p>
    </div>

    <div id="info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <div id="modal-body" class="text-gray-600 space-y-2"></div>
            <button id="modal-close" class="mt-6 w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Close</button>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- Your Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDMG_34ybAauTtXQH1s_NaJIeYyKPHW4Po",
            authDomain: "bunos-tracker.firebaseapp.com",
            projectId: "bunos-tracker",
            storageBucket: "bunos-tracker.appspot.com",
            messagingSenderId: "317849644629",
            appId: "1:317849644629:web:46ff71930b88f7646b2edc",
            measurementId: "G-SM4QHYHTYF"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        let savedProjects = {}; 
        let currentTechStats = {}; 
        let lastUsedBonusMultiplier = 1; 
        let lastCalculationUsedMultiplier = false;
        let lastFilterValue = ""; 
        let isAdmin = false; 
        let isEditMode = false; 
        let unsubscribe; 
        let teamSettings = {};

        // --- DATA FROM DOCUMENTATION ---
        // UPDATED: Category values to include GSD-specific points
        const categoryValues = {
            1: { "3in": 2.19, "4in": 2.19, "6in": 2.19, "9in": 0.99, "IR": 1.5 },
            2: { "3in": 5.86, "4in": 5.86, "6in": 5.86, "9in": 2.07, "IR": 1.5 },
            3: { "3in": 7.44, "4in": 7.44, "6in": 7.44, "9in": 2.78, "IR": 1.5 },
            4: { "3in": 2.29, "4in": 2.29, "6in": 2.29, "9in": 1.57, "IR": 1.5 },
            5: { "3in": 1.55, "4in": 1.55, "6in": 1.55, "9in": 0.6, "IR": 1.5 },
            6: { "3in": 1.84, "4in": 1.84, "6in": 1.84, "9in": 0.78, "IR": 1.5 },
            7: { "3in": 1, "4in": 1, "6in": 1, "9in": 1, "IR": 1.5 },
            8: { "3in": 3.74, "4in": 3.74, "6in": 3.74, "9in": 3.74, "IR": 1.5 },
            9: { "3in": 1.73, "4in": 1.73, "6in": 1.73, "9in": 1.73, "IR": 1.5 }
        };

        const irModifierValue = 1.5; // This is now a general fallback/project-level IR modifier
        const calculationInfo = {
            howItWorks: {
                title: 'How It Works & How to Use',
                body: `<div class="space-y-6 text-sm">
                        <div>
                            <h4 class="text-lg font-bold text-gray-900 mb-2">How to Use This Site</h4>
                            <ol class="list-decimal list-inside space-y-2">
                                <li><strong>Automatic Loading:</strong> The project list loads automatically from the central database when the page opens.</li>
                                <li><strong>Admin Login:</strong> Click 'Admin Login' and use credentials ('admin'/'admin123') to enter Admin Mode.</li>
                                <li><strong>Admin Mode:</strong> In this mode, you can create, save, and delete projects. You can also manage team assignments in the Admin Dashboard.</li>
                                <li><strong>Filtering:</strong> Use the search bar and the team checkboxes to filter the results table.</li>
                            </ol>
                        </div>
                        <hr>
                        <div>
                            <h4 class="text-lg font-bold text-gray-900 mb-2">How The Calculation Works</h4>
                            <p>The calculation logic is based on the data from the selected project.</p>
                        </div>
                       </div>`
            },
            bonusMultiplier: { title: 'Bonus Multiplier (PHP)', body: `<p>An optional multiplier for the final payout.</p>` },
            totalPoints: { title: 'Total Points Calculation', body: `<p>Points are calculated for each individual task and then summed for each technician.</p>`},
            fixQuality: { title: 'Fix Quality % Calculation', body: `<p>Calculated using the formula: <code>[# of Fix Tasks] / ([# of Fix Tasks] + [# of Refix Tasks] + [# of Warnings])</code></p>`},
            bonusEarned: { title: '% of Bonus Earned Calculation', body: `<p>This percentage is determined by looking up the <strong>Fix Quality %</strong> in a tiered table.</p>`},
            totalBonus: { title: 'Final Payout (PHP) Calculation', body: `<p>Calculated with the formula: <code>Total Points * Bonus Multiplier * % of Bonus Earned</code></p>`}
        };

        function createNewTechStat() {
            return {
                id: '', points: 0, fixTasks: 0, refixTasks: 0, warnings: [], // warnings will store objects {type, project}
                refixDetails: [], // New: to store objects {round, project}
                categoryCounts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 },
                pointsBreakdown: { fix: 0, qc: 0, i3qa: 0, rv: 0 }
            };
        }
        
        // --- Team Settings Functions ---
        async function loadTeamSettings() {
            try {
                const teamDocRef = doc(db, "settings", "teams");
                const docSnap = await getDoc(teamDocRef);
                if (docSnap.exists()) {
                    teamSettings = docSnap.data();
                } else {
                    teamSettings = {};
                }
            } catch (error) {
                console.error("Error loading team settings:", error);
                teamSettings = {};
            }
            populateTeamFilters();
            if (isAdmin) {
                populateAdminTeamManagement();
            }
        }

        async function saveTeamSettings(settings) {
            if (!isAdmin) return;
            try {
                const teamDocRef = doc(db, "settings", "teams");
                await setDoc(teamDocRef, settings);
                alert("Team settings saved successfully.");
                teamSettings = settings; // Update global variable
                populateTeamFilters(); // Refresh filters for everyone
            } catch (error) {
                console.error("Error saving team settings: ", error);
                alert("Failed to save team settings.");
            }
        }

        // --- Firestore Functions ---
        async function saveProjectToFirestore(projectData) {
            try {
                const textEncoder = new TextEncoder();
                const dataAsUint8Array = textEncoder.encode(projectData.rawData);
                const compressed = pako.deflate(dataAsUint8Array);
                const base64String = btoa(String.fromCharCode.apply(null, compressed));
                const dataToSave = { ...projectData, rawData: base64String }; 
                const projectRef = doc(db, "public_projects", projectData.id);
                await setDoc(projectRef, dataToSave);
                return true;
            } catch (error) {
                console.error("Error saving project to Firestore: ", error);
                alert("Failed to save project. The data might be too large or invalid.");
                return false;
            }
        }

        function listenForPublicProjectChanges() {
            if (unsubscribe) unsubscribe(); 
            
            const projectsCol = collection(db, "public_projects");
            let isInitialLoad = true;
            unsubscribe = onSnapshot(projectsCol, (snapshot) => {
                const loadedProjects = {};
                snapshot.forEach((doc) => {
                    const project = doc.data();
                    let decompressedData;
                    project.isCorrupted = false; 
                    try {
                        const binaryString = atob(project.rawData);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        const decompressedUint8Array = pako.inflate(bytes);
                        const textDecoder = new TextDecoder();
                        decompressedData = textDecoder.decode(decompressedUint8Array);
                    } catch (e) {
                        console.error(`Decompression failed for project "${project.name}". Error: ${e.message}`);
                        decompressedData = "### DATA CORRUPTED ###\n\nThis project's data could not be read. An admin must re-save it with the correct data to fix this issue.";
                        project.isCorrupted = true;
                    }
                    project.rawData = decompressedData;
                    loadedProjects[doc.id] = project;
                });
                savedProjects = loadedProjects;
                updateProjectDropdown();
                if (isInitialLoad && !isAdmin) { 
                    isInitialLoad = false;
                } else if (!isInitialLoad) {
                    showUpdateNotification();
                }
                if (isAdmin) {
                    isInitialLoad = false;
                }
            }, (error) => {
                console.error("Error with real-time listener:", error);
                alert("Lost connection to the project database.");
            });
        }

        async function deleteProjectFromFirestore(projectId) {
            try {
                await deleteDoc(doc(db, "public_projects", projectId));
                return true;
            } catch (error) {
                console.error("Error deleting project from Firestore: ", error);
                alert("Failed to delete project.");
                return false;
            }
        }

        function updateProjectDropdown() {
            const projectSelect = document.getElementById('project-select');
            const currentVal = projectSelect.value;
            projectSelect.innerHTML = '<option value="">Select a Project</option>';
            const sortedProjects = Object.values(savedProjects).sort((a,b) => a.name.localeCompare(b.name));
            
            sortedProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                const displayName = project.isCorrupted ? `${project.name} (Data Corrupted)` : (project.isIR ? `${project.name} (IR)` : project.name);
                option.textContent = displayName;
                if (project.isCorrupted) {
                    option.classList.add('text-red-500', 'font-bold');
                }
                projectSelect.appendChild(option);
            });

            if (savedProjects[currentVal]) {
                projectSelect.value = currentVal;
            }
            
            manageButtonState();
        }
        
        function manageButtonState() {
            const mainGrid = document.getElementById('main-grid');
            const projectDataEntry = document.getElementById('project-data-entry');
            const projectSelect = document.getElementById('project-select');
            const projectId = projectSelect.value;
            const techData = document.getElementById('techData');
            const calculatePastedDataBtn = document.getElementById('calculatePastedDataBtn');
            const gsdValueSelect = document.getElementById('gsd-value-select');


            projectDataEntry.classList.toggle('hidden', !isAdmin);
            
            if(isAdmin) {
                mainGrid.classList.remove('lg:grid-cols-1');
                mainGrid.classList.add('lg:grid-cols-5');
            } else {
                mainGrid.classList.remove('lg:grid-cols-5');
                mainGrid.classList.add('lg:grid-cols-1');
            }

            document.getElementById('delete-project-btn').disabled = !isAdmin || !projectId;
            document.getElementById('edit-data-btn').classList.toggle('hidden', !isAdmin || !projectId);
            document.getElementById('save-project-btn').disabled = !isAdmin || (projectId && !isEditMode);
            document.getElementById('techData').readOnly = !isAdmin || (projectId && !isEditMode);
            document.getElementById('is-ir-project-checkbox').disabled = !isAdmin;
            gsdValueSelect.disabled = !isAdmin; // Disable GSD select if not admin

            // Enable/disable calculate pasted data button based on textarea content
            calculatePastedDataBtn.disabled = techData.value.trim() === '';
        }
        
        async function handleAdminLogin() {
            const user = prompt("Enter Admin Username:");
            const pass = prompt("Enter Admin Password:");
            
            if (user === "admin" && pass === "admin123") {
                isAdmin = true;
                isEditMode = false; 
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('admin-login-btn').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.add('visible');
                await loadTeamSettings();
                manageButtonState();
                alert("Admin Mode Activated. You are now editing the live database.");
            } else {
                if(user || pass) alert("Incorrect username or password.");
            }
        }

        function handleLogout() {
            isAdmin = false;
            isEditMode = false; 
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('admin-login-btn').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.remove('visible');
            manageButtonState();
            alert("You have been logged out.");
        }

        function showUpdateNotification() {
            const notification = document.getElementById('update-notification');
            if (notification.classList.contains('hidden')) {
                notification.classList.remove('hidden');
                setTimeout(() => {
                    notification.classList.remove('opacity-0', 'translate-y-2');
                }, 10);
                setTimeout(() => {
                    notification.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => notification.classList.add('hidden'), 500);
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            listenForPublicProjectChanges();
            loadTeamSettings();
            manageButtonState();

            // Admin Team Management Listeners
            document.getElementById('add-team-btn').addEventListener('click', () => {
                if (!isAdmin) return;
                const newTeamNameInput = document.getElementById('new-team-name');
                const newTeamName = newTeamNameInput.value.trim();
                if (newTeamName && !document.querySelector(`.team-definition[data-team-name="${newTeamName}"]`)) {
                    addTeamToAdminUI(newTeamName);
                    newTeamNameInput.value = '';
                } else if (!newTeamName) {
                    alert('Please enter a team name.');
                } else {
                    alert('A team with this name already exists in the editor.');
                }
            });

            document.getElementById('save-teams-btn').addEventListener('click', () => {
                if (!isAdmin) return;
                const newTeamSettings = {};
                const teamDivs = document.querySelectorAll('#team-list-container .team-definition');
                
                teamDivs.forEach(div => {
                    const teamName = div.dataset.teamName;
                    const textArea = div.querySelector('textarea');
                    const techIds = textArea.value.split(',')
                                            .map(id => id.trim())
                                            .filter(id => id); // Remove empty strings
                    newTeamSettings[teamName] = techIds;
                });
                
                saveTeamSettings(newTeamSettings);
            });

            document.getElementById('save-project-btn').addEventListener('click', async () => {
                if (!isAdmin) {
                    alert("Only admins can save projects.");
                    return;
                }
                const projectName = document.getElementById('project-name').value.trim();
                const rawData = document.getElementById('techData').value.trim();
                const isIR = document.getElementById('is-ir-project-checkbox').checked;
                const gsdValue = document.getElementById('gsd-value-select').value; // Get selected GSD value

                if (projectName.length > 50) {
                    alert("Project name cannot exceed 50 characters.");
                    return;
                }

                if (!projectName || !rawData) {
                    alert("Please enter a project name and paste project data before saving/updating.");
                    return;
                }
                
                let projectId = document.getElementById('project-select').value;
                if (!projectId || savedProjects[projectId]?.isCorrupted) {
                    projectId = Date.now().toString();
                }
                
                const projectData = {
                    id: projectId,
                    name: projectName,
                    rawData: rawData,
                    isIR: isIR,
                    gsdValue: gsdValue, // Save selected GSD value
                    createdAt: savedProjects[projectId]?.createdAt || new Date().toISOString()
                };

                const success = await saveProjectToFirestore(projectData);
                if(success) {
                    alert(`Project "${projectName}" saved successfully to Firestore.`);
                    isEditMode = false; 
                    manageButtonState();
                }
            });
            
            document.getElementById('delete-project-btn').addEventListener('click', async () => {
                 if (!isAdmin) return;
                const projectId = document.getElementById('project-select').value;
                if (!projectId) { return; }
                
                const projectName = savedProjects[projectId].name;
                if (confirm(`Are you sure you want to delete the project "${projectName}"? This action cannot be undone.`)) {
                    const success = await deleteProjectFromFirestore(projectId);
                    if (success) {
                        alert(`Project "${projectName}" has been deleted.`);
                    }
                }
            });

            document.getElementById('project-select').addEventListener('change', (e) => {
                const projectSelect = e.target;
                if (projectSelect.multiple) {
                    // In multi-select mode, don't load the project data on click
                    return;
                }
                const projectId = projectSelect.value;
                const irCheckbox = document.getElementById('is-ir-project-checkbox');
                const gsdValueSelect = document.getElementById('gsd-value-select');
                
                isEditMode = false; 

                if (projectId && savedProjects[projectId]) {
                    const project = savedProjects[projectId];
                    document.getElementById('techData').value = project.rawData;
                    document.getElementById('project-name').value = project.name;
                    irCheckbox.checked = project.isIR || false;
                    gsdValueSelect.value = project.gsdValue || '3in'; // Load saved GSD value, default to '3in'
                } else {
                    document.getElementById('techData').value = '';
                    document.getElementById('project-name').value = '';
                    irCheckbox.checked = false;
                    gsdValueSelect.value = '3in'; // Reset GSD value
                    lastFilterValue = "";
                }
                manageButtonState();
            });
            
            document.getElementById('edit-data-btn').addEventListener('click', () => {
                 if (!isAdmin) return;
                 isEditMode = true;
                 manageButtonState();
                 document.getElementById('techData').focus();
            });
            
            document.getElementById('calculateCurrentBtn').addEventListener('click', () => calculateAndRender(false));
            
            document.getElementById('calculate-all-btn').addEventListener('click', () => {
                const isCustomized = document.getElementById('customize-calc-all-cb').checked;
                if (isCustomized) {
                    const selectedProjectIds = [...document.getElementById('project-select').selectedOptions].map(opt => opt.value).filter(Boolean);
                    if (selectedProjectIds.length === 0) {
                        alert('Please select one or more projects from the list to calculate.');
                        return;
                    }
                    calculateAndRender(true, selectedProjectIds);
                } else {
                    calculateAndRender(true, null);
                }
            });

            document.getElementById('customize-calc-all-cb').addEventListener('change', (e) => {
                const projectSelect = document.getElementById('project-select');
                const calcCurrentBtn = document.getElementById('calculateCurrentBtn');
                const calcAllBtn = document.getElementById('calculate-all-btn');

                if (e.target.checked) {
                    projectSelect.multiple = true;
                    projectSelect.size = 8; // Show 8 items
                    calcCurrentBtn.disabled = true;
                    calcAllBtn.textContent = 'Calculate Checked Projects';
                } else {
                    projectSelect.multiple = false;
                    projectSelect.size = 1;
                    calcCurrentBtn.disabled = false;
                    calcAllBtn.textContent = 'Calculate All Projects';
                }
            });

            // Event listener for the new "Calculate Pasted Data" button
            document.getElementById('calculatePastedDataBtn').addEventListener('click', calculatePastedData);
            
            // Event listener for techData input to manage button state
            document.getElementById('techData').addEventListener('input', manageButtonState);


            document.getElementById('search-tech-id').addEventListener('input', (e) => {
                lastFilterValue = e.target.value;
                filterTable();
            });
            
            document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.info-icon')) {
                    const icon = e.target.closest('.info-icon');
                    const key = icon.dataset.key;
                    const techId = icon.dataset.techId;
                    if (key) {
                        openModal(key);
                    } else if (techId) {
                        openTechSummaryModal(techId);
                    }
                }
            });

            document.getElementById('how-it-works-btn').addEventListener('click', () => openModal('howItWorks'));
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('info-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('info-modal')) {
                    closeModal();
                }
            });
        });

        function calculateAndRender(isAllProjects, projectIds = null) {
            let bonusMultiplier = 1;
            let isMultiplierUsed = false;
            const directMultiplierInput = document.getElementById('bonusMultiplierDirect').value;

            if (directMultiplierInput.trim() !== '') {
                const parsedMultiplier = parseFloat(directMultiplierInput);
                if (!isNaN(parsedMultiplier) && parsedMultiplier >= 0) {
                    bonusMultiplier = parsedMultiplier;
                    isMultiplierUsed = true;
                } else {
                    alert("Bonus Multiplier must be a valid number.");
                    return;
                }
            }
            
            lastUsedBonusMultiplier = bonusMultiplier;
            lastCalculationUsedMultiplier = isMultiplierUsed;

            const resultsTitleEl = document.getElementById('results-title');
            
            if (isAllProjects) {
                const projectsToCalculate = projectIds ? projectIds : Object.keys(savedProjects);
                const titleText = projectIds ? 'Checked Projects (Combined)' : 'All Projects (Combined)';
                resultsTitleEl.textContent = `${titleText} - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : '(No Multiplier)'}`;
                
                let combinedTechStats = {};
                let combinedSummaryStats = { 
                    rv1CatCounts: {}, rv2CatCounts: {}, rv3CatCounts: {}, rv4CatCounts: {}, 
                    totalRows: 0, comboTasks: 0 
                };
                const corruptedProjects = []; 
                
                for (const projectId of projectsToCalculate) {
                    const project = savedProjects[projectId];
                    if (!project) continue;
                    
                    if (project.isCorrupted) {
                        corruptedProjects.push(project.name);
                        continue;
                    }
                    // Pass the GSD value from the saved project, default to '3in' if not present
                    const gsdForCalculation = project.gsdValue || '3in'; 
                    const parsedData = parseRawData(project.rawData, project.isIR || false, project.name, gsdForCalculation); 
                    if (parsedData) {
                        // Merge Tech Stats
                        for (const techId in parsedData.techStats) {
                            const singleProjectTechStats = parsedData.techStats[techId];
                            if (!combinedTechStats[techId]) {
                                combinedTechStats[techId] = createNewTechStat();
                                combinedTechStats[techId].id = techId;
                            }
                            combinedTechStats[techId].points += singleProjectTechStats.points;
                            combinedTechStats[techId].fixTasks += singleProjectTechStats.fixTasks;
                            combinedTechStats[techId].refixTasks += singleProjectTechStats.refixTasks;
                            combinedTechStats[techId].warnings.push(...singleProjectTechStats.warnings);
                            combinedTechStats[techId].refixDetails.push(...singleProjectTechStats.refixDetails); // New: merge refix details
                            for (let i = 1; i <= 9; i++) {
                                combinedTechStats[techId].categoryCounts[i] += singleProjectTechStats.categoryCounts[i];
                            }
                            combinedTechStats[techId].pointsBreakdown.fix += singleProjectTechStats.pointsBreakdown.fix;
                            combinedTechStats[techId].pointsBreakdown.qc += singleProjectTechStats.pointsBreakdown.qc;
                            combinedTechStats[techId].pointsBreakdown.i3qa += singleProjectTechStats.pointsBreakdown.i3qa;
                            combinedTechStats[techId].pointsBreakdown.rv += singleProjectTechStats.pointsBreakdown.rv;
                        }
                        
                        // Merge Summary Stats
                        combinedSummaryStats.totalRows += parsedData.summaryStats.totalRows;
                        combinedSummaryStats.comboTasks += parsedData.summaryStats.comboTasks;
                        for (const cat in parsedData.summaryStats.rv1CatCounts) {
                            combinedSummaryStats.rv1CatCounts[cat] = (combinedSummaryStats.rv1CatCounts[cat] || 0) + parsedData.summaryStats.rv1CatCounts[cat];
                        }
                        for (const cat in parsedData.summaryStats.rv2CatCounts) {
                            combinedSummaryStats.rv2CatCounts[cat] = (combinedSummaryStats.rv2CatCounts[cat] || 0) + parsedData.summaryStats.rv2CatCounts[cat];
                        }
                        for (const cat in parsedData.summaryStats.rv3CatCounts) {
                            const projectCatData = parsedData.summaryStats.rv3CatCounts[cat];
                            if (!combinedSummaryStats.rv3CatCounts[cat]) {
                                combinedSummaryStats.rv3CatCounts[cat] = { total: 0, techs: {} };
                            }
                            const combinedCatData = combinedSummaryStats.rv3CatCounts[cat];
                            combinedCatData.total += projectCatData.total;
                            for (const techId in projectCatData.techs) {
                                combinedCatData.techs[techId] = (combinedCatData.techs[techId] || 0) + projectCatData.techs[techId];
                            }
                        }
                        for (const cat in parsedData.summaryStats.rv4CatCounts) {
                            combinedSummaryStats.rv4CatCounts[cat] = (combinedSummaryStats.rv4CatCounts[cat] || 0) + parsedData.summaryStats.rv4CatCounts[cat];
                        }
                    }
                }

                if (corruptedProjects.length > 0) {
                    alert(`The following projects have corrupted data and were skipped:\n- ${corruptedProjects.join('\n- ')}\n\nAn admin must re-save these projects to include them in calculations.`);
                }

                currentTechStats = combinedTechStats; 
                renderSingleProjectTable(currentTechStats, bonusMultiplier);
                renderTlSummary(combinedSummaryStats);
            } else {
                const projectId = document.getElementById('project-select').value;
                if (!projectId) {
                    alert("Please select a project to calculate.");
                    return;
                }
                if (savedProjects[projectId] && savedProjects[projectId].isCorrupted) {
                    alert(`Cannot calculate. The selected project "${savedProjects[projectId].name}" has corrupted data and cannot be read.\n\nAn admin must re-save this project with the correct data to fix it.`);
                    return; 
                }

                resultsTitleEl.textContent = `Project: ${savedProjects[projectId].name} - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : ''}`;
                const data = savedProjects[projectId].rawData;
                if (!data) {
                    alert("Selected project has no data.");
                    return;
                }
                const isProjectLevelIR = savedProjects[projectId].isIR;
                const gsdForCalculation = savedProjects[projectId].gsdValue || '3in'; // Get GSD from saved project or default
                const parsedData = parseRawData(data, isProjectLevelIR, savedProjects[projectId].name, gsdForCalculation);
                if (parsedData) {
                    currentTechStats = parsedData.techStats;
                    renderSingleProjectTable(currentTechStats, bonusMultiplier);
                    renderTlSummary(parsedData.summaryStats);
                }
            }
            document.getElementById('tech-results-container').classList.add('visible');
            document.getElementById('tl-summary-card').classList.add('visible');
        }
        
        function calculatePastedData() {
            let bonusMultiplier = 1;
            let isMultiplierUsed = false;
            const directMultiplierInput = document.getElementById('bonusMultiplierDirect').value;

            if (directMultiplierInput.trim() !== '') {
                const parsedMultiplier = parseFloat(directMultiplierInput);
                if (!isNaN(parsedMultiplier) && parsedMultiplier >= 0) {
                    bonusMultiplier = parsedMultiplier;
                    isMultiplierUsed = true;
                } else {
                    alert("Bonus Multiplier must be a valid number.");
                    return;
                }
            }
            
            lastUsedBonusMultiplier = bonusMultiplier;
            lastCalculationUsedMultiplier = isMultiplierUsed;

            const resultsTitleEl = document.getElementById('results-title');
            const data = document.getElementById('techData').value.trim();
            const isProjectLevelIR = document.getElementById('is-ir-project-checkbox').checked;
            const gsdForCalculation = document.getElementById('gsd-value-select').value; // Get selected GSD for pasted data

            if (!data) {
                alert("Please paste data into the 'Project Data Entry' text area before calculating.");
                return;
            }

            resultsTitleEl.textContent = `Pasted Data - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : ''}`;
            
            const parsedData = parseRawData(data, isProjectLevelIR, 'Pasted Data', gsdForCalculation);
            if (parsedData) {
                currentTechStats = parsedData.techStats;
                renderSingleProjectTable(currentTechStats, bonusMultiplier);
                renderTlSummary(parsedData.summaryStats);
            }
            document.getElementById('tech-results-container').classList.add('visible');
            document.getElementById('tl-summary-card').classList.add('visible');
        }


        function renderSingleProjectTable(techStats, bonusMultiplier) {
            const resultsThead = document.getElementById('results-thead');
            const resultsBody = document.getElementById('tech-results-body');
            resultsBody.innerHTML = '';
            const infoIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>`;
            resultsThead.innerHTML = `
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tech ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Points <span class="info-icon" data-key="totalPoints">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fix Quality % <span class="info-icon" data-key="fixQuality">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% of Bonus Earned <span class="info-icon" data-key="bonusEarned">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Final Payout (PHP) <span class="info-icon" data-key="totalBonus">${infoIconSvg}</span></th>
                </tr>
            `;

            for (const techId in techStats) {
                const tech = techStats[techId];
                const row = createTableRow(tech, bonusMultiplier);
                row.dataset.techId = techId;
                resultsBody.appendChild(row);
            }

            filterTable();
        }
        
        function calculateQualityModifier(qualityRate) {
            if (qualityRate >= 100) return 1.0;
            if (qualityRate >= 82.5) return 0.55;
            if (qualityRate >= 82) return 0.50;
            if (qualityRate >= 81.5) return 0.45;
            if (qualityRate >= 81) return 0.40;
            if (qualityRate >= 80.5) return 0.35;
            if (qualityRate >= 80) return 0.30;
            if (qualityRate >= 79.5) return 0.25;
            if (qualityRate >= 79) return 0.20;
            if (qualityRate >= 78.5) return 0.15;
            if (qualityRate >= 78) return 0.10;
            if (qualityRate >= 77.5) return 0.05;
            return 0;
        }
        
        function createTableRow(tech, bonusMultiplier) {
            const denominator = tech.fixTasks + tech.refixTasks + tech.warnings.length;
            const fixQuality = denominator > 0 ? (tech.fixTasks / denominator) : 0;
            const qualityModifier = calculateQualityModifier(fixQuality * 100);
            const finalPayout = tech.points * bonusMultiplier * qualityModifier;
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${tech.id}
                    <span class="info-icon tech-summary-icon" data-tech-id="${tech.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tech.points.toFixed(3)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(fixQuality * 100).toFixed(2)}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(qualityModifier * 100).toFixed(0)}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">${finalPayout.toFixed(2)}</td>
            `;
            
            return row;
        }

        function parseRawData(data, isFixTaskIR = false, currentProjectName = "Pasted Data", gsdForCalculation = "3in") {
            const techStats = {};
            const lines = data.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 1) { 
                 return null;
            }

            const headerLine = lines.shift();
            const delimiter = '\t';
            const headers = headerLine.split(delimiter).map(h => h.trim().toLowerCase());
            
            const headerMap = {};
            headers.forEach((h, i) => { headerMap[h] = i; });

            if (headerMap['combo?'] === undefined) {
                 alert("Critical column 'COMBO?' is missing from the data header. Please ensure it is included.");
                 return null;
            }
            
            const summaryStats = {
                rv1CatCounts: {}, rv2CatCounts: {}, rv3CatCounts: {}, rv4CatCounts: {},
                totalRows: lines.length,
                comboTasks: 0
            };
            const rv1CatIndex = headerMap['rv1_cat'];
            const rv2CatIndex = headerMap['rv2_cat'];
            const rv3CatIndex = headerMap['rv3_cat'];
            const rv3TechSourceIndex = headerMap['fix4_id']; // UPDATED LOGIC: Use fix4_id as the source for the tech ID
            const rv4CatIndex = headerMap['rv4_cat'];
            const comboIndex = headerMap['combo?'];

            const baseCategoryHeaders = ['category', 'rv1_cat', 'rv2_cat'];
            const techIdCols = headers.filter(h => h.endsWith('_id'));
            const warnCols = headers.filter(h => h.startsWith('r') && h.endsWith('_warn'));
            
            const afp1StatIndex = headerMap['afp1_stat'];
            const afp1CatIndex = headerMap['afp1_cat'];
            const afp2StatIndex = headerMap['afp2_stat'];
            const afp2CatIndex = headerMap['afp2_cat'];

            lines.forEach(line => {
                const values = line.split(delimiter);
                const isComboIR = values[headerMap['combo?']] === 'Y';
                
                if (comboIndex !== undefined && values[comboIndex]?.trim().toUpperCase() === 'Y') {
                    summaryStats.comboTasks++;
                }

                const processSimpleRvCat = (index, countsObject) => {
                    if (index !== undefined) {
                        const catValue = values[index]?.trim();
                        if (catValue && !isNaN(catValue) && catValue >= 1 && catValue <= 9) {
                            countsObject[catValue] = (countsObject[catValue] || 0) + 1;
                        }
                    }
                };

                processSimpleRvCat(rv1CatIndex, summaryStats.rv1CatCounts);
                processSimpleRvCat(rv2CatIndex, summaryStats.rv2CatCounts);
                processSimpleRvCat(rv4CatIndex, summaryStats.rv4CatCounts);
                
                // UPDATED LOGIC
                if (rv3CatIndex !== undefined && rv3TechSourceIndex !== undefined) {
                    const catValue = values[rv3CatIndex]?.trim();
                    const techId = values[rv3TechSourceIndex]?.trim(); // Get tech ID from fix4_id column
                    if (catValue && techId && !isNaN(catValue) && catValue >= 1 && catValue <= 9) {
                        if (!summaryStats.rv3CatCounts[catValue]) {
                            summaryStats.rv3CatCounts[catValue] = { total: 0, techs: {} };
                        }
                        summaryStats.rv3CatCounts[catValue].total++;
                        const techCounts = summaryStats.rv3CatCounts[catValue].techs;
                        techCounts[techId] = (techCounts[techId] || 0) + 1;
                    }
                }


                techIdCols.forEach(colName => {
                    const techId = values[headerMap[colName]]?.trim();
                    if (techId) {
                        if (!techStats[techId]) {
                            techStats[techId] = createNewTechStat();
                            techStats[techId].id = techId;
                        }
                        
                        let points = 0;
                        if (colName.startsWith('fix')) {
                            const isRefix = colName !== 'fix1_id';
                            if (isRefix) {
                                const roundMatch = colName.match(/\d+/);
                                if (roundMatch) {
                                    const round = roundMatch[0];
                                    const rvLabelColName = `rv${round}_label`;
                                    const rvLabelIndex = headerMap[rvLabelColName];
                                    
                                    if (rvLabelIndex !== undefined) {
                                        const rvLabelValue = values[rvLabelIndex]?.trim().toUpperCase();
                                        if (rvLabelValue && rvLabelValue.includes('I')) {
                                            techStats[techId].refixTasks += 1; // Keep count for original summary
                                            techStats[techId].refixDetails.push({ // Store detailed info
                                                round: `RV${round}`,
                                                project: currentProjectName
                                            });
                                        }
                                    }
                                }
                            } else { // This is the 'fix1_id' section
                                techStats[techId].fixTasks += 1;
                                let totalRowFixPoints = 0;
                                
                                const i3qaCatIndex = headerMap['i3qa_cat'];
                                const i3qaLabelIndex = headerMap['i3qa_label'];
                                if (i3qaCatIndex !== undefined && i3qaLabelIndex !== undefined) {
                                    const i3qaLabelValue = values[i3qaLabelIndex]?.trim().toUpperCase();
                                    if (i3qaLabelValue && i3qaLabelValue.includes('M')) {
                                        const categoryValue = parseInt(values[i3qaCatIndex]);
                                        if (!isNaN(categoryValue) && categoryValue >= 1 && categoryValue <= 9) {
                                            // Use the GSD-specific point value if available, fallback to "3in" if the selected GSD value is not found for the category
                                            const catPoints = categoryValues[categoryValue] ? (categoryValues[categoryValue][gsdForCalculation] || categoryValues[categoryValue]["3in"]) : 0;
                                            if (techStats[techId].categoryCounts[categoryValue] !== undefined) {
                                                techStats[techId].categoryCounts[categoryValue]++;
                                            }
                                            if (catPoints) { totalRowFixPoints += catPoints; }
                                        }
                                    }
                                }
                                
                                baseCategoryHeaders.forEach(catHeader => {
                                    if (headerMap[catHeader] !== undefined) {
                                        const categoryValue = parseInt(values[headerMap[catHeader]]);
                                        if (!isNaN(categoryValue) && categoryValue >= 1 && categoryValue <= 9) {
                                            // Use the GSD-specific point value if available
                                            const catPoints = categoryValues[categoryValue] ? (categoryValues[categoryValue][gsdForCalculation] || categoryValues[categoryValue]["3in"]) : 0;
                                            if (techStats[techId].categoryCounts[categoryValue] !== undefined) {
                                                techStats[techId].categoryCounts[categoryValue]++;
                                            }
                                            if (catPoints) { totalRowFixPoints += catPoints; }
                                        }
                                    }
                                });

                                if (afp1StatIndex !== undefined && afp1CatIndex !== undefined && values[afp1StatIndex]?.trim().toUpperCase() === 'AA') {
                                    const afp1CatValue = parseInt(values[afp1CatIndex]);
                                    if (!isNaN(afp1CatValue) && afp1CatValue >= 1 && afp1CatValue <= 9) {
                                        const catPoints = categoryValues[afp1CatValue] ? (categoryValues[afp1CatValue][gsdForCalculation] || categoryValues[afp1CatValue]["3in"]) : 0;
                                        if (techStats[techId].categoryCounts[afp1CatValue] !== undefined) {
                                            techStats[techId].categoryCounts[afp1CatValue]++;
                                        }
                                        if (catPoints) { totalRowFixPoints += catPoints; }
                                    }
                                }
                                
                                if (afp2StatIndex !== undefined && afp2CatIndex !== undefined && values[afp2StatIndex]?.trim().toUpperCase() === 'AA') {
                                    const afp2CatValue = parseInt(values[afp2CatIndex]);
                                     if (!isNaN(afp2CatValue) && afp2CatValue >= 1 && afp2CatValue <= 9) {
                                        const catPoints = categoryValues[afp2CatValue] ? (categoryValues[afp2CatValue][gsdForCalculation] || categoryValues[afp2CatValue]["3in"]) : 0;
                                        if (techStats[techId].categoryCounts[afp2CatValue] !== undefined) {
                                            techStats[techId].categoryCounts[afp2CatValue]++;
                                        }
                                        if (catPoints) { totalRowFixPoints += catPoints; }
                                    }
                                }

                                if (isFixTaskIR && totalRowFixPoints > 0) {
                                    totalRowFixPoints *= irModifierValue; // This is the project-level IR multiplier
                                }

                                techStats[techId].pointsBreakdown.fix += totalRowFixPoints;
                                points += totalRowFixPoints;
                            }
                        } else if (colName.startsWith('qc')) {
                            points = 1 / 8;
                            techStats[techId].pointsBreakdown.qc += points;
                        } else if (colName.startsWith('i3qa')) {
                            points = 1 / 12;
                            techStats[techId].pointsBreakdown.i3qa += points;
                        } else if (colName.startsWith('rv')) {
                            if (colName === 'rv1_id') points = isComboIR ? (1/4) : (1/5);
                            else if (colName === 'rv2_id') points = 1/2;
                            techStats[techId].pointsBreakdown.rv += points;
                        }
                        
                        techStats[techId].points += points;
                    }
                });

                const validWarningLetters = ['B', 'C', 'D', 'E', 'F', 'G', 'I'];
                warnCols.forEach(colName => {
                    const warnValue = values[headerMap[colName]]?.trim().toUpperCase();
                    if (warnValue && validWarningLetters.includes(warnValue)) {
                        const round = colName.match(/\d+/)[0];
                        const fixTechId = values[headerMap[`fix${round}_id`]]?.trim();
                        if (fixTechId && techStats[fixTechId]) {
                            // Store warning as an object with type and project name
                            techStats[fixTechId].warnings.push({
                                type: warnValue,
                                project: currentProjectName
                            });
                        }
                    }
                });
            });
            return { techStats, summaryStats };
        }
        
        function renderTlSummary(stats) {
            const card = document.getElementById('tl-summary-card');
            const content = document.getElementById('tl-summary-content');

            if (!stats) {
                card.classList.remove('visible');
                return;
            }

            const createSimpleCategoryHtml = (title, counts) => {
                let html = `<details class="text-sm" open><summary class="cursor-pointer font-medium text-gray-700 mt-3">${title}</summary>`;
                const sortedCats = Object.keys(counts).sort((a, b) => a - b);

                if (sortedCats.length > 0) {
                    html += '<div class="mt-1 border rounded-md divide-y divide-gray-200">';
                    sortedCats.forEach((cat, index) => {
                        const bgColor = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                        html += `<div class="p-2 flex justify-between items-center ${bgColor}">
                                    <span class="text-gray-800">Category ${cat}:</span>
                                    <span class="font-mono font-medium text-gray-900">${counts[cat]}</span>
                                 </div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p class="text-gray-500 text-xs italic mt-1 pl-4">No entries found.</p>';
                }
                html += '</details>';
                return html;
            };
            
            const createRv3CategoryHtml = (title, counts) => {
                let html = `<details class="text-sm" open><summary class="cursor-pointer font-medium text-gray-700 mt-3">${title}</summary>`;
                const sortedCats = Object.keys(counts).sort((a, b) => a - b);

                if (sortedCats.length > 0) {
                    html += '<div class="mt-1 border rounded-md divide-y divide-gray-200">';
                    sortedCats.forEach((cat, index) => {
                        const catData = counts[cat];
                        const bgColor = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';

                        const techEntries = Object.entries(catData.techs).sort((a,b) => a[0].localeCompare(b[0])).map(([techId, count]) =>
                            `<li class="text-xs flex justify-between"><span>- ${techId}</span><span class="font-mono">${count}</span></li>`
                        ).join('');

                        html += `
                            <details class="text-sm ${bgColor}" open>
                                <summary class="p-2 cursor-pointer flex justify-between items-center">
                                    <span class="text-gray-800">Category ${cat}:</span>
                                    <span class="font-mono font-medium text-gray-900">${catData.total}</span>
                                </summary>
                                <div class="p-2 border-t border-gray-200">
                                    <ul class="pl-4 text-gray-600 space-y-1">${techEntries}</ul>
                                </div>
                            </details>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += '<p class="text-gray-500 text-xs italic mt-1 pl-4">No entries found.</p>';
                }
                html += '</details>';
                return html;
            };

            const rv1Html = createSimpleCategoryHtml('RV1_CAT Counts', stats.rv1CatCounts);
            const rv2Html = createSimpleCategoryHtml('RV2_CAT Counts', stats.rv2CatCounts);
            const rv3Html = createRv3CategoryHtml('RV3_CAT Counts', stats.rv3CatCounts);
            const rv4Html = createSimpleCategoryHtml('RV4_CAT Counts', stats.rv4CatCounts);

            content.innerHTML = `
                <div class="flex justify-between"><span class="text-gray-600">Total Data Rows Parsed:</span><span class="font-bold">${stats.totalRows}</span></div>
                <div class="flex justify-between"><span class="text-gray-600">"Combo?" (Y) Tasks:</span><span class="font-bold">${stats.comboTasks}</span></div>
                <hr class="my-2">
                ${rv1Html}
                ${rv2Html}
                ${rv3Html}
                ${rv4Html}
            `;
            card.classList.add('visible');
        }

        // --- UI and Filtering Functions ---

        function populateTeamFilters() {
            const container = document.getElementById('team-filter-container');
            // Clear all but the first element (the label)
            while(container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            const sortedTeams = Object.keys(teamSettings).sort((a,b) => a.localeCompare(b));

            sortedTeams.forEach(teamName => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input id="team-filter-${teamName}" data-team-name="${teamName}" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="team-filter-${teamName}" class="ml-2 block text-sm text-gray-900">${teamName}</label>
                `;
                container.appendChild(div);
                div.querySelector('input').addEventListener('change', filterTable);
            });
        }
        
        function addTeamToAdminUI(teamName, teamIds = []) {
            const container = document.getElementById('team-list-container');
            const teamDiv = document.createElement('div');
            teamDiv.className = 'p-4 border rounded-lg bg-white team-definition';
            teamDiv.dataset.teamName = teamName;
            teamDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <label class="font-semibold text-gray-700">${teamName}</label>
                    <button data-team-name="${teamName}" class="delete-team-btn font-bold text-red-500 hover:text-red-700 text-xl leading-none">&times;</button>
                </div>
                <textarea class="w-full p-2 border rounded-md font-mono text-sm" rows="3" placeholder="tech1, tech2, tech3">${teamIds.join(', ')}</textarea>
            `;
            container.appendChild(teamDiv);
            teamDiv.querySelector('.delete-team-btn').addEventListener('click', (e) => {
                if (confirm(`Are you sure you want to remove team "${teamName}" from the editor? This will be finalized when you save.`)) {
                    e.target.closest('.team-definition').remove();
                }
            });
        }

        function populateAdminTeamManagement() {
            const container = document.getElementById('team-list-container');
            container.innerHTML = '';
            
            const sortedTeams = Object.keys(teamSettings).sort((a, b) => a.localeCompare(b));

            sortedTeams.forEach(teamName => {
                addTeamToAdminUI(teamName, teamSettings[teamName]);
            });
        }


        function filterTable() {
            const searchTerm = document.getElementById('search-tech-id').value.toUpperCase();
            
            const selectedTeams = [];
            document.querySelectorAll('#team-filter-container input:checked').forEach(cb => {
                selectedTeams.push(cb.dataset.teamName);
            });

            let allowedTechIds = new Set();
            if (selectedTeams.length > 0) {
                selectedTeams.forEach(teamName => {
                    if (teamSettings[teamName]) {
                        teamSettings[teamName].forEach(techId => allowedTechIds.add(techId.toUpperCase()));
                    }
                });
            }

            const rows = document.getElementById('tech-results-body').getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const techIdCell = rows[i].getElementsByTagName('td')[0];
                if (techIdCell) {
                    const techId = (techIdCell.textContent || techIdCell.innerText).trim().toUpperCase();
                    
                    const matchesSearch = searchTerm === "" || techId.includes(searchTerm);
                    const matchesTeam = selectedTeams.length === 0 || allowedTechIds.has(techId);

                    rows[i].style.display = (matchesSearch && matchesTeam) ? "" : "none";
                }
            }
        }

        function openModal(key) {
            const modal = document.getElementById('info-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const info = calculationInfo[key];
            if (info) {
                modalTitle.innerHTML = info.title;
                modalBody.innerHTML = info.body;
                modal.classList.remove('hidden');
            }
        }
        
        function openTechSummaryModal(techId) {
            const tech = currentTechStats[techId];
            if (!tech) return;

            const modal = document.getElementById('info-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            const warningsCount = tech.warnings.length;
            const denominator = tech.fixTasks + tech.refixTasks + warningsCount;
            const fixQuality = denominator > 0 ? (tech.fixTasks / denominator) : 0;
            const qualityModifier = calculateQualityModifier(fixQuality * 100);
            const finalPayout = tech.points * lastUsedBonusMultiplier * qualityModifier;

            modalTitle.innerHTML = `Detailed Breakdown for Tech ID: <span class="text-blue-600">${techId}</span>`;
            
            let categoryHtml = '';
            for (let i = 1; i <= 9; i++) {
                if (tech.categoryCounts[i] > 0) {
                     categoryHtml += `<li class="flex justify-between"><span>Category ${i}:</span> <span class="font-mono">${tech.categoryCounts[i]}</span></li>`;
                }
            }
            if (!categoryHtml) categoryHtml = '<li>No primary fix tasks recorded.</li>';

            let multiplierDisplay = lastCalculationUsedMultiplier
                ? `${lastUsedBonusMultiplier.toFixed(2)} (Multiplier)`
                : '1 (No Multiplier Applied)';

            let warningsDetailHtml = '';
            if (tech.warnings.length > 0) {
                warningsDetailHtml = `<ul class="list-disc list-inside text-xs text-gray-700 mt-1 space-y-0.5">`;
                tech.warnings.forEach(w => {
                    warningsDetailHtml += `<li>Type: <span class="font-mono font-semibold">${w.type}</span> (Project: ${w.project})</li>`;
                });
                warningsDetailHtml += `</ul>`;
            } else {
                warningsDetailHtml = `<p class="text-xs text-gray-500 italic mt-1 pl-4">No warnings recorded.</p>`;
            }

            let refixDetailHtml = '';
            if (tech.refixDetails.length > 0) {
                refixDetailHtml = `<ul class="list-disc list-inside text-xs text-gray-700 mt-1 space-y-0.5">`;
                tech.refixDetails.forEach(r => {
                    refixDetailHtml += `<li>Task: <span class="font-mono font-semibold">${r.round}</span> (Project: ${r.project})</li>`;
                });
                refixDetailHtml += `</ul>`;
            } else {
                refixDetailHtml = `<p class="text-xs text-gray-500 italic mt-1 pl-4">No refixes recorded.</p>`;
            }

            let bodyHtml = `<div class="space-y-4 text-sm">
                
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-base text-gray-800 mb-2">Core Stats</h4>
                    <div class="flex justify-between"><span class="text-gray-600">Primary Fix Tasks:</span><span class="font-bold">${tech.fixTasks}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Refix Tasks:</span><span class="font-bold">${tech.refixTasks}</span></div>
                    ${refixDetailHtml}
                    <div class="flex justify-between mt-2"><span class="text-gray-600">Warnings:</span><span class="font-bold text-red-600">${tech.warnings.length}</span></div>
                    ${warningsDetailHtml}
                    <details class="mt-2 text-xs">
                        <summary class="cursor-pointer font-medium text-gray-500">Show Category Counts</summary>
                        <ul class="list-disc list-inside mt-1 space-y-1 pl-2">${categoryHtml}</ul>
                    </details>
                </div>
                
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-base text-gray-800 mb-2">Points Calculation</h4>
                    <div class="flex justify-between"><span class="text-gray-600">Points from Fix Tasks:</span><span class="font-mono">${tech.pointsBreakdown.fix.toFixed(3)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Points from QC Tasks:</span><span class="font-mono">${tech.pointsBreakdown.qc.toFixed(3)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Points from i3qa Tasks:</span><span class="font-mono">${tech.pointsBreakdown.i3qa.toFixed(3)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Points from RV Tasks:</span><span class="font-mono">${tech.pointsBreakdown.rv.toFixed(3)}</span></div>
                    <hr class="my-2">
                    <div class="flex justify-between font-bold"><span class="text-gray-800">Total Points:</span><span class="font-mono">${tech.points.toFixed(3)}</span></div>
                </div>

                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-base text-gray-800 mb-2">Quality Calculation</h4>
                     <p class="text-xs text-gray-500 mb-2">Formula: [Fix Tasks] / ([Fix Tasks] + [Refix Tasks] + [Warnings])</p>
                    <div class="p-2 bg-white rounded text-center"><code>${tech.fixTasks} / (${tech.fixTasks} + ${tech.refixTasks} + ${warningsCount}) = ${(fixQuality).toFixed(4)}</code></div>
                    <div class="flex justify-between font-bold"><span class="text-gray-800">Fix Quality %:</span><span class="font-mono">${(fixQuality * 100).toFixed(2)}%</span></div>
                </div>

                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 class="font-semibold text-base text-blue-800 mb-2">Final Payout</h4>
                    <div class="flex justify-between"><span class="text-gray-600">% of Bonus Earned:</span><span class="font-bold text-green-600">${(qualityModifier * 100).toFixed(0)}%</span></div>
                    <p class="text-xs text-gray-500 mt-2 mb-2">Formula: Total Points * Bonus Multiplier * % of Bonus Earned</p>
                    <div class="p-2 bg-white rounded text-center text-xs md:text-sm mb-2"><code>${tech.points.toFixed(3)} (Points) * ${multiplierDisplay} * ${qualityModifier.toFixed(2)} (Earned)</code></div>
                    <div class="flex justify-between font-bold text-lg"><span class="text-blue-900">Final Payout (PHP):</span><span class="text-blue-600 font-mono">${finalPayout.toFixed(2)}</span></div>
                </div>

            </div>`;

            modalBody.innerHTML = bodyHtml;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            const modal = document.getElementById('info-modal');
            modal.classList.add('hidden');
        }

    </script>
</body>
</html>
