<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team123 Advanced Bonus Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Gray-Blue */
            color: #d1d5db; /* Light Gray */
        }
        .card {
            background-color: #1f2937; /* Lighter Dark Gray-Blue */
            border: 1px solid #374151; /* Subtle Border */
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .info-icon {
            cursor: pointer;
            display: inline-block;
            margin-left: 4px;
            color: #9ca3af; /* Medium Gray */
            vertical-align: middle;
        }
        .info-icon:hover {
            color: #60a5fa; /* Light Blue */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(17, 24, 39, 0.8); /* Dark Transparent BG */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background-color: #1f2937;
            color: #d1d5db;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid #374151;
        }
        #modal-body {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 1rem; /* For scrollbar spacing */
        }
        .modal-overlay:not(.hidden) .modal-content {
            transform: scale(1);
        }
        /* Scrollbar styles for dark theme */
        #modal-body::-webkit-scrollbar, .table-container::-webkit-scrollbar, #team-management-modal .modal-content::-webkit-scrollbar, #workload-chart-container::-webkit-scrollbar { width: 8px; }
        #modal-body::-webkit-scrollbar-track, .table-container::-webkit-scrollbar-track, #team-management-modal .modal-content::-webkit-scrollbar-track, #workload-chart-container::-webkit-scrollbar-track { background: #374151; border-radius: 4px; }
        #modal-body::-webkit-scrollbar-thumb, .table-container::-webkit-scrollbar-thumb, #team-management-modal .modal-content::-webkit-scrollbar-thumb, #workload-chart-container::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        #modal-body::-webkit-scrollbar-thumb:hover, .table-container::-webkit-scrollbar-thumb:hover, #team-management-modal .modal-content::-webkit-scrollbar-thumb:hover, #workload-chart-container::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        textarea, select, input {
            background-color: #374151;
            color: #d1d5db;
            border-color: #4b5563;
        }
        textarea:focus, select:focus, input:focus {
            --tw-ring-color: #3b82f6; /* Blue-500 */
            border-color: #3b82f6;
        }
        textarea:read-only {
            background-color: #4b5563;
            cursor: not-allowed;
        }
        #update-notification {
            transition: opacity 0.5s, transform 0.5s;
        }
        #reorder-list .project-list-item {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: grab;
            margin-bottom: 0.25rem;
            background-color: #374151;
            border: 1px solid #4b5563;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #4b5563;
        }
        select[multiple] {
            height: 10rem;
            background-color: #374151;
            padding: 0.5rem;
        }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::before {
            content: 'â–º';
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        #drop-zone {
            border: 2px dashed #4b5563;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            color: #9ca3af;
            transition: background-color 0.2s, border-color 0.2s;
        }
        #drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: #1e3a8a;
        }
        #tech-results-container, #admin-dashboard, #tl-summary-card, #project-progress-card {
             max-height: 0;
             overflow: hidden;
             opacity: 0;
             transition: all 0.5s ease-in-out;
        }
        #tech-results-container.visible, #admin-dashboard.visible, #tl-summary-card.visible, #project-progress-card.visible {
            max-height: 1500px;
            opacity: 1;
        }
        .progress-bar {
            background-color: #374151;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
        }
        /* New styles for workload chart */
        #workload-chart-container {
            space-y: 0.5rem;
            padding-right: 0.5rem;
        }
        .workload-bar-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .workload-label {
            flex-shrink: 0;
            width: 5rem; /* 80px */
            text-align: right;
            font-size: 0.75rem; /* 12px */
            color: #9ca3af; /* gray-400 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .workload-bar {
            flex-grow: 1;
            background-color: #374151; /* gray-700 */
            border-radius: 0.25rem; /* rounded */
        }
        .workload-bar-inner {
            background-color: #2563eb; /* blue-600 */
            height: 0.75rem; /* h-3 */
            border-radius: 0.25rem; /* rounded */
            transition: width 0.5s ease-in-out;
            text-align: right;
            padding-right: 0.25rem;
            color: white;
            font-size: 0.625rem; /* 10px */
            line-height: 0.75rem; /* leading-3 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div id="update-notification" class="hidden fixed top-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2">
        Project list updated.
    </div>

    <div class="w-full max-w-screen-xl mx-auto p-4 md:p-8">
        <div class="bg-gray-800 rounded-2xl shadow-2xl overflow-hidden border border-gray-700">
            <div class="p-6 md:p-8 bg-gray-900/50 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white">Team123 Advanced Bonus Calculator</h1>
                    <p class="mt-2 text-gray-400">Save, load, and calculate bonuses for multiple projects.</p>
                </div>
                 <div class="flex gap-4">
                    <button id="how-it-works-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">How It Works</button>
                    <button id="admin-login-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-300 shadow-md">Admin Login</button>
                    <button id="logout-btn" class="hidden bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-300 shadow-md">Logout</button>
                </div>
            </div>
            
            <div id="admin-dashboard" class="px-6 md:px-8 pt-6">
                <div class="border-t border-gray-700 pt-6">
                    <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Admin Dashboard</h2>
                    <p class="text-sm text-gray-400 mb-4">As an admin, you can save and delete projects directly to the central database.</p>
                    <button id="manage-teams-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Manage Teams</button>
                </div>
            </div>

            <div id="main-grid" class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-5 gap-8">

                <div class="lg:col-span-2 space-y-6">
                     <div class="card p-6 rounded-xl">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                            <h2 class="text-xl font-semibold text-gray-100">Project Management</h2>
                            <div class="flex gap-2">
                                <button id="reorder-projects-btn" class="hidden bg-gray-600 text-gray-200 font-bold py-1 px-3 rounded-lg hover:bg-gray-500 transition-colors text-sm">Reorder</button>
                                <button id="refresh-projects-btn" title="Refresh Project List" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                                </button>
                            </div>
                        </div>

                         <div class="flex items-center gap-2">
                            <select id="project-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all duration-300">
                                <option value="">Click Refresh to load projects...</option>
                            </select>
                             <button id="delete-project-btn" title="Delete Selected Project" class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-red-800 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                             </button>
                        </div>
                        <div class="mt-4">
                            <button id="calculateCurrentBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">
                                Calculate Selected Project
                            </button>
                        </div>
                         <div class="mt-4 border-t border-gray-700 pt-4">
                             <div class="flex items-center">
                                <input id="customize-calc-all-cb" type="checkbox" class="h-4 w-4 text-indigo-500 focus:ring-indigo-600 bg-gray-700 border-gray-600 rounded">
                                <label for="customize-calc-all-cb" class="ml-3 block text-sm font-medium text-gray-300">Select specific projects to calculate</label>
                            </div>
                            <button id="calculate-all-btn" class="mt-2 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300 shadow-md">Calculate All Projects</button>
                        </div>
                    </div>
                    <div class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Calculation Settings</h2>
                        <div>
                            <label for="bonusMultiplierDirect" class="block text-sm font-medium text-gray-400 mb-1">
                                Bonus Multiplier (PHP)
                                <span class="info-icon" data-key="bonusMultiplier">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                </span>
                            </label>
                            <input type="number" id="bonusMultiplierDirect" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Default: 1 (No multiplier)">
                        </div>
                    </div>

                    <div id="performance-metrics-card" class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Team & Technician Performance Metrics</h2>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <div>
                                        <h3 class="font-semibold text-gray-200">Task Leaderboard</h3>
                                        <p class="text-xs text-gray-400">Ranking based on calculated tasks for the selected project(s).</p>
                                    </div>
                                    <select id="leaderboard-sort-select" class="text-xs p-1 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                        <option value="totalTasks">Rank by Total Tasks</option>
                                        <option value="totalPoints">Rank by Total Points</option>
                                        <option value="fixQuality">Rank by Fix Quality %</option>
                                    </select>
                                </div>
                                <div class="table-container border border-gray-700 rounded-lg text-sm" style="max-height: 200px;">
                                    <table class="min-w-full divide-y divide-gray-700">
                                        <thead class="bg-gray-900/50">
                                            <tr>
                                                <th class="px-4 py-2 text-left font-medium text-gray-300">Rank</th>
                                                <th class="px-4 py-2 text-left font-medium text-gray-300">Technician</th>
                                                <th id="leaderboard-metric-header" class="px-4 py-2 text-left font-medium text-gray-300">Total Tasks</th>
                                            </tr>
                                        </thead>
                                        <tbody id="leaderboard-body" class="divide-y divide-gray-700">
                                            <tr><td class="px-4 py-2 text-gray-400" colspan="3"><i>Calculate a project to see data...</i></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                             <div>
                                <h3 class="font-semibold text-gray-200">Workload Distribution</h3>
                                 <p class="text-xs text-gray-400 mb-2">Visualize task assignments across the team.</p>
                                 <div id="workload-chart-container" class="space-y-2 pr-2 overflow-y-auto border border-gray-700 rounded-lg p-2" style="max-height: 200px;">
                                    <p class="text-gray-500 italic text-sm text-center">Calculate a project to see chart...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="project-data-entry" class="lg:col-span-3 space-y-6">
                    <div class="card p-6 rounded-xl">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                            <h2 class="text-xl font-semibold text-gray-100">Project Data Entry</h2>
                            <button id="edit-data-btn" title="Edit Project Data" class="p-2 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-500 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>
                            </button>
                        </div>

                        <div class="bg-yellow-900/30 border border-yellow-700/50 p-3 rounded-lg mb-4">
                             <div class="flex items-center mb-2">
                                <input id="is-ir-project-checkbox" type="checkbox" class="h-4 w-4 text-indigo-500 focus:ring-indigo-600 bg-gray-700 border-gray-600 rounded">
                                <label for="is-ir-project-checkbox" class="ml-3 block text-sm font-medium text-yellow-300">
                                    Mark Project as IR (for Fix Tasks)
                                    <span class="block text-xs text-yellow-400">Applies 1.5x points multiplier to the sum of all categories in a Fix Task row.</span>
                                </label>
                            </div>
                            <div class="flex items-center">
                                <label for="gsd-value-select" class="block text-sm font-medium text-gray-300 mr-2">GSD Point Value:</label>
                                <select id="gsd-value-select" class="w-1/2 px-3 py-1 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                                    <option value="3in">3in Value</option>
                                    <option value="4in">4in Value</option>
                                    <option value="6in">6in Value</option>
                                    <option value="9in">9in Value</option>
                                </select>
                            </div>
                        </div>

                        <div id="drop-zone">
                            <label for="techData" class="block text-sm font-medium text-gray-400 mb-2">Paste your raw, tab-separated project data here, or drag & drop all shapefile parts (.shp, .dbf, etc.)</label>
                            <textarea id="techData" rows="10" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-sm mb-4" placeholder="Paste data or drop files..."></textarea>
                        </div>

                        <div class="flex gap-4 mt-4">
                            <input type="text" id="project-name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter Project Name to Save/Update">
                            <button id="save-project-btn" class="bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md whitespace-nowrap">Save Project</button>
                        </div>
                        <div class="mt-4">
                            <button id="calculatePastedDataBtn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300 shadow-md">
                                Calculate Pasted Data
                            </button>
                        </div>
                    </div>
                    
                    <div id="project-progress-card" class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Overall Project Progress</h2>
                        <div id="project-progress-content" class="space-y-4">
                             <p class="text-xs text-gray-500 italic">Project progress will be shown here after calculation.</p>
                        </div>
                    </div>

                    <div id="tl-summary-card" class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">TL Summary</h2>
                        <div id="tl-summary-content" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <div id="tech-results-container" class="px-6 md:px-8 pb-8">
                 <h2 id="results-title" class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Technician Bonus Results</h2>
                 <div class="mb-4">
                    <label for="search-tech-id" class="block text-sm font-medium text-gray-400">Search by Tech ID</label>
                    <input type="text" id="search-tech-id" class="w-full md:w-1/3 mt-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Search by Tech ID...">

                    <div id="team-filter-container" class="mt-3 flex flex-wrap gap-x-6 gap-y-2 items-center border-t border-gray-700 pt-3">
                         <span class="text-sm font-medium text-gray-300">Filter by Team:</span>
                         <button id="refresh-teams-btn" title="Refresh Team List" class="p-1 bg-gray-600 text-gray-300 rounded-md hover:bg-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                        </button>
                    </div>
                 </div>
                 <div id="results-summary" class="text-sm text-gray-400 bg-blue-900/30 p-3 rounded-md mb-4 border border-blue-700/50"></div>
                 <div class="table-container border border-gray-700 rounded-lg card">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead id="results-thead" class="bg-gray-900/50 sticky top-0">
                            </thead>
                        <tbody id="tech-results-body" class="divide-y divide-gray-700">
                            </tbody>
                    </table>
                 </div>
            </div>
        </div>
        <p class="text-center text-xs text-gray-500 mt-4 px-4">Disclaimer: This calculator is based on the formulas and tables in the "Phili IC Fixpoints App Documentation v1.0".</p>
    </div>

    <div id="team-management-modal" class="modal-overlay hidden">
        <div class="modal-content overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold text-gray-100 mb-2">Team Management</h3>
            <p class="text-sm text-gray-400 mb-4">Define teams and assign Tech IDs. Paste a comma-separated list of IDs for each team. Click "Save Team Settings" to apply changes for all users.</p>
            <div id="team-list-container" class="space-y-4"></div>
            <div class="mt-4 flex gap-4">
                <input type="text" id="new-team-name" placeholder="New Team Name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <button id="add-team-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 whitespace-nowrap">Add Team</button>
            </div>
            <div class="mt-6 flex justify-end gap-4 border-t border-gray-700 pt-4">
                <button id="close-teams-modal-btn" class="bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">Close</button>
                <button id="save-teams-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Save Team Settings</button>
            </div>
        </div>
    </div>

    <div id="reorder-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-2">Reorder Projects</h3>
            <p class="text-sm text-gray-400 mb-4">Drag and drop the projects to change their display order. Newest projects appear at the top by default.</p>
            <div id="reorder-list" class="space-y-2 h-64 overflow-y-auto p-2 border border-gray-600 rounded-md">
                </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="reorder-cancel-btn" class="bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                <button id="reorder-save-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Save Order</button>
            </div>
        </div>
    </div>

    <div id="info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-100 mb-4"></h3>
            <div id="modal-body" class="text-gray-300 space-y-2"></div>
            <button id="modal-close" class="mt-6 w-full bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">Close</button>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- Your Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDMG_34ybAauTtXQH1s_NaJIeYyKPHW4Po",
            authDomain: "bunos-tracker.firebaseapp.com",
            projectId: "bunos-tracker",
            storageBucket: "bunos-tracker.appspot.com",
            messagingSenderId: "317849644629",
            appId: "1:317849644629:web:46ff71930b88f7646b2edc",
            measurementId: "G-SM4QHYHTYF"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        let projectListCache = [];
        let fullProjectDataCache = {};
        let currentTechStats = {};
        let lastUsedBonusMultiplier = 1;
        let lastCalculationUsedMultiplier = false;
        let lastFilterValue = "";
        let isAdmin = false;
        let isEditMode = false;
        let teamSettings = {};
        let reorderSortable = null;
        let lastUsedGsdValue = '3in';

        // --- DATA FROM DOCUMENTATION ---
        const categoryValues = {
            1: { "3in": 2.19, "4in": 2.19, "6in": 2.19, "9in": 0.99, "IR": 1.5 },
            2: { "3in": 5.86, "4in": 5.86, "6in": 5.86, "9in": 2.07, "IR": 1.5 },
            3: { "3in": 7.44, "4in": 7.44, "6in": 7.44, "9in": 2.78, "IR": 1.5 },
            4: { "3in": 2.29, "4in": 2.29, "6in": 2.29, "9in": 1.57, "IR": 1.5 },
            5: { "3in": 1.55, "4in": 1.55, "6in": 1.55, "9in": 0.6, "IR": 1.5 },
            6: { "3in": 1.84, "4in": 1.84, "6in": 1.84, "9in": 0.78, "IR": 1.5 },
            7: { "3in": 1, "4in": 1, "6in": 1, "9in": 1, "IR": 1.5 },
            8: { "3in": 3.74, "4in": 3.74, "6in": 3.74, "9in": 3.74, "IR": 1.5 },
            9: { "3in": 1.73, "4in": 1.73, "6in": 1.73, "9in": 1.73, "IR": 1.5 }
        };

        const irModifierValue = 1.5;
        const calculationInfo = {
            howItWorks: {
                title: 'How It Works & How to Use',
                body: `<div class="space-y-6 text-sm">
                        <div>
                            <h4 class="text-lg font-bold text-gray-100 mb-2">How to Use This Site</h4>
                            <ol class="list-decimal list-inside space-y-2">
                                <li><strong>Load Projects:</strong> Click the "Refresh Projects" button (the circular arrow) to load the latest project list from the database. This is only needed once per session or when you want the latest data.</li>
                                <li><strong>Admin Login:</strong> Click 'Admin Login' and use credentials ('admin'/'admin123') to enter Admin Mode.</li>
                                <li><strong>Admin Mode:</strong> In this mode, you can create, save, delete, and reorder projects. You can also manage team assignments in the Admin Dashboard.</li>
                                <li><strong>Filtering:</strong> Use the search bar and the team checkboxes to filter the results table.</li>
                                <li><strong>Multi-Select:</strong> Check the "Select multiple projects" box to choose several projects at once for a combined calculation.</li>
                            </ol>
                        </div>
                        <hr class="border-gray-600">
                        <div>
                            <h4 class="text-lg font-bold text-gray-100 mb-2">How The Calculation Works</h4>
                            <p>The calculation logic is based on the data from the selected project(s) and follows the "Phili IC Fixpoints App Documentation v1.0".</p>

                            <h5 class="text-md font-semibold text-gray-200 mt-4 mb-1">Primary Fix Category Counts</h5>
                            <p>This is a count of all categories handled by a technician. It is calculated by checking the following columns in your raw data:</p>
                            <ul class="list-disc list-inside pl-4 text-xs font-mono bg-gray-900 p-2 rounded-md">
                                <li><code>category</code></li>
                                <li><code>rv1_cat</code></li>
                                <li><code>rv2_cat</code></li>
                                <li><code>afp1_cat</code> (only if <code>afp1_stat</code> is "AA")</li>
                                <li><code>afp2_cat</code> (only if <code>afp2_stat</code> is "AA")</li>
                            </ul>

                            <h5 class="text-md font-semibold text-gray-200 mt-4 mb-1">Points from Fix Tasks Calculation</h5>
                            <p>This is the sum of points a technician earns from all fix-related tasks. Points are calculated based on the categories found in these columns:</p>
                             <ul class="list-disc list-inside pl-4 text-xs font-mono bg-gray-900 p-2 rounded-md">
                                <li><code>category</code>, <code>rv1_cat</code>, <code>rv2_cat</code> (These are always included for the main technician)</li>
                                <li><code>afp1_cat</code>, <code>afp2_cat</code> (Points are only added if the corresponding <code>_stat</code> column is "AA" - Approved by RQA)</li>
                                <li><code>rv1_cat</code>, <code>rv2_cat</code>, etc. (Points are also added if the corresponding <code>_label</code> column contains an "M" for Miss, credited to the technician who performed that fix)</li>
                            </ul>
                        </div>
                       </div>`
            },
            bonusMultiplier: { title: 'Bonus Multiplier (PHP)', body: `<p>An optional multiplier for the final payout. Enter a number (e.g., 1.25 for a 25% bonus) to adjust the final calculated bonus for all technicians.</p>` },
            totalPoints: { title: 'Total Points Calculation', body: `<p>Points are calculated for each individual task based on its type (Fix, QC, i3qa, RV) and category, then summed for each technician.</p><p>For Fix tasks, points are derived from a table of category values. The GSD setting can change the points for certain categories. An "IR" project applies a 1.5x multiplier to the sum of all fix categories in a single task row.</p>`},
            fixQuality: { title: 'Fix Quality % Calculation', body: `<p>This measures a technician's accuracy. It's calculated using the formula: <code>[# of Fix Tasks] / ([# of Fix Tasks] + [# of Refix Tasks] + [# of Warnings])</code></p><p>A higher percentage indicates fewer errors.</p>`},
            bonusEarned: { title: '% of Bonus Earned Calculation', body: `<p>This percentage is determined by looking up the <strong>Fix Quality %</strong> in a tiered table. For example, a quality of 100% earns 120% of the bonus, while 82.5% earns 55%, and so on. Below 77.5%, no bonus is earned.</p>`},
            totalBonus: { title: 'Final Payout (PHP) Calculation', body: `<p>The final amount a technician receives. It's calculated with the formula: <code>Total Points * Bonus Multiplier * % of Bonus Earned</code></p>`}
        };

        // --- All other JavaScript functions remain the same. ---
        // (The full script from the previous turn is included here)
        function createNewTechStat() {
            return {
                id: '', points: 0, fixTasks: 0, refixTasks: 0, warnings: [],
                refixDetails: [],
                missedCategories: [],
                approvedByRQA: [],
                approvedByRQACategoryCounts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 },
                categoryCounts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 },
                pointsBreakdown: { fix: 0, qc: 0, i3qa: 0, rv: 0 }
            };
        }
        
        async function loadTeamSettings() {
            try {
                const teamDocRef = doc(db, "public_settings", "teams");
                const docSnap = await getDoc(teamDocRef);
                teamSettings = docSnap.exists() ? docSnap.data() : {};
            } catch (error) {
                console.error("Error loading team settings:", error);
                teamSettings = {};
            }
            populateTeamFilters();
            if (isAdmin) populateAdminTeamManagement();
        }

        async function saveTeamSettings(settings) {
            if (!isAdmin) return;
            try {
                await setDoc(doc(db, "public_settings", "teams"), settings);
                alert("Team settings saved successfully.");
                teamSettings = settings;
                populateTeamFilters();
            } catch (error) {
                console.error("Error saving team settings: ", error);
                alert("Failed to save team settings.");
            }
        }

        async function saveProjectToFirestore(projectData) {
            if (!isAdmin) return;
            const summaryRef = doc(db, "public_settings", "project_summary");
            const projectRef = doc(db, "public_projects", projectData.id);

            try {
                const textEncoder = new TextEncoder();
                const dataAsUint8Array = textEncoder.encode(projectData.rawData);
                const compressed = pako.deflate(dataAsUint8Array);
                const base64String = btoa(String.fromCharCode.apply(null, compressed));
                const fullDataToSave = { ...projectData, rawData: base64String };

                const metadata = { ...projectData };
                delete metadata.rawData;

                await runTransaction(db, async (transaction) => {
                    const summaryDoc = await transaction.get(summaryRef);
                    let projectList = summaryDoc.exists() ? summaryDoc.data().projects : [];
                    
                    const existingIndex = projectList.findIndex(p => p.id === metadata.id);
                    if (existingIndex > -1) {
                        projectList[existingIndex] = metadata;
                    } else {
                        projectList.push(metadata);
                    }

                    transaction.set(projectRef, fullDataToSave);
                    transaction.set(summaryRef, { projects: projectList });
                });

                return true;
            } catch (error) {
                console.error("Error saving project transactionally: ", error);
                alert("Failed to save project. The data might be too large or invalid.");
                return false;
            }
        }

        async function fetchProjectListSummary() {
            const projectSelect = document.getElementById('project-select');
            projectSelect.innerHTML = '<option value="">Loading Projects...</option>';
            try {
                const summaryRef = doc(db, "public_settings", "project_summary");
                const docSnap = await getDoc(summaryRef);

                projectListCache = docSnap.exists() ? docSnap.data().projects || [] : [];
                
                sessionStorage.setItem('cachedProjectList', JSON.stringify(projectListCache));
                updateProjectDropdown();
                showUpdateNotification();
            } catch (error) {
                console.error("Error fetching project list summary:", error);
                projectSelect.innerHTML = '<option value="">Error loading. Please Refresh.</option>';
                alert("Could not load project list from the database. Check console for errors and ensure Firestore rules are correct.");
            }
        }

        async function fetchFullProjectData(projectId) {
            if (fullProjectDataCache[projectId]) {
                return fullProjectDataCache[projectId];
            }

            try {
                const projectRef = doc(db, "public_projects", projectId);
                const docSnap = await getDoc(projectRef);

                if (!docSnap.exists()) throw new Error("Project data not found.");

                const project = docSnap.data();
                let decompressedData;
                try {
                    const binaryString = atob(project.rawData);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    const decompressedUint8Array = pako.inflate(bytes);
                    decompressedData = new TextDecoder().decode(decompressedUint8Array);
                } catch (e) {
                    console.error(`Decompression failed for project "${project.name}".`);
                    decompressedData = "### DATA CORRUPTED ###";
                }
                
                const fullData = { ...project, rawData: decompressedData };
                fullProjectDataCache[projectId] = fullData;
                return fullData;

            } catch (error) {
                console.error("Error fetching full project data:", error);
                alert(`Could not load data for project ID ${projectId}.`);
                return null;
            }
        }
        
        async function deleteProjectFromFirestore(projectId) {
            if (!isAdmin) return;
            const summaryRef = doc(db, "public_settings", "project_summary");
            const projectRef = doc(db, "public_projects", projectId);

            try {
                await runTransaction(db, async (transaction) => {
                    const summaryDoc = await transaction.get(summaryRef);
                    if (!summaryDoc.exists()) throw "Summary document does not exist.";
                    
                    let projectList = summaryDoc.data().projects || [];
                    const updatedList = projectList.filter(p => p.id !== projectId);
                    
                    transaction.set(summaryRef, { projects: updatedList });
                    transaction.delete(projectRef);
                });
                return true;
            } catch (error) {
                console.error("Error deleting project transactionally: ", error);
                alert("Failed to delete project.");
                return false;
            }
        }

        function updateProjectDropdown() {
            const projectSelect = document.getElementById('project-select');
            const currentVal = projectSelect.value;
            projectSelect.innerHTML = '<option value="">Select a Project</option>';

            const sortedProjects = [...projectListCache].sort((a, b) => {
                const orderA = a.projectOrder ?? Infinity;
                const orderB = b.projectOrder ?? Infinity;
                if (orderA !== orderB) return orderA - orderB;
                return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
            });
            
            sortedProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                const displayName = project.isIR ? `${project.name} (IR)` : project.name;
                option.textContent = displayName;
                projectSelect.appendChild(option);
            });

            if (projectListCache.some(p => p.id === currentVal)) projectSelect.value = currentVal;
            manageButtonState();
        }
        
        function manageButtonState() {
            const projectDataEntry = document.getElementById('project-data-entry');
            const mainGrid = document.getElementById('main-grid');
            const projectSelect = document.getElementById('project-select');
            const projectId = projectSelect.value;
            const techData = document.getElementById('techData');
            const calcPastedDataBtn = document.getElementById('calculatePastedDataBtn');
            const gsdValueSelect = document.getElementById('gsd-value-select');
            const reorderBtn = document.getElementById('reorder-projects-btn');
            const manageTeamsBtn = document.getElementById('manage-teams-btn');

            projectDataEntry.classList.toggle('hidden', !isAdmin);
            mainGrid.classList.toggle('lg:grid-cols-1', !isAdmin);
            mainGrid.classList.toggle('lg:grid-cols-5', isAdmin);
            reorderBtn.classList.toggle('hidden', !isAdmin);
            if(manageTeamsBtn) manageTeamsBtn.style.display = isAdmin ? 'block' : 'none';
            
            document.getElementById('delete-project-btn').disabled = !isAdmin || !projectId;
            document.getElementById('edit-data-btn').classList.toggle('hidden', !isAdmin || !projectId);
            document.getElementById('save-project-btn').disabled = !isAdmin || (projectId && !isEditMode);
            techData.readOnly = !isAdmin || (projectId && !isEditMode);
            document.getElementById('is-ir-project-checkbox').disabled = !isAdmin;
            gsdValueSelect.disabled = !isAdmin;

            calcPastedDataBtn.disabled = techData.value.trim() === '';
        }
        
        async function handleAdminLogin() {
            const user = prompt("Enter Admin Username:");
            const pass = prompt("Enter Admin Password:");
            
            if (user === "admin" && pass === "admin123") {
                isAdmin = true;
                isEditMode = false;
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('admin-login-btn').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.add('visible');
                await loadTeamSettings();
                manageButtonState();
                alert("Admin Mode Activated.");
            } else if (user || pass) {
                alert("Incorrect username or password.");
            }
        }

        function handleLogout() {
            isAdmin = false;
            isEditMode = false;
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('admin-login-btn').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.remove('visible');
            manageButtonState();
            alert("You have been logged out.");
        }

        function showUpdateNotification() {
            const notification = document.getElementById('update-notification');
            if (notification.classList.contains('hidden')) {
                notification.classList.remove('hidden', 'opacity-0', 'translate-y-2');
                setTimeout(() => {
                    notification.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => notification.classList.add('hidden'), 500);
                }, 3000);
            }
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            const techData = document.getElementById('techData');

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');

                const files = Array.from(e.dataTransfer.files);
                if (files.length === 0) return;

                const shpFile = files.find(f => f.name.toLowerCase().endsWith('.shp'));
                const dbfFile = files.find(f => f.name.toLowerCase().endsWith('.dbf'));

                if (!shpFile || !dbfFile) return alert("Drop incomplete. Please drop both .shp and .dbf files.");

                const shpReader = new FileReader();
                const dbfReader = new FileReader();

                const shpPromise = new Promise((resolve, reject) => { shpReader.onload = (event) => resolve(event.target.result); shpReader.onerror = reject; });
                const dbfPromise = new Promise((resolve, reject) => { dbfReader.onload = (event) => resolve(event.target.result); dbfReader.onerror = reject; });

                shpReader.readAsArrayBuffer(shpFile);
                dbfReader.readAsArrayBuffer(dbfFile);

                Promise.all([shpPromise, dbfPromise]).then(async ([shpBuffer, dbfBuffer]) => {
                    try {
                        const geojson = await shapefile.read(shpBuffer, dbfBuffer);
                        if (!geojson || !geojson.features || geojson.features.length === 0) return alert("Shapefile is empty or invalid.");

                        const headers = Object.keys(geojson.features[0].properties);
                        let tsv = headers.join('\t') + '\n';
                        geojson.features.forEach(feature => { tsv += headers.map(h => feature.properties[h]).join('\t') + '\n'; });
                        
                        techData.value = tsv;
                        techData.dispatchEvent(new Event('input'));
                    } catch (error) {
                        console.error("Error parsing shapefile:", error);
                        alert("Could not parse the shapefile.");
                    }
                }).catch(error => {
                    console.error("Error reading files:", error);
                    alert("An error occurred while reading files.");
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const cachedList = sessionStorage.getItem('cachedProjectList');
            if (cachedList) {
                try {
                    projectListCache = JSON.parse(cachedList);
                    updateProjectDropdown();
                } catch (e) {
                    console.error("Failed to parse cached list:", e);
                    sessionStorage.removeItem('cachedProjectList');
                }
            } else {
                fetchProjectListSummary();
            }
            
            loadTeamSettings();
            manageButtonState();
            setupDragAndDrop();
            
            document.getElementById('manage-teams-btn').addEventListener('click', () => { document.getElementById('team-management-modal').classList.remove('hidden'); });
            document.getElementById('close-teams-modal-btn').addEventListener('click', () => { document.getElementById('team-management-modal').classList.add('hidden'); });

            document.getElementById('leaderboard-sort-select').addEventListener('change', () => renderPerformanceMetrics(currentTechStats));

            document.getElementById('reorder-projects-btn').addEventListener('click', openReorderModal);
            document.getElementById('reorder-cancel-btn').addEventListener('click', closeReorderModal);
            document.getElementById('reorder-save-btn').addEventListener('click', saveReorderModal);
            document.getElementById('reorder-modal').addEventListener('click', (e) => { if (e.target.id === 'reorder-modal') closeReorderModal(); });

            document.getElementById('add-team-btn').addEventListener('click', () => {
                if (!isAdmin) return;
                const newTeamNameInput = document.getElementById('new-team-name');
                const newTeamName = newTeamNameInput.value.trim();
                if (newTeamName && !document.querySelector(`.team-definition[data-team-name="${newTeamName}"]`)) {
                    addTeamToAdminUI(newTeamName);
                    newTeamNameInput.value = '';
                } else alert(newTeamName ? 'A team with this name already exists.' : 'Please enter a team name.');
            });

            document.getElementById('save-teams-btn').addEventListener('click', () => {
                if (!isAdmin) return;
                const newTeamSettings = {};
                document.querySelectorAll('#team-list-container .team-definition').forEach(div => {
                    const teamName = div.dataset.teamName;
                    const techIds = div.querySelector('textarea').value.split(',').map(id => id.trim()).filter(Boolean);
                    newTeamSettings[teamName] = techIds;
                });
                saveTeamSettings(newTeamSettings);
            });

            document.getElementById('save-project-btn').addEventListener('click', async () => {
                if (!isAdmin) return;
                const projectName = document.getElementById('project-name').value.trim();
                const rawData = document.getElementById('techData').value.trim();
                const isIR = document.getElementById('is-ir-project-checkbox').checked;
                const gsdValue = document.getElementById('gsd-value-select').value;
                const projIdToSave = document.getElementById('project-select').value;

                if (projectName.length > 50) return alert("Project name too long.");
                if (!projectName || !rawData) return alert("Project name and data are required.");
                
                const id = (isEditMode && projIdToSave) ? projIdToSave : Date.now().toString();
                const existingProject = projectListCache.find(p => p.id === id);

                const projectData = {
                    id: id, name: projectName, rawData: rawData, isIR: isIR, gsdValue: gsdValue,
                    createdAt: existingProject?.createdAt || new Date().toISOString(),
                    projectOrder: existingProject?.projectOrder ?? projectListCache.length
                };

                if (await saveProjectToFirestore(projectData)) {
                    alert(`Project "${projectName}" saved.`);
                    await fetchProjectListSummary();
                    isEditMode = false;
                    document.getElementById('project-select').value = id;
                    manageButtonState();
                }
            });
            
            document.getElementById('delete-project-btn').addEventListener('click', async () => {
                if (!isAdmin) return;
                const projectId = document.getElementById('project-select').value;
                if (!projectId) return;
                
                const projectMeta = projectListCache.find(p => p.id === projectId);
                if (!projectMeta) return;

                if (confirm(`Delete project "${projectMeta.name}"?`)) {
                    if (await deleteProjectFromFirestore(projectId)) {
                        alert(`Project "${projectMeta.name}" deleted.`);
                        fullProjectDataCache = {};
                        document.getElementById('techData').value = '';
                        document.getElementById('project-name').value = '';
                        await fetchProjectListSummary();
                    }
                }
            });
            
            document.getElementById('refresh-projects-btn').addEventListener('click', () => { sessionStorage.removeItem('cachedProjectList'); fetchProjectListSummary(); });
            document.getElementById('project-select').addEventListener('change', async (e) => {
                const projectId = e.target.value;
                isEditMode = false;
                if (projectId) {
                    const fullProject = await fetchFullProjectData(projectId);
                    if (fullProject) {
                        document.getElementById('techData').value = fullProject.rawData;
                        document.getElementById('project-name').value = fullProject.name;
                        document.getElementById('is-ir-project-checkbox').checked = fullProject.isIR || false;
                        document.getElementById('gsd-value-select').value = fullProject.gsdValue || '3in';
                    }
                } else {
                    document.getElementById('techData').value = '';
                    document.getElementById('project-name').value = '';
                    document.getElementById('is-ir-project-checkbox').checked = false;
                    document.getElementById('gsd-value-select').value = '3in';
                }
                manageButtonState();
            });
            
            document.getElementById('edit-data-btn').addEventListener('click', () => {
                if (!isAdmin) return;
                isEditMode = true;
                manageButtonState();
                document.getElementById('techData').focus();
            });
            
            document.getElementById('calculateCurrentBtn').addEventListener('click', () => calculateAndRender(false));
            document.getElementById('calculate-all-btn').addEventListener('click', () => {
                const isCustomized = document.getElementById('customize-calc-all-cb').checked;
                if (isCustomized) {
                    const selectedProjectIds = [...document.getElementById('project-select').selectedOptions].map(opt => opt.value).filter(Boolean);
                    if (selectedProjectIds.length === 0) return alert('Please select projects.');
                    calculateAndRender(true, selectedProjectIds);
                } else {
                    calculateAndRender(true, null);
                }
            });
            document.getElementById('customize-calc-all-cb').addEventListener('change', (e) => {
                const projectSelect = document.getElementById('project-select');
                const calcCurrentBtn = document.getElementById('calculateCurrentBtn');
                const calcAllBtn = document.getElementById('calculate-all-btn');
                projectSelect.multiple = e.target.checked;
                projectSelect.size = e.target.checked ? 8 : 1;
                calcCurrentBtn.disabled = e.target.checked;
                calcAllBtn.textContent = e.target.checked ? 'Calculate Checked Projects' : 'Calculate All Projects';
            });

            document.getElementById('calculatePastedDataBtn').addEventListener('click', calculatePastedData);
            document.getElementById('techData').addEventListener('input', manageButtonState);
            document.getElementById('search-tech-id').addEventListener('input', (e) => { lastFilterValue = e.target.value; filterTable(); });
            document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('refresh-teams-btn').addEventListener('click', loadTeamSettings);
            document.body.addEventListener('click', (e) => {
                const icon = e.target.closest('.info-icon');
                if (icon) {
                    const key = icon.dataset.key;
                    const techId = icon.dataset.techId;
                    if (key) openModal(key);
                    else if (techId) openTechSummaryModal(techId);
                }
            });
            document.getElementById('how-it-works-btn').addEventListener('click', () => openModal('howItWorks'));
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('info-modal').addEventListener('click', (e) => { if (e.target.id === 'info-modal') closeModal(); });
        });

        async function calculateAndRender(isAllProjects, projectIds = null) {
            let bonusMultiplier = 1;
            let isMultiplierUsed = false;
            const directMultiplierInput = document.getElementById('bonusMultiplierDirect').value;

            if (directMultiplierInput.trim() !== '') {
                const parsedMultiplier = parseFloat(directMultiplierInput);
                if (!isNaN(parsedMultiplier) && parsedMultiplier >= 0) {
                    bonusMultiplier = parsedMultiplier;
                    isMultiplierUsed = true;
                } else return alert("Bonus Multiplier must be a valid number.");
            }
            
            lastUsedBonusMultiplier = bonusMultiplier;
            lastCalculationUsedMultiplier = isMultiplierUsed;
            const resultsTitleEl = document.getElementById('results-title');
            
            if (isAllProjects) {
                if (!confirm("Calculating all projects may be slow. Continue?")) return;

                const projectsToFetch = projectIds || projectListCache.map(p => p.id);
                resultsTitleEl.textContent = `${projectIds ? 'Selected Projects' : 'All Projects'} (Combined) - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : ''}`;

                const allFullProjects = await Promise.all(projectsToFetch.map(id => fetchFullProjectData(id)));
                
                let combinedTechStats = {};
                let combinedSummaryStats = { allCategoryCounts: {}, totalRows: 0, comboTasks: 0, rv1CatCounts: {}, rv2CatCounts: {}, rv3CatCounts: {}, rv4CatCounts: {}, totalIncorrect: 0, totalMiss: 0 };
                const projectBreakdown = [];
                
                if (allFullProjects.filter(Boolean).length > 0) lastUsedGsdValue = allFullProjects.filter(Boolean)[0].gsdValue || '3in';

                allFullProjects.filter(Boolean).forEach(project => {
                    const gsdForCalculation = project.gsdValue || '3in'; 
                    const parsedData = parseRawData(project.rawData, project.isIR || false, project.name, gsdForCalculation); 
                    if (parsedData) {
                        const projectTotalPoints = Object.values(parsedData.techStats).reduce((sum, tech) => sum + tech.points, 0);
                        const projectTotalCategories = Object.values(parsedData.techStats).reduce((sum, tech) => sum + Object.values(tech.categoryCounts).reduce((catSum, count) => catSum + count, 0), 0);
                        projectBreakdown.push({ name: project.name, points: projectTotalPoints, isIR: project.isIR || false, totalCategories: projectTotalCategories });

                        for (const techId in parsedData.techStats) {
                            if (!combinedTechStats[techId]) combinedTechStats[techId] = createNewTechStat();
                            const combined = combinedTechStats[techId];
                            const single = parsedData.techStats[techId];
                            combined.id = techId;
                            combined.points += single.points;
                            combined.fixTasks += single.fixTasks;
                            combined.refixTasks += single.refixTasks;
                            combined.warnings.push(...single.warnings);
                            combined.refixDetails.push(...single.refixDetails);
                            combined.missedCategories.push(...single.missedCategories);
                            combined.approvedByRQA.push(...single.approvedByRQA);
                            for (let i = 1; i <= 9; i++) {
                                combined.categoryCounts[i] += single.categoryCounts[i];
                                combined.approvedByRQACategoryCounts[i] += single.approvedByRQACategoryCounts[i];
                            }
                            for (const type in single.pointsBreakdown) combined.pointsBreakdown[type] += single.pointsBreakdown[type];
                        }
                        combinedSummaryStats.totalRows += parsedData.summaryStats.totalRows;
                        combinedSummaryStats.comboTasks += parsedData.summaryStats.comboTasks;
                        combinedSummaryStats.totalIncorrect += parsedData.summaryStats.totalIncorrect;
                        combinedSummaryStats.totalMiss += parsedData.summaryStats.totalMiss;
                    }
                });

                currentTechStats = combinedTechStats; 
                renderSingleProjectTable(currentTechStats, bonusMultiplier);
                renderTlSummary(combinedSummaryStats, projectBreakdown);
                renderPerformanceMetrics(currentTechStats);
                renderProjectProgress(projectBreakdown);
            } else {
                const projectId = document.getElementById('project-select').value;
                if (!projectId) return alert("Please select a project.");
                
                const project = await fetchFullProjectData(projectId);
                if (!project) return;

                resultsTitleEl.textContent = `Project: ${project.name} - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : ''}`;
                
                const gsdForCalculation = project.gsdValue || '3in';
                lastUsedGsdValue = gsdForCalculation;
                const parsedData = parseRawData(project.rawData, project.isIR, project.name, gsdForCalculation);
                if (parsedData) {
                    currentTechStats = parsedData.techStats;
                    renderSingleProjectTable(currentTechStats, bonusMultiplier);
                    renderTlSummary(parsedData.summaryStats);
                    renderPerformanceMetrics(currentTechStats);
                    const singleProjectBreakdown = [{ name: project.name, points: Object.values(currentTechStats).reduce((sum, tech) => sum + tech.points, 0) }];
                    renderProjectProgress(singleProjectBreakdown);
                }
            }
            document.getElementById('tech-results-container').classList.add('visible');
            document.getElementById('tl-summary-card').classList.add('visible');
            document.getElementById('project-progress-card').classList.add('visible');
        }
        
        function calculatePastedData() {
            let bonusMultiplier = 1;
            let isMultiplierUsed = false;
            const directMultiplierInput = document.getElementById('bonusMultiplierDirect').value;

            if (directMultiplierInput.trim() !== '') {
                const parsedMultiplier = parseFloat(directMultiplierInput);
                if (!isNaN(parsedMultiplier) && parsedMultiplier >= 0) {
                    bonusMultiplier = parsedMultiplier;
                    isMultiplierUsed = true;
                } else return alert("Bonus Multiplier must be a valid number.");
            }
            
            lastUsedBonusMultiplier = bonusMultiplier;
            lastCalculationUsedMultiplier = isMultiplierUsed;

            const resultsTitleEl = document.getElementById('results-title');
            const data = document.getElementById('techData').value.trim();
            const isProjectLevelIR = document.getElementById('is-ir-project-checkbox').checked;
            const gsdForCalculation = document.getElementById('gsd-value-select').value;
            lastUsedGsdValue = gsdForCalculation;

            if (!data) return alert("Please paste data.");

            resultsTitleEl.textContent = `Pasted Data - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : ''}`;
            
            const parsedData = parseRawData(data, isProjectLevelIR, 'Pasted Data', gsdForCalculation);
            if (parsedData) {
                currentTechStats = parsedData.techStats;
                renderSingleProjectTable(currentTechStats, bonusMultiplier);
                renderTlSummary(parsedData.summaryStats);
                renderPerformanceMetrics(currentTechStats);
                const singleProjectBreakdown = [{ name: "Pasted Data", points: Object.values(currentTechStats).reduce((sum, tech) => sum + tech.points, 0) }];
                renderProjectProgress(singleProjectBreakdown);
            }
            document.getElementById('tech-results-container').classList.add('visible');
            document.getElementById('tl-summary-card').classList.add('visible');
            document.getElementById('project-progress-card').classList.add('visible');
        }

        function renderPerformanceMetrics(techStats) {
            const leaderboardBody = document.getElementById('leaderboard-body');
            const sortSelect = document.getElementById('leaderboard-sort-select');
            const metricHeader = document.getElementById('leaderboard-metric-header');
            const workloadContainer = document.getElementById('workload-chart-container');
            leaderboardBody.innerHTML = '';
            workloadContainer.innerHTML = '';

            const selectedTeams = Array.from(document.querySelectorAll('#team-filter-container input:checked')).map(cb => cb.dataset.teamName);
            let allowedTechIds = new Set();

            if (selectedTeams.length > 0) {
                selectedTeams.forEach(teamName => {
                    if (teamSettings[teamName]) {
                        teamSettings[teamName].forEach(techId => allowedTechIds.add(techId.toUpperCase()));
                    }
                });
            }

            let filteredTechStats = {};
            if (selectedTeams.length === 0) {
                filteredTechStats = techStats;
            } else {
                for (const techId in techStats) {
                    if (allowedTechIds.has(techId.toUpperCase())) {
                        filteredTechStats[techId] = techStats[techId];
                    }
                }
            }

            const techArray = Object.values(filteredTechStats).map(tech => {
                const denominator = tech.fixTasks + tech.refixTasks + tech.warnings.length;
                return {
                    id: tech.id,
                    totalTasks: tech.fixTasks + tech.refixTasks,
                    totalPoints: tech.points,
                    fixQuality: denominator > 0 ? (tech.fixTasks / denominator) * 100 : 0
                }
            });

            const sortOption = sortSelect.value;
            switch(sortOption) {
                case 'totalPoints':
                    techArray.sort((a, b) => b.totalPoints - a.totalPoints);
                    metricHeader.textContent = "Total Points";
                    break;
                case 'fixQuality':
                    techArray.sort((a, b) => b.fixQuality - a.fixQuality);
                    metricHeader.textContent = "Fix Quality %";
                    break;
                default:
                    techArray.sort((a, b) => b.totalTasks - a.totalTasks);
                    metricHeader.textContent = "Total Tasks";
                    break;
            }

            if (techArray.length === 0) {
                leaderboardBody.innerHTML = '<tr><td class="px-4 py-2 text-gray-400" colspan="3"><i>No technician data to display for this filter.</i></td></tr>';
                workloadContainer.innerHTML = '<p class="text-gray-500 italic text-sm text-center">No workload data to display.</p>';
                return;
            }

            techArray.forEach((tech, index) => {
                const row = leaderboardBody.insertRow();
                let metricValue;
                switch(sortOption) {
                    case 'totalPoints': metricValue = tech.totalPoints.toFixed(2); break;
                    case 'fixQuality': metricValue = `${tech.fixQuality.toFixed(2)}%`; break;
                    default: metricValue = tech.totalTasks;
                }
                row.innerHTML = `<td class="px-4 py-2 text-gray-300 font-medium">${index + 1}</td><td class="px-4 py-2 text-gray-300">${tech.id}</td><td class="px-4 py-2 text-gray-300 font-mono">${metricValue}</td>`;
            });
            
            const maxTasks = Math.max(...techArray.map(t => t.totalTasks), 1);
            techArray.sort((a, b) => b.totalTasks - a.totalTasks).forEach(tech => {
                const barWrapper = document.createElement('div');
                barWrapper.className = 'workload-bar-wrapper';
                const widthPercent = (tech.totalTasks / maxTasks) * 100;
                barWrapper.innerHTML = `
                    <div class="workload-label" title="${tech.id}">${tech.id}</div>
                    <div class="workload-bar">
                        <div class="workload-bar-inner" style="width: ${widthPercent}%">${tech.totalTasks}</div>
                    </div>
                `;
                workloadContainer.appendChild(barWrapper);
            });
        }

        function renderProjectProgress(projectBreakdown) {
            const progressContent = document.getElementById('project-progress-content');
            progressContent.innerHTML = '';
            
            if (!projectBreakdown || projectBreakdown.length === 0) {
                 progressContent.innerHTML = '<p class="text-xs text-gray-500 italic">No project data to display progress.</p>';
                 return;
            }

            const maxPoints = Math.max(...projectBreakdown.map(p => p.points), 1);

            projectBreakdown.forEach(proj => {
                const progressPercent = (proj.points / maxPoints) * 100;
                const progressElement = document.createElement('div');
                progressElement.innerHTML = `
                    <div class="flex justify-between items-center mb-1 text-sm">
                        <span class="font-medium text-gray-300">${proj.name}</span>
                        <span class="font-mono text-xs text-gray-400">${proj.points.toFixed(2)} pts</span>
                    </div>
                    <div class="progress-bar h-2.5">
                        <div class="progress-bar-inner bg-blue-600" style="width: ${progressPercent}%"></div>
                    </div>
                `;
                progressContent.appendChild(progressElement);
            });
        }

        function renderSingleProjectTable(techStats, bonusMultiplier) {
            const resultsThead = document.getElementById('results-thead');
            const resultsBody = document.getElementById('tech-results-body');
            resultsBody.innerHTML = '';
            const infoIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>`;
            resultsThead.innerHTML = `
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Tech ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Total Points <span class="info-icon" data-key="totalPoints">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Fix Quality % <span class="info-icon" data-key="fixQuality">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">% of Bonus Earned <span class="info-icon" data-key="bonusEarned">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Final Payout (PHP) <span class="info-icon" data-key="totalBonus">${infoIconSvg}</span></th>
                </tr>
            `;

            for (const techId in techStats) {
                const tech = techStats[techId];
                const row = createTableRow(tech, bonusMultiplier);
                row.dataset.techId = techId;
                resultsBody.appendChild(row);
            }

            filterTable();
        }
        
        function calculateQualityModifier(qualityRate) {
            if (qualityRate >= 100) return 1.20; if (qualityRate >= 99.5) return 1.18; if (qualityRate >= 99) return 1.16;
            if (qualityRate >= 98.5) return 1.14; if (qualityRate >= 98) return 1.12; if (qualityRate >= 97.5) return 1.10;
            if (qualityRate >= 97) return 1.08; if (qualityRate >= 96.5) return 1.06; if (qualityRate >= 96) return 1.04;
            if (qualityRate >= 95.5) return 1.02; if (qualityRate >= 95) return 1.00; if (qualityRate >= 94.5) return 0.99;
            if (qualityRate >= 94) return 0.98; if (qualityRate >= 93.5) return 0.97; if (qualityRate >= 93) return 0.96;
            if (qualityRate >= 92.5) return 0.95; if (qualityRate >= 92) return 0.94; if (qualityRate >= 91.5) return 0.93;
            if (qualityRate >= 91) return 0.91; if (qualityRate >= 90.5) return 0.90; if (qualityRate >= 90) return 0.88;
            if (qualityRate >= 89.5) return 0.87; if (qualityRate >= 89) return 0.85; if (qualityRate >= 88.5) return 0.83;
            if (qualityRate >= 88) return 0.80; if (qualityRate >= 87.5) return 0.78; if (qualityRate >= 87) return 0.75;
            if (qualityRate >= 86.5) return 0.73; if (qualityRate >= 86) return 0.70; if (qualityRate >= 85.5) return 0.68;
            if (qualityRate >= 85) return 0.66; if (qualityRate >= 84.5) return 0.64; if (qualityRate >= 84) return 0.62;
            if (qualityRate >= 83.5) return 0.60; if (qualityRate >= 83) return 0.57; if (qualityRate >= 82.5) return 0.55;
            if (qualityRate >= 82) return 0.50; if (qualityRate >= 81.5) return 0.45; if (qualityRate >= 81) return 0.40;
            if (qualityRate >= 80.5) return 0.35; if (qualityRate >= 80) return 0.30; if (qualityRate >= 79.5) return 0.25;
            if (qualityRate >= 79) return 0.20; if (qualityRate >= 78.5) return 0.15; if (qualityRate >= 78) return 0.10;
            if (qualityRate >= 77.5) return 0.05; return 0;
        }
        
        function createTableRow(tech, bonusMultiplier) {
            const denominator = tech.fixTasks + tech.refixTasks + tech.warnings.length;
            const fixQuality = denominator > 0 ? (tech.fixTasks / denominator) : 0;
            const qualityModifier = calculateQualityModifier(fixQuality * 100);
            const finalPayout = tech.points * bonusMultiplier * qualityModifier;
            const row = document.createElement('tr');
            row.className = "hover:bg-gray-700/50 transition-colors";
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">
                    ${tech.id}
                    <span class="info-icon tech-summary-icon" data-tech-id="${tech.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${tech.points.toFixed(3)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${(fixQuality * 100).toFixed(2)}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${(qualityModifier * 100).toFixed(0)}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-400">${finalPayout.toFixed(2)}</td>
            `;
            return row;
        }

        function parseRawData(data, isFixTaskIR = false, currentProjectName = "Pasted Data", gsdForCalculation = "3in") {
            const techStats = {};
            const lines = data.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 1) return null;

            const headers = lines.shift().split('\t').map(h => h.trim().toLowerCase());
            const headerMap = {};
            headers.forEach((h, i) => { headerMap[h] = i; });

            if (headerMap['combo?'] === undefined) {
                 alert("Critical column 'COMBO?' is missing.");
                 return null;
            }
            
            const summaryStats = { rv1CatCounts: {}, rv2CatCounts: {}, rv3CatCounts: {}, rv4CatCounts: {}, totalRows: 0, comboTasks: 0, totalIncorrect: 0, totalMiss: 0 };
            
            lines.forEach(line => {
                const values = line.split('\t');
                const isComboIR = values[headerMap['combo?']] === 'Y';
                if (isComboIR) summaryStats.comboTasks++;

                const allTechsInRow = new Set();
                ['fix1_id', 'fix2_id', 'fix3_id', 'fix4_id', 'qc1_id', 'qc2_id', 'i3qa_id', 'rv1_id', 'rv2_id'].forEach(col => {
                    const techId = values[headerMap[col]]?.trim();
                    if (techId) allTechsInRow.add(techId);
                });
                
                allTechsInRow.forEach(techId => {
                    if (!techStats[techId]) {
                        techStats[techId] = createNewTechStat();
                        techStats[techId].id = techId;
                    }
                });
                
                let totalRowFixPoints = 0;

                // New logic for category counting
                const fix1_id = values[headerMap['fix1_id']]?.trim();
                const fix2_id = values[headerMap['fix2_id']]?.trim();

                if (fix1_id && techStats[fix1_id]) {
                    // category
                    const category = parseInt(values[headerMap['category']]);
                    if (!isNaN(category)) {
                        techStats[fix1_id].categoryCounts[category]++;
                        totalRowFixPoints += categoryValues[category]?.[gsdForCalculation] || 0;
                    }

                    // i3qa_cat
                    const i3qa_label = values[headerMap['i3qa_label']]?.trim().toUpperCase();
                    if (i3qa_label === 'M' || i3qa_label === 'C') {
                        const i3qa_cat = parseInt(values[headerMap['i3qa_cat']]);
                        if (!isNaN(i3qa_cat)) {
                            techStats[fix1_id].categoryCounts[i3qa_cat]++;
                            totalRowFixPoints += categoryValues[i3qa_cat]?.[gsdForCalculation] || 0;
                        }
                    }

                    // afp1_cat
                    const afp1_stat = values[headerMap['afp1_stat']]?.trim().toUpperCase();
                    if (afp1_stat === 'AA') {
                        const afp1_cat = parseInt(values[headerMap['afp1_cat']]);
                        if (!isNaN(afp1_cat)) {
                            techStats[fix1_id].categoryCounts[afp1_cat]++;
                            totalRowFixPoints += categoryValues[afp1_cat]?.[gsdForCalculation] || 0;
                        }
                    }
                }

                if (fix2_id && techStats[fix2_id]) {
                    // rv1_cat
                    const rv1_label = values[headerMap['rv1_label']]?.trim().toUpperCase();
                    if (rv1_label === 'M') {
                        const rv1_cat = parseInt(values[headerMap['rv1_cat']]);
                        if (!isNaN(rv1_cat)) {
                            techStats[fix2_id].categoryCounts[rv1_cat]++;
                            totalRowFixPoints += categoryValues[rv1_cat]?.[gsdForCalculation] || 0;
                        }
                    }

                    // rv2_cat
                    const rv2_label = values[headerMap['rv2_label']]?.trim().toUpperCase();
                    if (rv2_label === 'M') {
                        const rv2_cat = parseInt(values[headerMap['rv2_cat']]);
                        if (!isNaN(rv2_cat)) {
                            techStats[fix2_id].categoryCounts[rv2_cat]++;
                            totalRowFixPoints += categoryValues[rv2_cat]?.[gsdForCalculation] || 0;
                        }
                    }

                    // afp2_cat
                    const afp2_stat = values[headerMap['afp2_stat']]?.trim().toUpperCase();
                    if (afp2_stat === 'AA') {
                        const afp2_cat = parseInt(values[headerMap['afp2_cat']]);
                        if (!isNaN(afp2_cat)) {
                            techStats[fix2_id].categoryCounts[afp2_cat]++;
                            totalRowFixPoints += categoryValues[afp2_cat]?.[gsdForCalculation] || 0;
                        }
                    }
                }

                if (isFixTaskIR && totalRowFixPoints > 0) {
                    totalRowFixPoints *= irModifierValue;
                }
                
                if (fix1_id && techStats[fix1_id]) {
                    techStats[fix1_id].points += totalRowFixPoints;
                    techStats[fix1_id].pointsBreakdown.fix += totalRowFixPoints;
                    techStats[fix1_id].fixTasks++;
                }

                // Points for other tasks (QC, i3qa, RV)
                ['qc1_id', 'qc2_id', 'i3qa_id', 'rv1_id', 'rv2_id'].forEach(colName => {
                     const techId = values[headerMap[colName]]?.trim();
                     if (techId && techStats[techId]) {
                         let points = 0;
                         if (colName.startsWith('qc')) { points = 1 / 8; techStats[techId].pointsBreakdown.qc += points; } 
                         else if (colName.startsWith('i3qa')) { points = 1 / 12; techStats[techId].pointsBreakdown.i3qa += points; } 
                         else if (colName.startsWith('rv')) {
                             if (colName === 'rv1_id') points = isComboIR ? 0.25 : 0.2;
                             else if (colName === 'rv2_id') points = 0.5;
                             techStats[techId].pointsBreakdown.rv += points;
                         }
                         techStats[techId].points += points;
                     }
                });

                // Warnings and Refixes
                ['r1_warn', 'r2_warn', 'r3_warn', 'r4_warn'].forEach((warnCol, index) => {
                    const warnValue = values[headerMap[warnCol]]?.trim().toUpperCase();
                    const validWarningLetters = ['B', 'C', 'D', 'E', 'F', 'G', 'I'];
                    if (warnValue && validWarningLetters.includes(warnValue)) {
                        const fixTechId = values[headerMap[`fix${index + 1}_id`]]?.trim();
                        if (fixTechId && techStats[fixTechId]) {
                            techStats[fixTechId].warnings.push({ type: warnValue, project: currentProjectName });
                        }
                    }
                });
                
                ['rv1_label', 'rv2_label', 'rv3_label', 'rv4_label'].forEach((rvLabelCol, index) => {
                     const rvLabelValue = values[headerMap[rvLabelCol]]?.trim().toUpperCase();
                     if (rvLabelValue && rvLabelValue.includes('I')) {
                         const fixTechId = values[headerMap[`fix${index + 2}_id`]]?.trim();
                         if (fixTechId && techStats[fixTechId]) {
                             techStats[fixTechId].refixTasks++;
                             const rvCat = values[headerMap[`rv${index + 1}_cat`]]?.trim();
                             techStats[fixTechId].refixDetails.push({ round: `RV${index + 1}`, project: currentProjectName, category: rvCat });
                         }
                     }
                });
            });

            return { techStats, summaryStats };
        }
        
        function renderTlSummary(stats, projectBreakdown = null) {
            const card = document.getElementById('tl-summary-card');
            const content = document.getElementById('tl-summary-content');
            if (!stats) return card.classList.remove('visible');
            
            const createRv3CategoryHtml = (title, counts) => {
                let html = `<details class="text-sm" open><summary class="font-semibold text-gray-200 cursor-pointer">${title}</summary>`;
                const sortedCats = Object.keys(counts).sort((a, b) => a - b);

                if (sortedCats.length > 0) {
                    html += '<div class="mt-2 border border-gray-700 rounded-lg overflow-hidden">';
                    sortedCats.forEach((cat, index) => {
                        const catData = counts[cat];
                        const bgColor = index % 2 === 0 ? 'bg-gray-700/50' : 'bg-gray-800/30';
                        const techEntries = Object.entries(catData.techs).sort((a,b) => a[0].localeCompare(b[0])).map(([techId, count]) => `<li class="text-xs flex justify-between"><span>- ${techId}</span><span class="font-mono">${count}</span></li>`).join('');
                        html += `<details class="text-sm ${bgColor}" open><summary class="p-2.5 cursor-pointer flex justify-between items-center border-b border-gray-700 last:border-b-0"><span class="text-gray-200">Category ${cat}:</span><span class="font-mono font-bold text-lg text-gray-100">${catData.total}</span></summary><div class="p-3 bg-gray-900/30"><ul class="pl-4 text-gray-300 space-y-1.5">${techEntries}</ul></div></details>`;
                    });
                    html += '</div>';
                } else html += '<p class="text-gray-500 text-sm italic mt-2 pl-4">No entries found.</p>';
                html += '</details>';
                return html;
            };
            
            content.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between items-baseline"><span class="text-gray-400">Total Category Instances:</span><span class="font-bold text-xl text-gray-100">${stats.totalRows}</span></div>
                    <div class="flex justify-between items-baseline"><span class="text-gray-400">Total "Incorrect":</span><span class="font-bold text-xl text-red-400">${stats.totalIncorrect}</span></div>
                    <div class="flex justify-between items-baseline"><span class="text-gray-400">Total "Miss":</span><span class="font-bold text-xl text-orange-400">${stats.totalMiss}</span></div>
                </div>
                <hr class="my-4 border-gray-700">
                ${createRv3CategoryHtml('RV3_CAT / Fix4 Breakdown', stats.rv3CatCounts)}
            `;
            
            if (projectBreakdown && projectBreakdown.length > 0) {
                let grandTotalPoints = 0, grandTotalCategories = 0;
                let breakdownHtml = `<details class="mt-6" open><summary class="font-semibold text-gray-200 cursor-pointer">Detailed Project Breakdown</summary><ul class="mt-2 border border-gray-700 rounded-lg divide-y divide-gray-700 text-sm overflow-hidden">`;
                projectBreakdown.forEach((proj, index) => {
                    grandTotalPoints += proj.points;
                    grandTotalCategories += proj.totalCategories;
                    const bgColor = index % 2 === 0 ? 'bg-gray-700/50' : 'bg-gray-800/30';
                    const irTag = proj.isIR ? '<span class="ml-2 text-xs font-semibold bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full">IR</span>' : '';
                    breakdownHtml += `<li class="p-3 flex justify-between items-center ${bgColor}"><span class="font-medium text-gray-300">${proj.name}${irTag}</span><div class="flex items-center space-x-4"><span class="text-gray-400 font-mono text-xs">${proj.totalCategories} cats</span><span class="font-mono font-medium text-gray-100">${proj.points.toFixed(3)} pts</span></div></li>`;
                });
                breakdownHtml += `</ul><div class="mt-3 p-3 bg-gray-700 rounded-lg flex justify-between font-bold text-base"><span>Grand Total:</span><div class="flex items-center space-x-4"><span class="text-gray-400 font-mono font-medium">${grandTotalCategories} cats</span><span class="font-mono text-gray-100">${grandTotalPoints.toFixed(3)} pts</span></div></div></details>`;
                content.insertAdjacentHTML('beforeend', breakdownHtml);
            }
            card.classList.add('visible');
        }

        function populateTeamFilters() {
            const container = document.getElementById('team-filter-container');
            while(container.children.length > 2) container.removeChild(container.lastChild);
            Object.keys(teamSettings).sort().forEach(teamName => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `<input id="team-filter-${teamName}" data-team-name="${teamName}" type="checkbox" class="h-4 w-4 text-indigo-500 focus:ring-indigo-600 bg-gray-700 border-gray-600 rounded"><label for="team-filter-${teamName}" class="ml-2 block text-sm text-gray-200">${teamName}</label>`;
                container.appendChild(div);
                div.querySelector('input').addEventListener('change', () => {
                    renderPerformanceMetrics(currentTechStats);
                    filterTable();
                });
            });
        }
        
        function addTeamToAdminUI(teamName, teamIds = []) {
            const container = document.getElementById('team-list-container');
            const teamDiv = document.createElement('div');
            teamDiv.className = 'p-4 border border-gray-700 rounded-lg bg-gray-800 team-definition';
            teamDiv.dataset.teamName = teamName;
            teamDiv.innerHTML = `<div class="flex justify-between items-center mb-2"><label class="font-semibold text-gray-200">${teamName}</label><button data-team-name="${teamName}" class="delete-team-btn font-bold text-red-400 hover:text-red-300 text-xl leading-none">&times;</button></div><textarea class="w-full p-2 border border-gray-600 rounded-md font-mono text-sm bg-gray-700 text-gray-200" rows="3" placeholder="tech1, tech2, tech3">${teamIds.join(', ')}</textarea>`;
            container.appendChild(teamDiv);
            teamDiv.querySelector('.delete-team-btn').addEventListener('click', (e) => {
                if (confirm(`Remove team "${teamName}" from the editor?`)) e.target.closest('.team-definition').remove();
            });
        }

        function populateAdminTeamManagement() {
            const container = document.getElementById('team-list-container');
            container.innerHTML = '';
            Object.keys(teamSettings).sort().forEach(teamName => addTeamToAdminUI(teamName, teamSettings[teamName]));
        }

        function filterTable() {
            const searchTerm = document.getElementById('search-tech-id').value.toUpperCase();
            const selectedTeams = Array.from(document.querySelectorAll('#team-filter-container input:checked')).map(cb => cb.dataset.teamName);
            let allowedTechIds = new Set();

            if (selectedTeams.length > 0) {
                selectedTeams.forEach(teamName => {
                    if (teamSettings[teamName]) teamSettings[teamName].forEach(techId => allowedTechIds.add(techId.toUpperCase()));
                });
            }

            const rows = document.getElementById('tech-results-body').rows;
            for (let i = 0; i < rows.length; i++) {
                const techId = rows[i].cells[0].textContent.trim().toUpperCase();
                rows[i].style.display = (searchTerm === "" || techId.includes(searchTerm)) && (selectedTeams.length === 0 || allowedTechIds.has(techId)) ? "" : "none";
            }
        }

        function openModal(key) {
            const modal = document.getElementById('info-modal');
            const info = calculationInfo[key];
            if (info) {
                document.getElementById('modal-title').innerHTML = info.title;
                document.getElementById('modal-body').innerHTML = info.body;
                modal.classList.remove('hidden');
            }
        }
        
        function openTechSummaryModal(techId) {
            const tech = currentTechStats[techId];
            if (!tech) return;

            const modal = document.getElementById('info-modal');
            const warningsCount = tech.warnings.length;
            const denominator = tech.fixTasks + tech.refixTasks + warningsCount;
            const fixQuality = denominator > 0 ? (tech.fixTasks / denominator) : 0;
            const qualityModifier = calculateQualityModifier(fixQuality * 100);
            const finalPayout = tech.points * lastUsedBonusMultiplier * qualityModifier;

            document.getElementById('modal-title').innerHTML = `Detailed Breakdown for Tech ID: <span class="text-blue-400">${techId}</span>`;
            
            const categoryColors = { 1: 'bg-teal-900/50 border-teal-700', 2: 'bg-cyan-900/50 border-cyan-700', 3: 'bg-sky-900/50 border-sky-700', 4: 'bg-indigo-900/50 border-indigo-700', 5: 'bg-purple-900/50 border-purple-700', 6: 'bg-pink-900/50 border-pink-700', 7: 'bg-rose-900/50 border-rose-700', 8: 'bg-amber-900/50 border-amber-700', 9: 'bg-lime-900/50 border-lime-700' };
            
            let categoryHtml = '';
            let totalCategoryCount = 0;
            const gsd = lastUsedGsdValue || '3in';

            for (let i = 1; i <= 9; i++) {
                const count = tech.categoryCounts[i];
                if (count > 0) {
                    totalCategoryCount += count;
                    const pointsPerCategory = categoryValues[i]?.[gsd] || 0;
                    categoryHtml += `<li class="flex justify-between p-1.5 rounded-md border text-gray-300 ${categoryColors[i]}"><span>Category ${i}:</span><span class="font-mono text-xs">${count} x ${pointsPerCategory.toFixed(2)} pts = ${(count * pointsPerCategory).toFixed(2)} pts</span></li>`;
                }
            }
            if (tech.pointsBreakdown.fix > 0) categoryHtml += `<li class="flex justify-between font-bold border-t-2 border-gray-600 pt-2 mt-2 bg-gray-700 p-2 rounded-md"><span>Total from Categories:</span><span class="font-mono">(${totalCategoryCount} tasks) ${tech.pointsBreakdown.fix.toFixed(2)} pts</span></li>`;
            if (!categoryHtml) categoryHtml = '<li>No primary fix tasks.</li>';

            const multiplierDisplay = lastCalculationUsedMultiplier ? `${lastUsedBonusMultiplier.toFixed(2)} (Multiplier)` : '1 (No Multiplier)';
            const warningsDetailHtml = tech.warnings.length > 0 ? `<ul class="list-disc list-inside text-xs text-gray-400 mt-1 space-y-0.5">${tech.warnings.map(w => `<li>Type: <span class="font-mono font-semibold">${w.type}</span> (Project: ${w.project})</li>`).join('')}</ul>` : `<p class="text-xs text-gray-500 italic mt-1 pl-4">No warnings.</p>`;
            const refixDetailHtml = tech.refixDetails.length > 0 ? `<ul class="list-disc list-inside text-xs text-gray-400 mt-1 space-y-0.5">${tech.refixDetails.map(r => `<li>Task: <span class="font-mono font-semibold">${r.round}</span> <span class="font-semibold text-red-400">(Cat: ${r.category})</span> (Project: ${r.project})</li>`).join('')}</ul>` : `<p class="text-xs text-gray-500 italic mt-1 pl-4">No refixes.</p>`;
            const visibleMisses = tech.missedCategories.filter(m => m.round.toLowerCase() !== 'i3qa');
            const missesDetailHtml = visibleMisses.length > 0 ? `<ul class="list-disc list-inside text-xs text-gray-400 mt-1 space-y-0.5">${visibleMisses.map(m => `<li>Task: <span class="font-mono font-semibold">${m.round}</span> <span class="font-semibold text-orange-400">(Cat: ${m.category})</span> (Project: ${m.project})</li>`).join('')}</ul>` : `<p class="text-xs text-gray-500 italic mt-1 pl-4">No misses.</p>`;
            const approvedByRQACount = tech.approvedByRQA.length;
            const approvedByRQADetailHtml = approvedByRQACount > 0 ? `<ul class="list-disc list-inside text-xs text-gray-400 mt-1 space-y-0.5">${tech.approvedByRQA.map(a => `<li>Task: <span class="font-mono font-semibold">${a.round}</span> <span class="font-semibold text-green-400">(Cat: ${a.category})</span> (Project: ${a.project})</li>`).join('')}</ul>` : `<p class="text-xs text-gray-500 italic mt-1 pl-4">No RQA approvals.</p>`;

            document.getElementById('modal-body').innerHTML = `<div class="space-y-4 text-sm">
                <div class="p-3 bg-gray-800 rounded-lg border border-gray-700"><h4 class="font-semibold text-base text-gray-200 mb-2">Core Stats</h4><div class="flex justify-between"><span class="text-gray-400">Primary Fix Tasks:</span><span class="font-bold">${tech.fixTasks}</span></div><div class="flex justify-between"><span class="text-gray-400">Refix Tasks:</span><span class="font-bold">${tech.refixTasks}</span></div>${refixDetailHtml}<div class="flex justify-between mt-2"><span class="text-gray-400">Misses (M):</span><span class="font-bold text-orange-400">${visibleMisses.length}</span></div>${missesDetailHtml}<div class="flex justify-between mt-2"><span class="text-gray-400">Approved by RQA (AA):</span><span class="font-bold text-green-400">${approvedByRQACount}</span></div>${approvedByRQADetailHtml}<div class="flex justify-between mt-2"><span class="text-gray-400">Warnings:</span><span class="font-bold text-red-400">${tech.warnings.length}</span></div>${warningsDetailHtml}<details class="mt-2 text-xs"><summary class="cursor-pointer font-medium text-gray-500">Show Primary Fix Category Counts</summary><ul class="mt-1 space-y-1 pl-2">${categoryHtml}</ul></details></div>
                <div class="p-3 bg-gray-800 rounded-lg border border-gray-700"><h4 class="font-semibold text-base text-gray-200 mb-2">Points Calculation</h4><div class="flex justify-between"><span class="text-gray-400">Points from Fix Tasks:</span><span class="font-mono">${tech.pointsBreakdown.fix.toFixed(3)}</span></div><div class="flex justify-between"><span class="text-gray-400">Points from QC Tasks:</span><span class="font-mono">${tech.pointsBreakdown.qc.toFixed(3)}</span></div><div class="flex justify-between"><span class="text-gray-400">Points from i3qa Tasks:</span><span class="font-mono">${tech.pointsBreakdown.i3qa.toFixed(3)}</span></div><div class="flex justify-between"><span class="text-gray-400">Points from RV Tasks:</span><span class="font-mono">${tech.pointsBreakdown.rv.toFixed(3)}</span></div><hr class="my-2 border-gray-600"><div class="flex justify-between font-bold"><span class="text-gray-200">Total Points:</span><span class="font-mono">${tech.points.toFixed(3)}</span></div></div>
                <div class="p-3 bg-gray-800 rounded-lg border border-gray-700"><h4 class="font-semibold text-base text-gray-200 mb-2">Quality Calculation</h4><p class="text-xs text-gray-500 mb-2">Formula: [Fix Tasks] / ([Fix Tasks] + [Refix Tasks] + [Warnings])</p><div class="p-2 bg-gray-900 rounded text-center font-mono"><code>${tech.fixTasks} / (${tech.fixTasks} + ${tech.refixTasks} + ${warningsCount}) = ${(fixQuality).toFixed(4)}</code></div><div class="flex justify-between font-bold"><span class="text-gray-200">Fix Quality %:</span><span class="font-mono">${(fixQuality * 100).toFixed(2)}%</span></div></div>
                <div class="p-3 bg-blue-900/30 rounded-lg border border-blue-700/50"><h4 class="font-semibold text-base text-blue-300 mb-2">Final Payout</h4><p class="text-xs text-gray-500 mt-2 mb-2">Formula: Total Points * Bonus Multiplier * % of Bonus Earned</p><div class="p-2 bg-gray-900 rounded text-center text-xs md:text-sm mb-2 font-mono"><code>${tech.points.toFixed(3)} * ${multiplierDisplay} * ${qualityModifier.toFixed(2)}</code></div><div class="flex justify-between font-bold text-lg"><span class="text-blue-200">Final Payout (PHP):</span><span class="text-blue-400 font-mono">${finalPayout.toFixed(2)}</span></div></div>
            </div>`;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('info-modal').classList.add('hidden');
        }

        function openReorderModal() {
            const reorderList = document.getElementById('reorder-list');
            reorderList.innerHTML = '';
            const sortedProjects = [...projectListCache].sort((a, b) => (a.projectOrder ?? Infinity) - (b.projectOrder ?? Infinity) || new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            sortedProjects.forEach(project => {
                const item = document.createElement('div');
                item.className = 'project-list-item';
                item.dataset.id = project.id;
                item.textContent = project.name;
                reorderList.appendChild(item);
            });
            reorderSortable = new Sortable(reorderList, { animation: 150, ghostClass: 'sortable-ghost' });
            document.getElementById('reorder-modal').classList.remove('hidden');
        }

        function closeReorderModal() {
            if (reorderSortable) { reorderSortable.destroy(); reorderSortable = null; }
            document.getElementById('reorder-modal').classList.add('hidden');
        }

        async function saveReorderModal() {
            if (!reorderSortable) return;
            const summaryRef = doc(db, "public_settings", "project_summary");
            const newOrderIds = reorderSortable.toArray();
            try {
                await runTransaction(db, async (transaction) => {
                    const summaryDoc = await transaction.get(summaryRef);
                    if (!summaryDoc.exists()) throw "Summary document not found!";
                    
                    let projectList = summaryDoc.data().projects || [];
                    const projectMap = new Map(projectList.map(p => [p.id, p]));
                    const reorderedList = newOrderIds.map((id, index) => {
                        const project = projectMap.get(id);
                        if (project) { project.projectOrder = index; return project; }
                    }).filter(Boolean);
                    transaction.set(summaryRef, { projects: reorderedList });
                });
                alert("Project order saved!");
                await fetchProjectListSummary();
                closeReorderModal();
            } catch (err) {
                console.error("Failed to save reorder:", err);
                alert("Error saving order.");
            }
        }
    </script>
</body>
</html>
