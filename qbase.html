<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team123 Advanced Bonus Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #tech-results-container, #admin-dashboard, #tl-summary-card {
             max-height: 0;
             overflow: hidden;
             opacity: 0;
             transition: all 0.5s ease-in-out;
        }
        #tech-results-container.visible, #admin-dashboard.visible, #tl-summary-card.visible {
            max-height: 1500px; /* Adjust as needed */
            opacity: 1;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .info-icon {
            cursor: pointer;
            display: inline-block;
            margin-left: 4px;
            color: #6b7280;
            vertical-align: middle;
        }
        .info-icon:hover {
            color: #1d4ed8;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        #modal-body {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 1rem; /* For scrollbar spacing */
        }
        .modal-overlay:not(.hidden) .modal-content {
            transform: scale(1);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        textarea:read-only {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        #update-notification {
            transition: opacity 0.5s, transform 0.5s;
        }
        /* Styles for the reorder modal list */
        #reorder-list .project-list-item {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            cursor: grab;
            margin-bottom: 0.25rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #c7d2fe;
        }
        /* Style for multi-select dropdown */
        select[multiple] {
            height: 10rem;
            background-color: white;
            padding: 0.5rem;
        }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::before {
            content: 'â–º';
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="update-notification" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2">
        Project list updated.
    </div>

    <div class="w-full max-w-screen-xl mx-auto p-4 md:p-8">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="p-6 md:p-8 bg-gray-800 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">Team123 Advanced Bonus Calculator</h1>
                    <p class="mt-2 text-gray-300">Save, load, and calculate bonuses for multiple projects.</p>
                </div>
                 <div class="flex gap-4">
                    <button id="how-it-works-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">How It Works</button>
                    <button id="admin-login-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-300 shadow-md">Admin Login</button>
                    <button id="logout-btn" class="hidden bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-300 shadow-md">Logout</button>
                </div>
            </div>

            <div id="main-grid" class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-5 gap-8">

                <div class="lg:col-span-2 space-y-6">
                     <div class="bg-gray-50 p-6 rounded-xl border">
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">Project Management</h2>
                            <div class="flex gap-2">
                                <button id="reorder-projects-btn" class="hidden bg-gray-200 text-gray-700 font-bold py-1 px-3 rounded-lg hover:bg-gray-300 transition-colors text-sm">Reorder</button>
                                <button id="refresh-projects-btn" title="Refresh Project List" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                                </button>
                            </div>
                        </div>
                        
                         <div class="flex items-center gap-2">
                            <select id="project-select" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all duration-300">
                                <option value="">Click Refresh to load projects...</option>
                            </select>
                             <button id="delete-project-btn" title="Delete Selected Project" class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-red-300 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                             </button>
                        </div>
                        <div class="mt-4">
                            <button id="calculateCurrentBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">
                                Calculate Selected Project
                            </button>
                        </div>
                         <div class="mt-4 border-t pt-4">
                             <div class="flex items-center">
                                <input id="customize-calc-all-cb" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="customize-calc-all-cb" class="ml-3 block text-sm font-medium text-gray-700">Select specific projects to calculate</label>
                            </div>
                            <button id="calculate-all-btn" class="mt-2 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300 shadow-md">Calculate All Projects</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-xl border">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Calculation Settings</h2>
                        <div>
                            <label for="bonusMultiplierDirect" class="block text-sm font-medium text-gray-600 mb-1">
                                Bonus Multiplier (PHP)
                                <span class="info-icon" data-key="bonusMultiplier">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                </span>
                            </label>
                            <input type="number" id="bonusMultiplierDirect" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Default: 1 (No multiplier)">
                        </div>
                    </div>
                     <div id="tl-summary-card" class="bg-gray-50 p-6 rounded-xl border">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">TL Summary</h2>
                        <div id="tl-summary-content" class="space-y-2 text-sm"></div>
                    </div>
                </div>

                <div id="project-data-entry" class="lg:col-span-3 space-y-6">
                    <div>
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">Project Data Entry</h2>
                            <button id="edit-data-btn" title="Edit Project Data" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>
                            </button>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-4">
                             <div class="flex items-center mb-2">
                                <input id="is-ir-project-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="is-ir-project-checkbox" class="ml-3 block text-sm font-medium text-yellow-800">
                                    Mark Project as IR (for Fix Tasks)
                                    <span class="block text-xs text-yellow-700">Applies 1.5x points multiplier to the sum of all categories in a Fix Task row.</span>
                                </label>
                            </div>
                            <div class="flex items-center">
                                <label for="gsd-value-select" class="block text-sm font-medium text-gray-700 mr-2">GSD Point Value:</label>
                                <select id="gsd-value-select" class="w-1/2 px-3 py-1 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                                    <option value="3in">3in Value</option>
                                    <option value="4in">4in Value</option>
                                    <option value="6in">6in Value</option>
                                    <option value="9in">9in Value</option>
                                </select>
                            </div>
                        </div>

                        <label for="techData" class="block text-sm font-medium text-gray-600 mb-2">Paste your raw, tab-separated project data here.</label>
                        <textarea id="techData" rows="12" class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-sm" placeholder="Paste all rows and columns from your project data..."></textarea>
                    </div>
                    <div class="flex gap-4">
                        <input type="text" id="project-name" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter Project Name to Save/Update">
                        <button id="save-project-btn" class="bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md whitespace-nowrap">Save Project</button>
                    </div>
                    <div class="mt-4">
                        <button id="calculatePastedDataBtn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300 shadow-md">
                            Calculate Pasted Data
                        </button>
                    </div>
                </div>
            </div>

            <div id="admin-dashboard" class="px-6 md:px-8 pb-8">
                <div class="border-t pt-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Admin Dashboard</h2>
                    <p class="text-sm text-gray-600 mb-4">As an admin, you can save and delete projects directly to the central database.</p>
                    
                    <div id="team-management-section" class="mt-6 border-t pt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Team Management</h3>
                        <p class="text-sm text-gray-600 mb-4">Define teams and assign Tech IDs. Paste a comma-separated list of IDs for each team. Click "Save Team Settings" to apply changes for all users.</p>
                        <div id="team-list-container" class="space-y-4">
                            </div>
                        <div class="mt-4 flex gap-4">
                            <input type="text" id="new-team-name" placeholder="New Team Name" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <button id="add-team-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 whitespace-nowrap">Add Team</button>
                        </div>
                        <div class="mt-6">
                            <button id="save-teams-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Save Team Settings</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tech-results-container" class="px-6 md:px-8 pb-8">
                 <h2 id="results-title" class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Technician Bonus Results</h2>
                 <div class="mb-4">
                    <label for="search-tech-id" class="block text-sm font-medium text-gray-700">Search by Tech ID</label>
                    <input type="text" id="search-tech-id" class="w-full md:w-1/3 mt-1 px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Search by Tech ID...">
                    
                    <div id="team-filter-container" class="mt-3 flex flex-wrap gap-x-6 gap-y-2 items-center border-t pt-3">
                         <span class="text-sm font-medium text-gray-700">Filter by Team:</span>
                         </div>
                 </div>
                 <div id="results-summary" class="text-sm text-gray-600 bg-blue-50 p-3 rounded-md mb-4"></div>
                 <div class="table-container border rounded-lg bg-white">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="results-thead" class="bg-gray-50 sticky top-0">
                            </thead>
                        <tbody id="tech-results-body" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                 </div>
            </div>
        </div>
        <p class="text-center text-xs text-gray-500 mt-4 px-4">Disclaimer: This calculator is based on the formulas and tables in the "Phili IC Fixpoints App Documentation v1.0".</p>
    </div>

    <div id="reorder-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Reorder Projects</h3>
            <p class="text-sm text-gray-500 mb-4">Drag and drop the projects to change their display order. Newest projects appear at the top by default.</p>
            <div id="reorder-list" class="space-y-2 h-64 overflow-y-auto p-2 border rounded-md">
                </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="reorder-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                <button id="reorder-save-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Save Order</button>
            </div>
        </div>
    </div>

    <div id="info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <div id="modal-body" class="text-gray-600 space-y-2"></div>
            <button id="modal-close" class="mt-6 w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Close</button>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- Your Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDMG_34ybAauTtXQH1s_NaJIeYyKPHW4Po",
            authDomain: "bunos-tracker.firebaseapp.com",
            projectId: "bunos-tracker",
            storageBucket: "bunos-tracker.appspot.com",
            messagingSenderId: "317849644629",
            appId: "1:317849644629:web:46ff71930b88f7646b2edc",
            measurementId: "G-SM4QHYHTYF"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        let savedProjects = {};
        let currentTechStats = {};
        let lastUsedBonusMultiplier = 1;
        let lastCalculationUsedMultiplier = false;
        let lastFilterValue = "";
        let isAdmin = false;
        let isEditMode = false;
        let teamSettings = {};
        let reorderSortable = null;

        // --- DATA FROM DOCUMENTATION ---
        const categoryValues = {
            1: { "3in": 2.19, "4in": 2.19, "6in": 2.19, "9in": 0.99, "IR": 1.5 },
            2: { "3in": 5.86, "4in": 5.86, "6in": 5.86, "9in": 2.07, "IR": 1.5 },
            3: { "3in": 7.44, "4in": 7.44, "6in": 7.44, "9in": 2.78, "IR": 1.5 },
            4: { "3in": 2.29, "4in": 2.29, "6in": 2.29, "9in": 1.57, "IR": 1.5 },
            5: { "3in": 1.55, "4in": 1.55, "6in": 1.55, "9in": 0.6, "IR": 1.5 },
            6: { "3in": 1.84, "4in": 1.84, "6in": 1.84, "9in": 0.78, "IR": 1.5 },
            7: { "3in": 1, "4in": 1, "6in": 1, "9in": 1, "IR": 1.5 },
            8: { "3in": 3.74, "4in": 3.74, "6in": 3.74, "9in": 3.74, "IR": 1.5 },
            9: { "3in": 1.73, "4in": 1.73, "6in": 1.73, "9in": 1.73, "IR": 1.5 }
        };

        const irModifierValue = 1.5;
        const calculationInfo = {
            howItWorks: {
                title: 'How It Works & How to Use',
                body: `<div class="space-y-6 text-sm">
                        <div>
                            <h4 class="text-lg font-bold text-gray-900 mb-2">How to Use This Site</h4>
                            <ol class="list-decimal list-inside space-y-2">
                                <li><strong>Load Projects:</strong> Click the "Refresh Projects" button (the circular arrow) to load the latest project list from the database. This is only needed once per session or when you want the latest data.</li>
                                <li><strong>Admin Login:</strong> Click 'Admin Login' and use credentials ('admin'/'admin123') to enter Admin Mode.</li>
                                <li><strong>Admin Mode:</strong> In this mode, you can create, save, delete, and reorder projects. You can also manage team assignments in the Admin Dashboard.</li>
                                <li><strong>Filtering:</strong> Use the search bar and the team checkboxes to filter the results table.</li>
                                <li><strong>Multi-Select:</strong> Check the "Select multiple projects" box to choose several projects at once for a combined calculation.</li>
                            </ol>
                        </div>
                        <hr>
                        <div>
                            <h4 class="text-lg font-bold text-gray-900 mb-2">How The Calculation Works</h4>
                            <p>The calculation logic is based on the data from the selected project(s) and follows the "Phili IC Fixpoints App Documentation v1.0".</p>
                        </div>
                       </div>`
            },
            bonusMultiplier: { title: 'Bonus Multiplier (PHP)', body: `<p>An optional multiplier for the final payout. Enter a number (e.g., 1.25 for a 25% bonus) to adjust the final calculated bonus for all technicians.</p>` },
            totalPoints: { title: 'Total Points Calculation', body: `<p>Points are calculated for each individual task based on its type (Fix, QC, i3qa, RV) and category, then summed for each technician.</p><p>For Fix tasks, points are derived from a table of category values. The GSD setting can change the points for certain categories. An "IR" project applies a 1.5x multiplier to the sum of all fix categories in a single task row.</p>`},
            fixQuality: { title: 'Fix Quality % Calculation', body: `<p>This measures a technician's accuracy. It's calculated using the formula: <code>[# of Fix Tasks] / ([# of Fix Tasks] + [# of Refix Tasks] + [# of Warnings])</code></p><p>A higher percentage indicates fewer errors.</p>`},
            bonusEarned: { title: '% of Bonus Earned Calculation', body: `<p>This percentage is determined by looking up the <strong>Fix Quality %</strong> in a tiered table. For example, a quality of 100% earns 100% of the bonus, while 82.5% earns 55%, and so on. Below 77.5%, no bonus is earned.</p>`},
            totalBonus: { title: 'Final Payout (PHP) Calculation', body: `<p>The final amount a technician receives. It's calculated with the formula: <code>Total Points * Bonus Multiplier * % of Bonus Earned</code></p>`}
        };

        function createNewTechStat() {
            return {
                id: '', points: 0, fixTasks: 0, refixTasks: 0, warnings: [],
                refixDetails: [],
                missedCategories: [],
                categoryCounts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 },
                pointsBreakdown: { fix: 0, qc: 0, i3qa: 0, rv: 0 }
            };
        }
        
        async function loadTeamSettings() {
            try {
                const teamDocRef = doc(db, "public_settings", "teams");
                const docSnap = await getDoc(teamDocRef);
                teamSettings = docSnap.exists() ? docSnap.data() : {};
            } catch (error) {
                console.error("Error loading team settings:", error);
                teamSettings = {};
            }
            populateTeamFilters();
            if (isAdmin) populateAdminTeamManagement();
        }

        async function saveTeamSettings(settings) {
            if (!isAdmin) return;
            try {
                await setDoc(doc(db, "public_settings", "teams"), settings);
                alert("Team settings saved successfully.");
                teamSettings = settings;
                populateTeamFilters();
            } catch (error) {
                console.error("Error saving team settings: ", error);
                alert("Failed to save team settings.");
            }
        }

        async function saveProjectToFirestore(projectData) {
            try {
                const textEncoder = new TextEncoder();
                const dataAsUint8Array = textEncoder.encode(projectData.rawData);
                const compressed = pako.deflate(dataAsUint8Array);
                const base64String = btoa(String.fromCharCode.apply(null, compressed));
                const dataToSave = { ...projectData, rawData: base64String };
                
                const projectRef = doc(db, "public_projects", projectData.id);
                await setDoc(projectRef, dataToSave);
                return true;
            } catch (error) {
                console.error("Error saving project to Firestore: ", error);
                alert("Failed to save project. The data might be too large or invalid.");
                return false;
            }
        }

        async function fetchProjectsManually() {
            const projectSelect = document.getElementById('project-select');
            projectSelect.innerHTML = '<option value="">Loading Projects...</option>';
            try {
                const projectsCol = collection(db, "public_projects");
                const snapshot = await getDocs(projectsCol);

                const loadedProjects = {};
                snapshot.forEach((doc) => {
                    const project = doc.data();
                    let decompressedData;
                    project.isCorrupted = false;
                    try {
                        const binaryString = atob(project.rawData);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        const decompressedUint8Array = pako.inflate(bytes);
                        decompressedData = new TextDecoder().decode(decompressedUint8Array);
                    } catch (e) {
                        console.error(`Decompression failed for project "${project.name}". Error: ${e.message}`);
                        decompressedData = "### DATA CORRUPTED ###\n\nThis project's data could not be read. An admin must re-save it with the correct data to fix this issue.";
                        project.isCorrupted = true;
                    }
                    project.rawData = decompressedData;
                    loadedProjects[doc.id] = project;
                });

                // Cache the fetched data
                sessionStorage.setItem('cachedProjects', JSON.stringify(loadedProjects));
                savedProjects = loadedProjects;
                updateProjectDropdown();
                showUpdateNotification();
            } catch (error) {
                console.error("Error fetching projects:", error);
                projectSelect.innerHTML = '<option value="">Error loading. Please Refresh.</option>';
                alert("Could not load projects from the database. Check console for errors.");
            }
        }
        
        async function deleteProjectFromFirestore(projectId) {
            try {
                await deleteDoc(doc(db, "public_projects", projectId));
                return true;
            } catch (error) {
                console.error("Error deleting project from Firestore: ", error);
                alert("Failed to delete project.");
                return false;
            }
        }

        function updateProjectDropdown() {
            const projectSelect = document.getElementById('project-select');
            const currentVal = projectSelect.value;
            projectSelect.innerHTML = '<option value="">Select a Project</option>';

            const sortedProjects = Object.values(savedProjects).sort((a, b) => {
                const orderA = a.projectOrder ?? Infinity;
                const orderB = b.projectOrder ?? Infinity;
                if (orderA !== orderB) return orderA - orderB;
                return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
            });
            
            sortedProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                const displayName = project.isCorrupted ? `${project.name} (Data Corrupted)` : (project.isIR ? `${project.name} (IR)` : project.name);
                option.textContent = displayName;
                if (project.isCorrupted) {
                    option.classList.add('text-red-500', 'font-bold');
                }
                projectSelect.appendChild(option);
            });

            if (savedProjects[currentVal]) {
                projectSelect.value = currentVal;
            }
            manageButtonState();
        }
        
        function manageButtonState() {
            const projectDataEntry = document.getElementById('project-data-entry');
            const mainGrid = document.getElementById('main-grid');
            const projectSelect = document.getElementById('project-select');
            const projectId = projectSelect.value;
            const techData = document.getElementById('techData');
            const calcPastedDataBtn = document.getElementById('calculatePastedDataBtn');
            const gsdValueSelect = document.getElementById('gsd-value-select');
            const reorderBtn = document.getElementById('reorder-projects-btn');

            projectDataEntry.classList.toggle('hidden', !isAdmin);
            mainGrid.classList.toggle('lg:grid-cols-1', !isAdmin);
            mainGrid.classList.toggle('lg:grid-cols-5', isAdmin);
            reorderBtn.classList.toggle('hidden', !isAdmin);
            
            document.getElementById('delete-project-btn').disabled = !isAdmin || !projectId;
            document.getElementById('edit-data-btn').classList.toggle('hidden', !isAdmin || !projectId);
            document.getElementById('save-project-btn').disabled = !isAdmin || (projectId && !isEditMode);
            techData.readOnly = !isAdmin || (projectId && !isEditMode);
            document.getElementById('is-ir-project-checkbox').disabled = !isAdmin;
            gsdValueSelect.disabled = !isAdmin;

            calcPastedDataBtn.disabled = techData.value.trim() === '';
        }
        
        async function handleAdminLogin() {
            const user = prompt("Enter Admin Username:");
            const pass = prompt("Enter Admin Password:");
            
            if (user === "admin" && pass === "admin123") {
                isAdmin = true;
                isEditMode = false;
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('admin-login-btn').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.add('visible');
                await loadTeamSettings();
                manageButtonState();
                alert("Admin Mode Activated.");
            } else if (user || pass) {
                alert("Incorrect username or password.");
            }
        }

        function handleLogout() {
            isAdmin = false;
            isEditMode = false;
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('admin-login-btn').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.remove('visible');
            manageButtonState();
            alert("You have been logged out.");
        }

        function showUpdateNotification() {
            const notification = document.getElementById('update-notification');
            if (notification.classList.contains('hidden')) {
                notification.classList.remove('hidden', 'opacity-0', 'translate-y-2');
                setTimeout(() => {
                    notification.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => notification.classList.add('hidden'), 500);
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check for cached data on load
            const cachedData = sessionStorage.getItem('cachedProjects');
            if (cachedData) {
                try {
                    savedProjects = JSON.parse(cachedData);
                    updateProjectDropdown();
                } catch (e) {
                    console.error("Failed to parse cached project data:", e);
                    sessionStorage.removeItem('cachedProjects');
                }
            }
            
            loadTeamSettings();
            manageButtonState();

            // Modal Handlers
            document.getElementById('reorder-projects-btn').addEventListener('click', openReorderModal);
            document.getElementById('reorder-cancel-btn').addEventListener('click', closeReorderModal);
            document.getElementById('reorder-save-btn').addEventListener('click', saveReorderModal);
            document.getElementById('reorder-modal').addEventListener('click', (e) => { if (e.target.id === 'reorder-modal') closeReorderModal(); });

            document.getElementById('add-team-btn').addEventListener('click', () => {
                if (!isAdmin) return;
                const newTeamNameInput = document.getElementById('new-team-name');
                const newTeamName = newTeamNameInput.value.trim();
                if (newTeamName && !document.querySelector(`.team-definition[data-team-name="${newTeamName}"]`)) {
                    addTeamToAdminUI(newTeamName);
                    newTeamNameInput.value = '';
                } else if (!newTeamName) {
                    alert('Please enter a team name.');
                } else {
                    alert('A team with this name already exists in the editor.');
                }
            });

            document.getElementById('save-teams-btn').addEventListener('click', () => {
                if (!isAdmin) return;
                const newTeamSettings = {};
                document.querySelectorAll('#team-list-container .team-definition').forEach(div => {
                    const teamName = div.dataset.teamName;
                    const techIds = div.querySelector('textarea').value.split(',').map(id => id.trim()).filter(Boolean);
                    newTeamSettings[teamName] = techIds;
                });
                saveTeamSettings(newTeamSettings);
            });

            document.getElementById('save-project-btn').addEventListener('click', async () => {
                if (!isAdmin) return;
                const projectName = document.getElementById('project-name').value.trim();
                const rawData = document.getElementById('techData').value.trim();
                const isIR = document.getElementById('is-ir-project-checkbox').checked;
                const gsdValue = document.getElementById('gsd-value-select').value;
                const projIdToSave = document.getElementById('project-select').value;

                if (projectName.length > 50) return alert("Project name cannot exceed 50 characters.");
                if (!projectName || !rawData) return alert("Please enter a project name and paste project data.");
                
                const id = (isEditMode && projIdToSave) ? projIdToSave : Date.now().toString();
                const existingProject = Object.values(savedProjects).find(p => p.id === id);

                const projectData = {
                    id: id,
                    name: projectName,
                    rawData: rawData,
                    isIR: isIR,
                    gsdValue: gsdValue,
                    createdAt: existingProject?.createdAt || new Date().toISOString(),
                    projectOrder: existingProject?.projectOrder ?? Object.keys(savedProjects).length
                };

                if (await saveProjectToFirestore(projectData)) {
                    alert(`Project "${projectName}" saved successfully.`);
                    // Manually update cache after saving
                    savedProjects[id] = projectData;
                    sessionStorage.setItem('cachedProjects', JSON.stringify(savedProjects));
                    updateProjectDropdown();
                    isEditMode = false;
                    document.getElementById('project-select').value = id;
                    manageButtonState();
                }
            });
            
            document.getElementById('delete-project-btn').addEventListener('click', async () => {
                if (!isAdmin) return;
                const projectId = document.getElementById('project-select').value;
                if (!projectId) return;
                
                const projectName = savedProjects[projectId].name;
                if (confirm(`Are you sure you want to delete the project "${projectName}"? This action cannot be undone.`)) {
                    if (await deleteProjectFromFirestore(projectId)) {
                        alert(`Project "${projectName}" has been deleted.`);
                        // Manually remove from cache
                        delete savedProjects[projectId];
                        sessionStorage.setItem('cachedProjects', JSON.stringify(savedProjects));
                        document.getElementById('techData').value = '';
                        document.getElementById('project-name').value = '';
                        updateProjectDropdown();
                    }
                }
            });
            
            document.getElementById('refresh-projects-btn').addEventListener('click', () => {
                sessionStorage.removeItem('cachedProjects');
                fetchProjectsManually();
            });

            document.getElementById('project-select').addEventListener('change', (e) => {
                const projectId = e.target.value;
                isEditMode = false;

                if (projectId && savedProjects[projectId]) {
                    const project = savedProjects[projectId];
                    document.getElementById('techData').value = project.rawData;
                    document.getElementById('project-name').value = project.name;
                    document.getElementById('is-ir-project-checkbox').checked = project.isIR || false;
                    document.getElementById('gsd-value-select').value = project.gsdValue || '3in';
                } else {
                    document.getElementById('techData').value = '';
                    document.getElementById('project-name').value = '';
                    document.getElementById('is-ir-project-checkbox').checked = false;
                    document.getElementById('gsd-value-select').value = '3in';
                }
                manageButtonState();
            });
            
            document.getElementById('edit-data-btn').addEventListener('click', () => {
                if (!isAdmin) return;
                isEditMode = true;
                manageButtonState();
                document.getElementById('techData').focus();
            });
            
            document.getElementById('calculateCurrentBtn').addEventListener('click', () => calculateAndRender(false));
            
            document.getElementById('calculate-all-btn').addEventListener('click', () => {
                const isCustomized = document.getElementById('customize-calc-all-cb').checked;
                if (isCustomized) {
                    const selectedProjectIds = [...document.getElementById('project-select').selectedOptions].map(opt => opt.value).filter(Boolean);
                    if (selectedProjectIds.length === 0) return alert('Please select one or more projects to calculate.');
                    calculateAndRender(true, selectedProjectIds);
                } else {
                    calculateAndRender(true, null);
                }
            });

            document.getElementById('customize-calc-all-cb').addEventListener('change', (e) => {
                const projectSelect = document.getElementById('project-select');
                const calcCurrentBtn = document.getElementById('calculateCurrentBtn');
                const calcAllBtn = document.getElementById('calculate-all-btn');

                if (e.target.checked) {
                    projectSelect.multiple = true;
                    projectSelect.size = 8;
                    calcCurrentBtn.disabled = true;
                    calcAllBtn.textContent = 'Calculate Checked Projects';
                } else {
                    projectSelect.multiple = false;
                    projectSelect.size = 1;
                    calcCurrentBtn.disabled = false;
                    calcAllBtn.textContent = 'Calculate All Projects';
                }
            });

            document.getElementById('calculatePastedDataBtn').addEventListener('click', calculatePastedData);
            document.getElementById('techData').addEventListener('input', manageButtonState);
            document.getElementById('search-tech-id').addEventListener('input', (e) => { lastFilterValue = e.target.value; filterTable(); });
            document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.body.addEventListener('click', (e) => {
                const icon = e.target.closest('.info-icon');
                if (icon) {
                    const key = icon.dataset.key;
                    const techId = icon.dataset.techId;
                    if (key) openModal(key);
                    else if (techId) openTechSummaryModal(techId);
                }
            });
            document.getElementById('how-it-works-btn').addEventListener('click', () => openModal('howItWorks'));
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('info-modal').addEventListener('click', (e) => { if (e.target.id === 'info-modal') closeModal(); });
        });

        function calculateAndRender(isAllProjects, projectIds = null) {
            let bonusMultiplier = 1;
            let isMultiplierUsed = false;
            const directMultiplierInput = document.getElementById('bonusMultiplierDirect').value;

            if (directMultiplierInput.trim() !== '') {
                const parsedMultiplier = parseFloat(directMultiplierInput);
                if (!isNaN(parsedMultiplier) && parsedMultiplier >= 0) {
                    bonusMultiplier = parsedMultiplier;
                    isMultiplierUsed = true;
                } else {
                    return alert("Bonus Multiplier must be a valid number.");
                }
            }
            
            lastUsedBonusMultiplier = bonusMultiplier;
            lastCalculationUsedMultiplier = isMultiplierUsed;
            const resultsTitleEl = document.getElementById('results-title');
            
            if (isAllProjects) {
                const projectsToCalc = projectIds ? projectIds.map(id => savedProjects[id]).filter(Boolean) : Object.values(savedProjects);
                const titleText = projectIds ? 'Selected Projects (Combined)' : 'All Projects (Combined)';
                resultsTitleEl.textContent = `${titleText} - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : ''}`;
                
                let combinedTechStats = {};
                let combinedSummaryStats = { allCategoryCounts: {}, totalRows: 0, comboTasks: 0 };
                const corruptedProjects = []; 
                
                projectsToCalc.forEach(project => {
                    if (project.isCorrupted) {
                        corruptedProjects.push(project.name);
                        return;
                    }
                    const gsdForCalculation = project.gsdValue || '3in'; 
                    const parsedData = parseRawData(project.rawData, project.isIR || false, project.name, gsdForCalculation); 
                    if (parsedData) {
                        for (const techId in parsedData.techStats) {
                            if (!combinedTechStats[techId]) combinedTechStats[techId] = createNewTechStat();
                            const combined = combinedTechStats[techId];
                            const single = parsedData.techStats[techId];
                            combined.id = techId;
                            combined.points += single.points;
                            combined.fixTasks += single.fixTasks;
                            combined.refixTasks += single.refixTasks;
                            combined.warnings.push(...single.warnings);
                            combined.refixDetails.push(...single.refixDetails);
                            combined.missedCategories.push(...single.missedCategories);
                            for (let i = 1; i <= 9; i++) combined.categoryCounts[i] += single.categoryCounts[i];
                            for (const type in single.pointsBreakdown) combined.pointsBreakdown[type] += single.pointsBreakdown[type];
                        }
                        combinedSummaryStats.totalRows += parsedData.summaryStats.totalRows;
                        combinedSummaryStats.comboTasks += parsedData.summaryStats.comboTasks;
                        for (const cat in parsedData.summaryStats.allCategoryCounts) {
                            combinedSummaryStats.allCategoryCounts[cat] = (combinedSummaryStats.allCategoryCounts[cat] || 0) + parsedData.summaryStats.allCategoryCounts[cat];
                        }
                    }
                });

                if (corruptedProjects.length > 0) {
                    alert(`Skipped corrupted projects:\n- ${corruptedProjects.join('\n- ')}`);
                }

                currentTechStats = combinedTechStats; 
                renderSingleProjectTable(currentTechStats, bonusMultiplier);
                renderTlSummary(combinedSummaryStats);
            } else {
                const projectId = document.getElementById('project-select').value;
                if (!projectId) return alert("Please select a project to calculate.");
                const project = savedProjects[projectId];
                if (project.isCorrupted) return alert(`Cannot calculate corrupted project "${project.name}".`);

                resultsTitleEl.textContent = `Project: ${project.name} - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : ''}`;
                const data = project.rawData;
                if (!data) return alert("Selected project has no data.");
                
                const gsdForCalculation = project.gsdValue || '3in';
                const parsedData = parseRawData(data, project.isIR, project.name, gsdForCalculation);
                if (parsedData) {
                    currentTechStats = parsedData.techStats;
                    renderSingleProjectTable(currentTechStats, bonusMultiplier);
                    renderTlSummary(parsedData.summaryStats);
                }
            }
            document.getElementById('tech-results-container').classList.add('visible');
            document.getElementById('tl-summary-card').classList.add('visible');
        }
        
        function calculatePastedData() {
            let bonusMultiplier = 1;
            let isMultiplierUsed = false;
            const directMultiplierInput = document.getElementById('bonusMultiplierDirect').value;

            if (directMultiplierInput.trim() !== '') {
                const parsedMultiplier = parseFloat(directMultiplierInput);
                if (!isNaN(parsedMultiplier) && parsedMultiplier >= 0) {
                    bonusMultiplier = parsedMultiplier;
                    isMultiplierUsed = true;
                } else {
                    return alert("Bonus Multiplier must be a valid number.");
                }
            }
            
            lastUsedBonusMultiplier = bonusMultiplier;
            lastCalculationUsedMultiplier = isMultiplierUsed;

            const resultsTitleEl = document.getElementById('results-title');
            const data = document.getElementById('techData').value.trim();
            const isProjectLevelIR = document.getElementById('is-ir-project-checkbox').checked;
            const gsdForCalculation = document.getElementById('gsd-value-select').value;

            if (!data) return alert("Please paste data into the text area before calculating.");

            resultsTitleEl.textContent = `Pasted Data - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : ''}`;
            
            const parsedData = parseRawData(data, isProjectLevelIR, 'Pasted Data', gsdForCalculation);
            if (parsedData) {
                currentTechStats = parsedData.techStats;
                renderSingleProjectTable(currentTechStats, bonusMultiplier);
                renderTlSummary(parsedData.summaryStats);
            }
            document.getElementById('tech-results-container').classList.add('visible');
            document.getElementById('tl-summary-card').classList.add('visible');
        }

        function renderSingleProjectTable(techStats, bonusMultiplier) {
            const resultsThead = document.getElementById('results-thead');
            const resultsBody = document.getElementById('tech-results-body');
            resultsBody.innerHTML = '';
            const infoIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>`;
            resultsThead.innerHTML = `
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tech ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Points <span class="info-icon" data-key="totalPoints">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fix Quality % <span class="info-icon" data-key="fixQuality">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% of Bonus Earned <span class="info-icon" data-key="bonusEarned">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Final Payout (PHP) <span class="info-icon" data-key="totalBonus">${infoIconSvg}</span></th>
                </tr>
            `;

            for (const techId in techStats) {
                const tech = techStats[techId];
                const row = createTableRow(tech, bonusMultiplier);
                row.dataset.techId = techId;
                resultsBody.appendChild(row);
            }

            filterTable();
        }
        
        function calculateQualityModifier(qualityRate) {
            if (qualityRate >= 100) return 1.0;
            if (qualityRate >= 82.5) return 0.55;
            if (qualityRate >= 82) return 0.50;
            if (qualityRate >= 81.5) return 0.45;
            if (qualityRate >= 81) return 0.40;
            if (qualityRate >= 80.5) return 0.35;
            if (qualityRate >= 80) return 0.30;
            if (qualityRate >= 79.5) return 0.25;
            if (qualityRate >= 79) return 0.20;
            if (qualityRate >= 78.5) return 0.15;
            if (qualityRate >= 78) return 0.10;
            if (qualityRate >= 77.5) return 0.05;
            return 0;
        }
        
        function createTableRow(tech, bonusMultiplier) {
            const denominator = tech.fixTasks + tech.refixTasks + tech.warnings.length;
            const fixQuality = denominator > 0 ? (tech.fixTasks / denominator) : 0;
            const qualityModifier = calculateQualityModifier(fixQuality * 100);
            const finalPayout = tech.points * bonusMultiplier * qualityModifier;
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${tech.id}
                    <span class="info-icon tech-summary-icon" data-tech-id="${tech.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tech.points.toFixed(3)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(fixQuality * 100).toFixed(2)}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(qualityModifier * 100).toFixed(0)}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">${finalPayout.toFixed(2)}</td>
            `;
            
            return row;
        }

        function parseRawData(data, isFixTaskIR = false, currentProjectName = "Pasted Data", gsdForCalculation = "3in") {
            const techStats = {};
            const lines = data.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 1) return null;

            const headerLine = lines.shift();
            const delimiter = '\t';
            const headers = headerLine.split(delimiter).map(h => h.trim().toLowerCase());
            
            const headerMap = {};
            headers.forEach((h, i) => { headerMap[h] = i; });

            if (headerMap['combo?'] === undefined) {
                 alert("Critical column 'COMBO?' is missing from the data header. Please ensure it is included.");
                 return null;
            }
            
            const summaryStats = {
                allCategoryCounts: {},
                totalRows: lines.length,
                comboTasks: 0
            };

            const techIdCols = headers.filter(h => h.endsWith('_id'));
            const warnCols = headers.filter(h => h.startsWith('r') && h.endsWith('_warn'));
            const catCols = headers.filter(h => h.endsWith('_cat') || h === 'category');

            lines.forEach(line => {
                const values = line.split(delimiter);
                const isComboIR = values[headerMap['combo?']] === 'Y';
                
                if (headerMap['combo?'] !== undefined && values[headerMap['combo?']]?.trim().toUpperCase() === 'Y') {
                    summaryStats.comboTasks++;
                }

                catCols.forEach(colName => {
                    const catIndex = headerMap[colName];
                    if (catIndex !== undefined) {
                        const catValue = values[catIndex]?.trim();
                        if (catValue && !isNaN(catValue) && catValue >= 1 && catValue <= 9) {
                            summaryStats.allCategoryCounts[catValue] = (summaryStats.allCategoryCounts[catValue] || 0) + 1;
                        }
                    }
                });
                
                const allTechsInRow = new Set(techIdCols.map(col => values[headerMap[col]]?.trim()).filter(Boolean));
                allTechsInRow.forEach(techId => {
                    if (!techStats[techId]) {
                        techStats[techId] = createNewTechStat();
                        techStats[techId].id = techId;
                    }
                });

                const missChecks = [
                    { label: 'i3qa_label', cat: 'i3qa_cat', fixId: 'fix1_id', round: 'i3qa' },
                    { label: 'rv1_label', cat: 'rv1_cat', fixId: 'fix2_id', round: 'RV1' },
                    { label: 'rv2_label', cat: 'rv2_cat', fixId: 'fix3_id', round: 'RV2' },
                    { label: 'rv3_label', cat: 'rv3_cat', fixId: 'fix4_id', round: 'RV3' },
                ];

                missChecks.forEach(check => {
                    const labelIndex = headerMap[check.label];
                    const catIndex = headerMap[check.cat];
                    const fixIdIndex = headerMap[check.fixId];

                    if (labelIndex !== undefined && catIndex !== undefined && fixIdIndex !== undefined) {
                        const labelValue = values[labelIndex]?.trim().toUpperCase();
                        if (labelValue && labelValue.includes('M')) {
                            const techId = values[fixIdIndex]?.trim();
                            if (techId && techStats[techId]) {
                                const categoryValue = parseInt(values[catIndex]);
                                if (!isNaN(categoryValue) && categoryValue >= 1 && categoryValue <= 9) {
                                    const catPoints = categoryValues[categoryValue]?.[gsdForCalculation] || categoryValues[categoryValue]?.["3in"] || 0;
                                    
                                    techStats[techId].points += catPoints;
                                    techStats[techId].pointsBreakdown.fix += catPoints;
                                    techStats[techId].fixTasks += 1; 
                                    
                                    techStats[techId].missedCategories.push({
                                        round: check.round.toUpperCase(),
                                        category: categoryValue,
                                        project: currentProjectName
                                    });
                                }
                            }
                        }
                    }
                });
                
                techIdCols.forEach(colName => {
                    const techId = values[headerMap[colName]]?.trim();
                    if (techId) {
                        let points = 0;
                        if (colName.startsWith('fix')) {
                            const roundMatch = colName.match(/\d+/);
                            if (roundMatch) {
                                const round = roundMatch[0];
                                const rvLabelColName = `rv${round}_label`;
                                const rvLabelIndex = headerMap[rvLabelColName];
                                let isIncorrect = false;

                                if (rvLabelIndex !== undefined) {
                                    const rvLabelValue = values[rvLabelIndex]?.trim().toUpperCase();
                                    if (rvLabelValue && rvLabelValue.includes('I')) {
                                        isIncorrect = true;
                                    }
                                }

                                if (isIncorrect) {
                                    const rvCatColName = `rv${round}_cat`;
                                    const rvCatIndex = headerMap[rvCatColName];
                                    const refixCategory = (rvCatIndex !== undefined && values[rvCatIndex]?.trim()) ? values[rvCatIndex].trim() : 'N/A';

                                    techStats[techId].refixTasks += 1;
                                    techStats[techId].refixDetails.push({
                                        round: `RV${round}`,
                                        project: currentProjectName,
                                        category: refixCategory
                                    });
                                } else {
                                    if (colName === 'fix1_id') {
                                        techStats[techId].fixTasks += 1;
                                        let totalRowFixPoints = 0;
                                        
                                        ['category', 'rv1_cat', 'rv2_cat'].forEach(catHeader => {
                                            if (headerMap[catHeader] !== undefined) {
                                                const categoryValue = parseInt(values[headerMap[catHeader]]);
                                                if (!isNaN(categoryValue) && categoryValue >= 1 && categoryValue <= 9) {
                                                    const catPoints = categoryValues[categoryValue]?.[gsdForCalculation] || categoryValues[categoryValue]?.["3in"] || 0;
                                                    if (techStats[techId].categoryCounts[categoryValue] !== undefined) techStats[techId].categoryCounts[categoryValue]++;
                                                    if (catPoints) totalRowFixPoints += catPoints;
                                                }
                                            }
                                        });

                                        ['afp1', 'afp2'].forEach(afp => {
                                            const statIndex = headerMap[`${afp}_stat`];
                                            const catIndex = headerMap[`${afp}_cat`];
                                            if (statIndex !== undefined && catIndex !== undefined && values[statIndex]?.trim().toUpperCase() === 'AA') {
                                                const catValue = parseInt(values[catIndex]);
                                                if (!isNaN(catValue) && catValue >= 1 && catValue <= 9) {
                                                    const catPoints = categoryValues[catValue]?.[gsdForCalculation] || categoryValues[catValue]?.["3in"] || 0;
                                                    if (techStats[techId].categoryCounts[catValue] !== undefined) techStats[techId].categoryCounts[catValue]++;
                                                    if (catPoints) totalRowFixPoints += catPoints;
                                                }
                                            }
                                        });

                                        if (isFixTaskIR && totalRowFixPoints > 0) {
                                            totalRowFixPoints *= irModifierValue;
                                        }

                                        techStats[techId].points += totalRowFixPoints;
                                        techStats[techId].pointsBreakdown.fix += totalRowFixPoints;
                                    }
                                }
                            }
                        } else if (colName.startsWith('qc')) {
                            points = 1 / 8;
                            techStats[techId].pointsBreakdown.qc += points;
                        } else if (colName.startsWith('i3qa')) {
                            points = 1 / 12;
                            techStats[techId].pointsBreakdown.i3qa += points;
                        } else if (colName.startsWith('rv')) {
                            if (colName === 'rv1_id') points = isComboIR ? (1/4) : (1/5);
                            else if (colName === 'rv2_id') points = 1/2;
                            techStats[techId].pointsBreakdown.rv += points;
                        }
                        
                        techStats[techId].points += points;
                    }
                });

                const validWarningLetters = ['B', 'C', 'D', 'E', 'F', 'G', 'I'];
                warnCols.forEach(colName => {
                    const warnValue = values[headerMap[colName]]?.trim().toUpperCase();
                    if (warnValue && validWarningLetters.includes(warnValue)) {
                        const round = colName.match(/\d+/)[0];
                        const fixTechId = values[headerMap[`fix${round}_id`]]?.trim();
                        if (fixTechId && techStats[fixTechId]) {
                            techStats[fixTechId].warnings.push({
                                type: warnValue,
                                project: currentProjectName
                            });
                        }
                    }
                });
            });
            return { techStats, summaryStats };
        }
        
        function renderTlSummary(stats) {
            const card = document.getElementById('tl-summary-card');
            const content = document.getElementById('tl-summary-content');

            if (!stats) {
                card.classList.remove('visible');
                return;
            }

            const createCategoryHtml = (title, counts) => {
                let html = `<details class="text-sm" open><summary class="cursor-pointer font-medium text-gray-700 mt-3">${title}</summary>`;
                const sortedCats = Object.keys(counts).sort((a, b) => a - b);

                if (sortedCats.length > 0) {
                    html += '<div class="mt-1 border rounded-md divide-y divide-gray-200">';
                    sortedCats.forEach((cat, index) => {
                        const bgColor = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                        html += `<div class="p-2 flex justify-between items-center ${bgColor}">
                                    <span class="text-gray-800">Category ${cat}:</span>
                                    <span class="font-mono font-medium text-gray-900">${counts[cat]}</span>
                                 </div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p class="text-gray-500 text-xs italic mt-1 pl-4">No entries found.</p>';
                }
                html += '</details>';
                return html;
            };
            
            const categoryHtml = createCategoryHtml('All Error Category Counts', stats.allCategoryCounts);

            content.innerHTML = `
                <div class="flex justify-between"><span class="text-gray-600">Total Data Rows Parsed:</span><span class="font-bold">${stats.totalRows}</span></div>
                <div class="flex justify-between"><span class="text-gray-600">"Combo?" (Y) Tasks:</span><span class="font-bold">${stats.comboTasks}</span></div>
                <hr class="my-2">
                ${categoryHtml}
            `;
            card.classList.add('visible');
        }

        function populateTeamFilters() {
            const container = document.getElementById('team-filter-container');
            while(container.children.length > 1) container.removeChild(container.lastChild);

            Object.keys(teamSettings).sort().forEach(teamName => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input id="team-filter-${teamName}" data-team-name="${teamName}" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="team-filter-${teamName}" class="ml-2 block text-sm text-gray-900">${teamName}</label>
                `;
                container.appendChild(div);
                div.querySelector('input').addEventListener('change', filterTable);
            });
        }
        
        function addTeamToAdminUI(teamName, teamIds = []) {
            const container = document.getElementById('team-list-container');
            const teamDiv = document.createElement('div');
            teamDiv.className = 'p-4 border rounded-lg bg-white team-definition';
            teamDiv.dataset.teamName = teamName;
            teamDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <label class="font-semibold text-gray-700">${teamName}</label>
                    <button data-team-name="${teamName}" class="delete-team-btn font-bold text-red-500 hover:text-red-700 text-xl leading-none">&times;</button>
                </div>
                <textarea class="w-full p-2 border rounded-md font-mono text-sm" rows="3" placeholder="tech1, tech2, tech3">${teamIds.join(', ')}</textarea>
            `;
            container.appendChild(teamDiv);
            teamDiv.querySelector('.delete-team-btn').addEventListener('click', (e) => {
                if (confirm(`Are you sure you want to remove team "${teamName}" from the editor? This will be finalized when you save.`)) {
                    e.target.closest('.team-definition').remove();
                }
            });
        }

        function populateAdminTeamManagement() {
            const container = document.getElementById('team-list-container');
            container.innerHTML = '';
            Object.keys(teamSettings).sort().forEach(teamName => {
                addTeamToAdminUI(teamName, teamSettings[teamName]);
            });
        }

        function filterTable() {
            const searchTerm = document.getElementById('search-tech-id').value.toUpperCase();
            const selectedTeams = Array.from(document.querySelectorAll('#team-filter-container input:checked')).map(cb => cb.dataset.teamName);
            let allowedTechIds = new Set();

            if (selectedTeams.length > 0) {
                selectedTeams.forEach(teamName => {
                    if (teamSettings[teamName]) {
                        teamSettings[teamName].forEach(techId => allowedTechIds.add(techId.toUpperCase()));
                    }
                });
            }

            const rows = document.getElementById('tech-results-body').getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const techIdCell = rows[i].getElementsByTagName('td')[0];
                if (techIdCell) {
                    const techId = (techIdCell.textContent || techIdCell.innerText).trim().toUpperCase();
                    const matchesSearch = searchTerm === "" || techId.includes(searchTerm);
                    const matchesTeam = selectedTeams.length === 0 || allowedTechIds.has(techId);
                    rows[i].style.display = (matchesSearch && matchesTeam) ? "" : "none";
                }
            }
        }

        function openModal(key) {
            const modal = document.getElementById('info-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const info = calculationInfo[key];
            if (info) {
                modalTitle.innerHTML = info.title;
                modalBody.innerHTML = info.body;
                modal.classList.remove('hidden');
            }
        }
        
        function openTechSummaryModal(techId) {
            const tech = currentTechStats[techId];
            if (!tech) return;

            const modal = document.getElementById('info-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            const warningsCount = tech.warnings.length;
            const denominator = tech.fixTasks + tech.refixTasks + warningsCount;
            const fixQuality = denominator > 0 ? (tech.fixTasks / denominator) : 0;
            const qualityModifier = calculateQualityModifier(fixQuality * 100);
            const finalPayout = tech.points * lastUsedBonusMultiplier * qualityModifier;

            modalTitle.innerHTML = `Detailed Breakdown for Tech ID: <span class="text-blue-600">${techId}</span>`;
            
            let categoryHtml = '';
            for (let i = 1; i <= 9; i++) {
                if (tech.categoryCounts[i] > 0) {
                     categoryHtml += `<li class="flex justify-between"><span>Category ${i}:</span> <span class="font-mono">${tech.categoryCounts[i]}</span></li>`;
                }
            }
            if (!categoryHtml) categoryHtml = '<li>No primary fix tasks recorded.</li>';

            if (tech.missedCategories.length > 0) {
                categoryHtml += `<li class="flex justify-between text-orange-600 font-semibold mt-2 pt-2 border-t"><span>Total Misses:</span> <span class="font-mono">${tech.missedCategories.length}</span></li>`;
            }

            let multiplierDisplay = lastCalculationUsedMultiplier ? `${lastUsedBonusMultiplier.toFixed(2)} (Multiplier)` : '1 (No Multiplier Applied)';

            let warningsDetailHtml = tech.warnings.length > 0
                ? `<ul class="list-disc list-inside text-xs text-gray-700 mt-1 space-y-0.5">${tech.warnings.map(w => `<li>Type: <span class="font-mono font-semibold">${w.type}</span> (Project: ${w.project})</li>`).join('')}</ul>`
                : `<p class="text-xs text-gray-500 italic mt-1 pl-4">No warnings recorded.</p>`;

            let refixDetailHtml = tech.refixDetails.length > 0
                ? `<ul class="list-disc list-inside text-xs text-gray-700 mt-1 space-y-0.5">${tech.refixDetails.map(r => `<li>Task: <span class="font-mono font-semibold">${r.round}</span> <span class="font-semibold text-red-600">(Cat: ${r.category})</span> (Project: ${r.project})</li>`).join('')}</ul>`
                : `<p class="text-xs text-gray-500 italic mt-1 pl-4">No refixes recorded.</p>`;
            
            let missesDetailHtml = tech.missedCategories.filter(m => m.round.toLowerCase() !== 'i3qa').length > 0
                ? `<ul class="list-disc list-inside text-xs text-gray-700 mt-1 space-y-0.5">${tech.missedCategories.filter(m => m.round.toLowerCase() !== 'i3qa').map(m => `<li>Task: <span class="font-mono font-semibold">${m.round}</span> <span class="font-semibold text-orange-600">(Cat: ${m.category})</span> (Project: ${m.project})</li>`).join('')}</ul>`
                : `<p class="text-xs text-gray-500 italic mt-1 pl-4">No misses recorded.</p>`;

            const bodyHtml = `<div class="space-y-4 text-sm">
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-base text-gray-800 mb-2">Core Stats</h4>
                    <div class="flex justify-between"><span class="text-gray-600">Primary Fix Tasks:</span><span class="font-bold">${tech.fixTasks}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Refix Tasks:</span><span class="font-bold">${tech.refixTasks}</span></div>
                    ${refixDetailHtml}
                    <div class="flex justify-between mt-2"><span class="text-gray-600">Misses (M):</span><span class="font-bold text-orange-600">${tech.missedCategories.length}</span></div>
                    ${missesDetailHtml}
                    <div class="flex justify-between mt-2"><span class="text-gray-600">Warnings:</span><span class="font-bold text-red-600">${tech.warnings.length}</span></div>
                    ${warningsDetailHtml}
                    <details class="mt-2 text-xs">
                        <summary class="cursor-pointer font-medium text-gray-500">Show Category Counts</summary>
                        <ul class="list-disc list-inside mt-1 space-y-1 pl-2">${categoryHtml}</ul>
                    </details>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-base text-gray-800 mb-2">Points Calculation</h4>
                    <div class="flex justify-between"><span class="text-gray-600">Points from Fix Tasks:</span><span class="font-mono">${tech.pointsBreakdown.fix.toFixed(3)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Points from QC Tasks:</span><span class="font-mono">${tech.pointsBreakdown.qc.toFixed(3)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Points from i3qa Tasks:</span><span class="font-mono">${tech.pointsBreakdown.i3qa.toFixed(3)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Points from RV Tasks:</span><span class="font-mono">${tech.pointsBreakdown.rv.toFixed(3)}</span></div>
                    <hr class="my-2">
                    <div class="flex justify-between font-bold"><span class="text-gray-800">Total Points:</span><span class="font-mono">${tech.points.toFixed(3)}</span></div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-base text-gray-800 mb-2">Quality Calculation</h4>
                     <p class="text-xs text-gray-500 mb-2">Formula: [Fix Tasks] / ([Fix Tasks] + [Refix Tasks] + [Warnings])</p>
                    <div class="p-2 bg-white rounded text-center"><code>${tech.fixTasks} / (${tech.fixTasks} + ${tech.refixTasks} + ${warningsCount}) = ${(fixQuality).toFixed(4)}</code></div>
                    <div class="flex justify-between font-bold"><span class="text-gray-800">Fix Quality %:</span><span class="font-mono">${(fixQuality * 100).toFixed(2)}%</span></div>
                </div>
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 class="font-semibold text-base text-blue-800 mb-2">Final Payout</h4>
                    <p class="text-xs text-gray-500 mt-2 mb-2">Formula: Total Points * Bonus Multiplier * % of Bonus Earned</p>
                    <div class="p-2 bg-white rounded text-center text-xs md:text-sm mb-2"><code>${tech.points.toFixed(3)} (Points) * ${multiplierDisplay} * ${qualityModifier.toFixed(2)} (Earned)</code></div>
                    <div class="flex justify-between font-bold text-lg"><span class="text-blue-900">Final Payout (PHP):</span><span class="text-blue-600 font-mono">${finalPayout.toFixed(2)}</span></div>
                </div>
            </div>`;

            modalBody.innerHTML = bodyHtml;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('info-modal').classList.add('hidden');
        }

        function openReorderModal() {
            const reorderList = document.getElementById('reorder-list');
            reorderList.innerHTML = '';

            const sortedProjects = Object.values(savedProjects).sort((a, b) => {
                const orderA = a.projectOrder ?? Infinity;
                const orderB = b.projectOrder ?? Infinity;
                if (orderA !== orderB) return orderA - orderB;
                return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
            });

            sortedProjects.forEach(project => {
                const item = document.createElement('div');
                item.className = 'project-list-item';
                item.dataset.id = project.id;
                item.textContent = project.name;
                reorderList.appendChild(item);
            });
            
            reorderSortable = new Sortable(reorderList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
            });
            
            document.getElementById('reorder-modal').classList.remove('hidden');
        }

        function closeReorderModal() {
            if (reorderSortable) {
                reorderSortable.destroy();
                reorderSortable = null;
            }
            document.getElementById('reorder-modal').classList.add('hidden');
        }

        async function saveReorderModal() {
            if (!reorderSortable) return;
            const items = Array.from(document.getElementById('reorder-list').children);
            const batch = writeBatch(db);
            items.forEach((item, index) => {
                const projectId = item.dataset.id;
                const projectRef = doc(db, "public_projects", projectId);
                batch.update(projectRef, { projectOrder: index });
            });
            
            try {
                await batch.commit();
                alert("Project order saved successfully!");
                // Manually re-fetch to update cache and UI with new order
                await fetchProjectsManually();
                closeReorderModal();
            } catch (err) {
                console.error("Failed to save new project order:", err);
                alert("Error saving the new order.");
            }
        }

    </script>
</body>
</html>
