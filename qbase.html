<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phili Fixpoint Advanced Bonus Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #tech-results-container, #admin-dashboard {
             max-height: 0;
             overflow: hidden;
             opacity: 0;
             transition: all 0.5s ease-in-out;
        }
        #tech-results-container.visible, #admin-dashboard.visible {
            max-height: 1500px; /* Adjust as needed */
            opacity: 1;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .info-icon {
            cursor: pointer;
            display: inline-block;
            margin-left: 4px;
            color: #6b7280;
            vertical-align: middle;
        }
        .info-icon:hover {
            color: #1d4ed8;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay:not(.hidden) .modal-content {
            transform: scale(1);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        textarea:read-only {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="w-full max-w-screen-xl mx-auto p-4 md:p-8">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="p-6 md:p-8 bg-gray-800 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">Phili Fixpoint Advanced Bonus Calculator</h1>
                    <p class="mt-2 text-gray-300">Save, load, and calculate bonuses for multiple projects.</p>
                </div>
                 <div class="flex gap-4">
                    <button id="how-it-works-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">How It Works</button>
                    <button id="admin-login-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-300 shadow-md">Admin Login</button>
                    <button id="logout-btn" class="hidden bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-300 shadow-md">Logout</button>
                </div>
            </div>

            <div class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-5 gap-8">

                <div class="lg:col-span-2 space-y-6">
                     <div class="bg-gray-50 p-6 rounded-xl border">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Project Management</h2>
                        <div class="mb-4">
                             <button id="load-public-projects-btn" class="w-full bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-cyan-700 transition-colors">
                                Load Public Projects
                            </button>
                        </div>
                         <div class="flex items-center gap-2">
                            <select id="project-select" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="">Select a Project</option>
                            </select>
                             <button id="delete-project-btn" title="Delete Selected Project" class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-red-300 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                             </button>
                        </div>
                        <div class="mt-4">
                            <button id="calculate-all-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300 shadow-md">Calculate All Projects (Combined)</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-xl border">
                        <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Calculation Settings</h2>
                        <div>
                            <label for="bonusMultiplierDirect" class="block text-sm font-medium text-gray-600 mb-1">
                                Bonus Multiplier (PHP)
                                <span class="info-icon" data-key="bonusMultiplier">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                </span>
                            </label>
                            <input type="number" id="bonusMultiplierDirect" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Default: 1 (No multiplier)">
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-3 space-y-6">
                    <div>
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h2 class="text-xl font-semibold text-gray-800">Project Data Entry</h2>
                            <button id="edit-data-btn" title="Edit Project Data" class="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>
                            </button>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-4">
                             <div class="flex items-center">
                                <input id="is-ir-project-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="is-ir-project-checkbox" class="ml-3 block text-sm font-medium text-yellow-800">
                                    Mark Project as IR (for Fix Tasks)
                                    <span class="block text-xs text-yellow-700">Applies 1.5x points multiplier to the sum of all categories in a Fix Task row.</span>
                                </label>
                            </div>
                        </div>

                        <label for="techData" class="block text-sm font-medium text-gray-600 mb-2">Paste your raw, tab-separated project data here.</label>
                        <textarea id="techData" rows="12" class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-sm" placeholder="Paste all rows and columns from your project data..."></textarea>
                    </div>
                    <div class="flex gap-4">
                        <input type="text" id="project-name" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter Project Name to Save/Update">
                        <button id="save-project-btn" class="bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md whitespace-nowrap">Save Project</button>
                    </div>
                    <button id="calculateCurrentBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">
                        Calculate Current Project
                    </button>
                </div>
            </div>

            <div id="admin-dashboard" class="hidden px-6 md:px-8 pb-8">
                <div class="border-t pt-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Admin Dashboard</h2>
                    <p class="text-sm text-gray-600 mb-4">As an admin, you can save and delete projects. Use the 'Publish' button to make your local project list available to all users.</p>
                    <div class="flex gap-4">
                         <button id="admin-publish-btn" class="bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300 shadow-md">
                            Publish All Projects
                        </button>
                    </div>
                </div>
            </div>

            <div id="tech-results-container" class="px-6 md:px-8 pb-8">
                 <h2 id="results-title" class="text-xl font-semibold text-gray-800 border-b pb-3 mb-4">Technician Bonus Results</h2>
                 <div class="mb-4">
                    <input type="text" id="search-tech-id" class="w-full md:w-1/3 px-4 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Search by Tech ID...">
                 </div>
                 <div id="results-summary" class="text-sm text-gray-600 bg-blue-50 p-3 rounded-md mb-4"></div>
                 <div class="table-container border rounded-lg bg-white">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="results-thead" class="bg-gray-50 sticky top-0">
                            </thead>
                        <tbody id="tech-results-body" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                 </div>
            </div>
        </div>
        <p class="text-center text-xs text-gray-500 mt-4 px-4">Disclaimer: This calculator is based on the formulas and tables in the "Phili IC Fixpoints App Documentation v1.0".</p>
    </div>

    <div id="info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <div id="modal-body" class="text-gray-600 space-y-2"></div>
            <button id="modal-close" class="mt-6 w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Close</button>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- Your Firebase Configuration ---
        // REPLACE THE PLACEHOLDER VALUES BELOW WITH YOUR ACTUAL FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDMG_34ybAauTtXQH1s_NaJIeYyKPHW4Po",
            authDomain: "bunos-tracker.firebaseapp.com",
            projectId: "bunos-tracker",
            storageBucket: "bunos-tracker.appspot.com",
            messagingSenderId: "317849644629",
            appId: "1:317849644629:web:46ff71930b88f7646b2edc",
            measurementId: "G-SM4QHYHTYF"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        let savedProjects = {}; 
        let currentTechStats = {}; 
        let lastUsedBonusMultiplier = 1; 
        let lastCalculationUsedMultiplier = false;
        let lastFilterValue = ""; 
        let isAdmin = false; 

        // --- DATA FROM DOCUMENTATION ---
        const categoryValues = { 1: { points: 2.19 }, 2: { points: 5.86 }, 3: { points: 7.44 }, 4: { points: 2.29 }, 5: { points: 1.55 }, 6: { points: 1.84 }, 7: { points: 1.00 }, 8: { points: 3.74 }, 9: { points: 1.73 } };
        const irModifierValue = 1.5;
        const calculationInfo = {
            howItWorks: {
                title: 'How It Works & How to Use',
                body: `<div class="space-y-6 text-sm">
                        <div>
                            <h4 class="text-lg font-bold text-gray-900 mb-2">How to Use This Site</h4>
                            <ol class="list-decimal list-inside space-y-2">
                                <li><strong>Client View (Default):</strong> Click 'Load Public Projects' to fetch the project list from the central database.</li>
                                <li><strong>Admin Login:</strong> Click 'Admin Login' and use credentials ('admin'/'admin123') to enter Admin Mode.</li>
                                <li><strong>Admin Mode:</strong> In this mode, you can create, save, and delete projects. These actions modify the central database directly.</li>
                            </ol>
                        </div>
                        <hr>
                        <div>
                            <h4 class="text-lg font-bold text-gray-900 mb-2">How The Calculation Works</h4>
                            <p>The calculation logic is based on the data from the selected project.</p>
                        </div>
                       </div>`
            },
            bonusMultiplier: { title: 'Bonus Multiplier (PHP)', body: `<p>An optional multiplier for the final payout.</p>` },
            totalPoints: { title: 'Total Points Calculation', body: `<p>Points are calculated for each individual task and then summed for each technician.</p>`},
            fixQuality: { title: 'Fix Quality % Calculation', body: `<p>Calculated using the formula: <code>[# of Fix Tasks] / ([# of Fix Tasks] + [# of Refix Tasks] + [# of Warnings])</code></p>`},
            bonusEarned: { title: '% of Bonus Earned Calculation', body: `<p>This percentage is determined by looking up the <strong>Fix Quality %</strong> in a tiered table.</p>`},
            totalBonus: { title: 'Final Payout (PHP) Calculation', body: `<p>Calculated with the formula: <code>Total Points * Bonus Multiplier * % of Bonus Earned</code></p>`}
        };

        function createNewTechStat() {
            return {
                id: '', points: 0, fixTasks: 0, refixTasks: 0, warnings: 0,
                categoryCounts: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 },
                pointsBreakdown: { fix: 0, qc: 0, i3qa: 0, rv: 0 }
            };
        }
        
        // --- Firestore Functions ---
        async function saveProjectToFirestore(projectData) {
            try {
                const projectRef = doc(db, "public_projects", projectData.id);
                await setDoc(projectRef, projectData);
                return true;
            } catch (error) {
                console.error("Error saving project to Firestore: ", error);
                alert("Failed to save project.");
                return false;
            }
        }

        async function loadProjectsFromFirestore() {
            try {
                const projectsCol = collection(db, "public_projects");
                const projectSnapshot = await getDocs(projectsCol);
                const loadedProjects = {};
                projectSnapshot.forEach((doc) => {
                    loadedProjects[doc.id] = doc.data();
                });
                return loadedProjects;
            } catch (error) {
                console.error("Error loading projects from Firestore: ", error);
                alert("Failed to load public projects.");
                return {};
            }
        }

        async function deleteProjectFromFirestore(projectId) {
            try {
                await deleteDoc(doc(db, "public_projects", projectId));
                return true;
            } catch (error) {
                console.error("Error deleting project from Firestore: ", error);
                alert("Failed to delete project.");
                return false;
            }
        }

        function updateProjectDropdown() {
            const projectSelect = document.getElementById('project-select');
            const currentVal = projectSelect.value;
            projectSelect.innerHTML = '<option value="">Select a Project</option>';
            for (const id in savedProjects) {
                const project = savedProjects[id];
                const option = document.createElement('option');
                option.value = id;
                const displayName = project.isIR ? `${project.name} (IR)` : project.name;
                option.textContent = displayName;
                projectSelect.appendChild(option);
            }
            projectSelect.value = currentVal;
            manageButtonState();
        }
        
        function manageButtonState() {
            document.getElementById('delete-project-btn').disabled = !isAdmin;
            document.getElementById('save-project-btn').disabled = !isAdmin;
            document.getElementById('edit-data-btn').classList.toggle('hidden', !isAdmin);
            document.getElementById('techData').readOnly = !isAdmin;
        }
        
        function handleAdminLogin() {
            const user = prompt("Enter Admin Username:");
            const pass = prompt("Enter Admin Password:");
            
            if (user === "admin" && pass === "admin123") {
                isAdmin = true;
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('admin-login-btn').classList.add('hidden');
                document.getElementById('load-public-projects-btn').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.add('visible');
                manageButtonState();
                alert("Admin Mode Activated. You can now save and delete projects directly from the central database.");
            } else {
                alert("Incorrect username or password.");
            }
        }

        function handleLogout() {
            isAdmin = false;
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('admin-login-btn').classList.remove('hidden');
            document.getElementById('load-public-projects-btn').classList.remove('hidden');
            document.getElementById('admin-dashboard').classList.remove('visible');
            savedProjects = {};
            updateProjectDropdown();
            manageButtonState();
            alert("You have been logged out.");
        }

        document.addEventListener('DOMContentLoaded', () => {
            manageButtonState();

            document.getElementById('save-project-btn').addEventListener('click', async () => {
                if (!isAdmin) {
                    alert("Only admins can save projects.");
                    return;
                }
                const projectName = document.getElementById('project-name').value.trim();
                const rawData = document.getElementById('techData').value.trim();
                const isIR = document.getElementById('is-ir-project-checkbox').checked;

                if (!projectName || !rawData) {
                    alert("Please enter a project name and paste project data before saving/updating.");
                    return;
                }
                
                let projectId = document.getElementById('project-select').value || Date.now().toString();
                
                const projectData = {
                    id: projectId,
                    name: projectName,
                    rawData: rawData,
                    isIR: isIR,
                    createdAt: savedProjects[projectId]?.createdAt || new Date().toISOString()
                };

                const success = await saveProjectToFirestore(projectData);
                if(success) {
                    savedProjects[projectId] = projectData;
                    updateProjectDropdown();
                    document.getElementById('project-select').value = projectId;
                    alert(`Project "${projectName}" saved successfully to Firestore.`);
                }
            });
            
            document.getElementById('delete-project-btn').addEventListener('click', async () => {
                 if (!isAdmin) return;
                const projectId = document.getElementById('project-select').value;
                if (!projectId) { return; }
                
                const projectName = savedProjects[projectId].name;
                if (confirm(`Are you sure you want to delete the project "${projectName}"? This action cannot be undone.`)) {
                    const success = await deleteProjectFromFirestore(projectId);
                    if (success) {
                        delete savedProjects[projectId];
                        document.getElementById('techData').value = '';
                        document.getElementById('project-name').value = '';
                        document.getElementById('is-ir-project-checkbox').checked = false;
                        lastFilterValue = "";
                        updateProjectDropdown();
                        alert(`Project "${projectName}" has been deleted.`);
                    }
                }
            });

            document.getElementById('project-select').addEventListener('change', (e) => {
                const projectId = e.target.value;
                const irCheckbox = document.getElementById('is-ir-project-checkbox');

                if (projectId && savedProjects[projectId]) {
                    const project = savedProjects[projectId];
                    document.getElementById('techData').value = project.rawData;
                    document.getElementById('project-name').value = project.name;
                    irCheckbox.checked = project.isIR || false;
                } else {
                    document.getElementById('techData').value = '';
                    document.getElementById('project-name').value = '';
                    irCheckbox.checked = false;
                    lastFilterValue = "";
                }
            });
            
            document.getElementById('edit-data-btn').addEventListener('click', () => {
                 if (!isAdmin) return;
                const techDataTextarea = document.getElementById('techData');
                techDataTextarea.readOnly = false;
                techDataTextarea.focus();
            });
            
            document.getElementById('load-public-projects-btn').addEventListener('click', async () => {
                savedProjects = await loadProjectsFromFirestore();
                updateProjectDropdown();
                alert(`${Object.keys(savedProjects).length} public projects loaded.`);
            });
            
            document.getElementById('calculateCurrentBtn').addEventListener('click', () => calculateAndRender(false));
            document.getElementById('calculate-all-btn').addEventListener('click', () => calculateAndRender(true));
            document.getElementById('search-tech-id').addEventListener('input', (e) => {
                lastFilterValue = e.target.value;
                filterTable();
            });
            
            document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('admin-publish-btn').addEventListener('click', () => {
                alert("This feature is a placeholder. A developer would implement a cloud function to sync data securely.");
            });

            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.info-icon')) {
                    const icon = e.target.closest('.info-icon');
                    const key = icon.dataset.key;
                    const techId = icon.dataset.techId;
                    if (key) {
                        openModal(key);
                    } else if (techId) {
                        openTechSummaryModal(techId);
                    }
                }
            });

            document.getElementById('how-it-works-btn').addEventListener('click', () => openModal('howItWorks'));
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('info-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('info-modal')) {
                    closeModal();
                }
            });
        });

        function calculateAndRender(isAllProjects) {
            let bonusMultiplier = 1;
            let isMultiplierUsed = false;
            const directMultiplierInput = document.getElementById('bonusMultiplierDirect').value;

            if (directMultiplierInput.trim() !== '') {
                const parsedMultiplier = parseFloat(directMultiplierInput);
                if (!isNaN(parsedMultiplier) && parsedMultiplier >= 0) {
                    bonusMultiplier = parsedMultiplier;
                    isMultiplierUsed = true;
                } else {
                    alert("Bonus Multiplier must be a valid number.");
                    return;
                }
            }
            
            lastUsedBonusMultiplier = bonusMultiplier;
            lastCalculationUsedMultiplier = isMultiplierUsed;

            const resultsTitleEl = document.getElementById('results-title');
            
            if (isAllProjects) {
                resultsTitleEl.textContent = `All Projects (Combined) - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : '(No Multiplier Applied)'}`;
                let combinedTechStats = {};
                
                for (const projectId in savedProjects) {
                    const project = savedProjects[projectId];
                    const parsedData = parseRawData(project.rawData, project.isIR || false); 
                    if (parsedData) {
                        for (const techId in parsedData.techStats) {
                            const singleProjectTechStats = parsedData.techStats[techId];
                            if (!combinedTechStats[techId]) {
                                combinedTechStats[techId] = createNewTechStat();
                                combinedTechStats[techId].id = techId;
                            }
                            combinedTechStats[techId].points += singleProjectTechStats.points;
                            combinedTechStats[techId].fixTasks += singleProjectTechStats.fixTasks;
                            combinedTechStats[techId].refixTasks += singleProjectTechStats.refixTasks;
                            combinedTechStats[techId].warnings += singleProjectTechStats.warnings;
                            for (let i = 1; i <= 9; i++) {
                                combinedTechStats[techId].categoryCounts[i] += singleProjectTechStats.categoryCounts[i];
                            }
                            combinedTechStats[techId].pointsBreakdown.fix += singleProjectTechStats.pointsBreakdown.fix;
                            combinedTechStats[techId].pointsBreakdown.qc += singleProjectTechStats.pointsBreakdown.qc;
                            combinedTechStats[techId].pointsBreakdown.i3qa += singleProjectTechStats.pointsBreakdown.i3qa;
                            combinedTechStats[techId].pointsBreakdown.rv += singleProjectTechStats.pointsBreakdown.rv;
                        }
                    }
                }
                currentTechStats = combinedTechStats; 
                renderSingleProjectTable(currentTechStats, bonusMultiplier);
            } else {
                const isProjectLevelIR = document.getElementById('is-ir-project-checkbox').checked;
                resultsTitleEl.textContent = `Current Project - Bonus Results ${isMultiplierUsed ? `(Multiplier: ${bonusMultiplier})` : '(No Multiplier Applied)'}`;
                const data = document.getElementById('techData').value.trim();
                if (!data) {
                    alert("Please paste data or load a project to calculate.");
                    return;
                }
                const parsedData = parseRawData(data, isProjectLevelIR);
                if (parsedData) {
                    currentTechStats = parsedData.techStats;
                    renderSingleProjectTable(currentTechStats, bonusMultiplier);
                }
            }
            document.getElementById('tech-results-container').classList.add('visible');
        }
        
        function renderSingleProjectTable(techStats, bonusMultiplier) {
            const resultsThead = document.getElementById('results-thead');
            const resultsBody = document.getElementById('tech-results-body');
            resultsBody.innerHTML = '';
            const infoIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>`;
            resultsThead.innerHTML = `
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tech ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Points <span class="info-icon" data-key="totalPoints">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fix Quality % <span class="info-icon" data-key="fixQuality">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% of Bonus Earned <span class="info-icon" data-key="bonusEarned">${infoIconSvg}</span></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Final Payout (PHP) <span class="info-icon" data-key="totalBonus">${infoIconSvg}</span></th>
                </tr>
            `;

            for (const techId in techStats) {
                const tech = techStats[techId];
                const row = createTableRow(tech, bonusMultiplier);
                row.dataset.techId = techId;
                resultsBody.appendChild(row);
            }

            if (lastFilterValue) {
                const searchInput = document.getElementById('search-tech-id');
                searchInput.value = lastFilterValue;
                filterTable();
            }
        }
        
        function calculateQualityModifier(qualityRate) {
            if (qualityRate >= 100) return 1.0;
            if (qualityRate >= 82.5) return 0.55;
            if (qualityRate >= 82) return 0.50;
            if (qualityRate >= 81.5) return 0.45;
            if (qualityRate >= 81) return 0.40;
            if (qualityRate >= 80.5) return 0.35;
            if (qualityRate >= 80) return 0.30;
            if (qualityRate >= 79.5) return 0.25;
            if (qualityRate >= 79) return 0.20;
            if (qualityRate >= 78.5) return 0.15;
            if (qualityRate >= 78) return 0.10;
            if (qualityRate >= 77.5) return 0.05;
            return 0;
        }
        
        function createTableRow(tech, bonusMultiplier) {
            const denominator = tech.fixTasks + tech.refixTasks + tech.warnings;
            const fixQuality = denominator > 0 ? (tech.fixTasks / denominator) : 0;
            const qualityModifier = calculateQualityModifier(fixQuality * 100);
            const finalPayout = tech.points * bonusMultiplier * qualityModifier;
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${tech.id}
                    <span class="info-icon tech-summary-icon" data-tech-id="${tech.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tech.points.toFixed(3)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(fixQuality * 100).toFixed(2)}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(qualityModifier * 100).toFixed(0)}%</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-blue-600">${finalPayout.toFixed(2)}</td>
            `;
            
            return row;
        }

        function parseRawData(data, isFixTaskIR = false) {
            const techStats = {};
            const lines = data.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                alert("Data must include at least one header row and one data row.");
                return null;
            }
            const headerLine = lines.shift();
            const delimiter = '\t';
            const headers = headerLine.split(delimiter).map(h => h.trim().toLowerCase());
            
            const headerMap = {};
            headers.forEach((h, i) => { headerMap[h] = i; });

            const baseCategoryHeaders = ['category', 'i3qa_cat', 'rv1_cat', 'rv2_cat'];
            if (headerMap['combo?'] === undefined) {
                 alert("Critical column 'COMBO?' is missing from the data header. Please ensure it is included.");
                 return null;
            }

            const techIdCols = headers.filter(h => h.endsWith('_id'));
            const warnCols = headers.filter(h => h.startsWith('r') && h.endsWith('_warn'));
            
            const afp1StatIndex = headerMap['afp1_stat'];
            const afp1CatIndex = headerMap['afp1_cat'];
            const afp2StatIndex = headerMap['afp2_stat'];
            const afp2CatIndex = headerMap['afp2_cat'];

            lines.forEach(line => {
                const values = line.split(delimiter);
                const isComboIR = values[headerMap['combo?']] === 'Y';

                techIdCols.forEach(colName => {
                    const techId = values[headerMap[colName]]?.trim();
                    if (techId) {
                        if (!techStats[techId]) {
                            techStats[techId] = createNewTechStat();
                            techStats[techId].id = techId;
                        }
                        
                        let points = 0;
                        if (colName.startsWith('fix')) {
                            const isRefix = colName !== 'fix1_id';
                            if (isRefix) {
                                techStats[techId].refixTasks += 1;
                            } else {
                                techStats[techId].fixTasks += 1;
                                let totalRowFixPoints = 0;
                                
                                baseCategoryHeaders.forEach(catHeader => {
                                    if (headerMap[catHeader] !== undefined) {
                                        const categoryValue = parseInt(values[headerMap[catHeader]]);
                                        if (!isNaN(categoryValue) && categoryValue >= 1 && categoryValue <= 9) {
                                            if (techStats[techId].categoryCounts[categoryValue] !== undefined) {
                                                techStats[techId].categoryCounts[categoryValue]++;
                                            }
                                            const catInfo = categoryValues[categoryValue];
                                            if (catInfo) { totalRowFixPoints += catInfo.points; }
                                        }
                                    }
                                });

                                if (afp1StatIndex !== undefined && afp1CatIndex !== undefined && values[afp1StatIndex]?.trim().toUpperCase() === 'AA') {
                                    const afp1CatValue = parseInt(values[afp1CatIndex]);
                                    if (!isNaN(afp1CatValue) && afp1CatValue >= 1 && afp1CatValue <= 9) {
                                        if (techStats[techId].categoryCounts[afp1CatValue] !== undefined) {
                                            techStats[techId].categoryCounts[afp1CatValue]++;
                                        }
                                        const catInfo = categoryValues[afp1CatValue];
                                        if (catInfo) { totalRowFixPoints += catInfo.points; }
                                    }
                                }
                                
                                if (afp2StatIndex !== undefined && afp2CatIndex !== undefined && values[afp2StatIndex]?.trim().toUpperCase() === 'AA') {
                                    const afp2CatValue = parseInt(values[afp2CatIndex]);
                                     if (!isNaN(afp2CatValue) && afp2CatValue >= 1 && afp2CatValue <= 9) {
                                        if (techStats[techId].categoryCounts[afp2CatValue] !== undefined) {
                                            techStats[techId].categoryCounts[afp2CatValue]++;
                                        }
                                        const catInfo = categoryValues[afp2CatValue];
                                        if (catInfo) { totalRowFixPoints += catInfo.points; }
                                    }
                                }

                                if (isFixTaskIR && totalRowFixPoints > 0) {
                                    totalRowFixPoints *= irModifierValue;
                                }

                                techStats[techId].pointsBreakdown.fix += totalRowFixPoints;
                                points += totalRowFixPoints;
                            }
                        } else if (colName.startsWith('qc')) {
                            points = 1 / 8;
                            techStats[techId].pointsBreakdown.qc += points;
                        } else if (colName.startsWith('i3qa')) {
                            points = 1 / 12;
                            techStats[techId].pointsBreakdown.i3qa += points;
                        } else if (colName.startsWith('rv')) {
                            if (colName === 'rv1_id') points = isComboIR ? (1/4) : (1/5);
                            else if (colName === 'rv2_id') points = 1/2;
                            techStats[techId].pointsBreakdown.rv += points;
                        }
                        
                        techStats[techId].points += points;
                    }
                });

                warnCols.forEach(colName => {
                    const warnValue = values[headerMap[colName]]?.trim();
                    if (warnValue) {
                        const round = colName.match(/\d+/)[0];
                        const fixTechId = values[headerMap[`fix${round}_id`]]?.trim();
                        if (fixTechId && techStats[fixTechId]) {
                            techStats[techId].warnings += 1;
                        }
                    }
                });
            });
            return { techStats };
        }

        function filterTable() {
            const searchTerm = document.getElementById('search-tech-id').value.toUpperCase();
            const rows = document.getElementById('tech-results-body').getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const techIdCell = rows[i].getElementsByTagName('td')[0];
                if (techIdCell) {
                    const techId = techIdCell.textContent || techIdCell.innerText;
                    if (searchTerm === "" || techId.toUpperCase().indexOf(searchTerm) > -1) {
                        rows[i].style.display = "";
                    } else {
                        rows[i].style.display = "none";
                    }
                }
            }
        }

        function openModal(key) {
            const modal = document.getElementById('info-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const info = calculationInfo[key];
            if (info) {
                modalTitle.innerHTML = info.title;
                modalBody.innerHTML = info.body;
                modal.classList.remove('hidden');
            }
        }
        
        function openTechSummaryModal(techId) {
            const tech = currentTechStats[techId];
            if (!tech) return;

            const modal = document.getElementById('info-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            const denominator = tech.fixTasks + tech.refixTasks + tech.warnings;
            const fixQuality = denominator > 0 ? (tech.fixTasks / denominator) : 0;
            const qualityModifier = calculateQualityModifier(fixQuality * 100);
            const finalPayout = tech.points * lastUsedBonusMultiplier * qualityModifier;

            modalTitle.innerHTML = `Detailed Breakdown for Tech ID: <span class="text-blue-600">${techId}</span>`;
            
            let categoryHtml = '';
            for (let i = 1; i <= 9; i++) {
                if (tech.categoryCounts[i] > 0) {
                     categoryHtml += `<li class="flex justify-between"><span>Category ${i}:</span> <span class="font-mono">${tech.categoryCounts[i]}</span></li>`;
                }
            }
            if (!categoryHtml) categoryHtml = '<li>No primary fix tasks recorded.</li>';

            let multiplierDisplay = lastCalculationUsedMultiplier
                ? `${lastUsedBonusMultiplier.toFixed(2)} (Multiplier)`
                : '1 (No Multiplier Applied)';

            let bodyHtml = `<div class="space-y-4 text-sm">
                
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-base text-gray-800 mb-2">Core Stats</h4>
                    <div class="flex justify-between"><span class="text-gray-600">Primary Fix Tasks:</span><span class="font-bold">${tech.fixTasks}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Refix Tasks:</span><span class="font-bold">${tech.refixTasks}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Warnings:</span><span class="font-bold text-red-600">${tech.warnings}</span></div>
                    <details class="mt-2 text-xs">
                        <summary class="cursor-pointer font-medium text-gray-500">Show Category Counts</summary>
                        <ul class="list-disc list-inside mt-1 space-y-1 pl-2">${categoryHtml}</ul>
                    </details>
                </div>
                
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-base text-gray-800 mb-2">Points Calculation</h4>
                    <div class="flex justify-between"><span class="text-gray-600">Points from Fix Tasks:</span><span class="font-mono">${tech.pointsBreakdown.fix.toFixed(3)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Points from QC Tasks:</span><span class="font-mono">${tech.pointsBreakdown.qc.toFixed(3)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Points from i3QA Tasks:</span><span class="font-mono">${tech.pointsBreakdown.i3qa.toFixed(3)}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Points from RV Tasks:</span><span class="font-mono">${tech.pointsBreakdown.rv.toFixed(3)}</span></div>
                    <hr class="my-2">
                    <div class="flex justify-between font-bold"><span class="text-gray-800">Total Points:</span><span class="font-mono">${tech.points.toFixed(3)}</span></div>
                </div>

                <div class="p-3 bg-gray-50 rounded-lg border">
                    <h4 class="font-semibold text-base text-gray-800 mb-2">Quality Calculation</h4>
                     <p class="text-xs text-gray-500 mb-2">Formula: [Fix Tasks] / ([Fix Tasks] + [Refix Tasks] + [Warnings])</p>
                    <div class="p-2 bg-white rounded text-center mb-2"><code>${tech.fixTasks} / (${tech.fixTasks} + ${tech.refixTasks} + ${tech.warnings}) = ${(fixQuality).toFixed(4)}</code></div>
                    <div class="flex justify-between font-bold"><span class="text-gray-800">Fix Quality %:</span><span class="font-mono">${(fixQuality * 100).toFixed(2)}%</span></div>
                </div>

                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 class="font-semibold text-base text-blue-800 mb-2">Final Payout</h4>
                    <div class="flex justify-between"><span class="text-gray-600">% of Bonus Earned:</span><span class="font-bold text-green-600">${(qualityModifier * 100).toFixed(0)}%</span></div>
                    <p class="text-xs text-gray-500 mt-2 mb-2">Formula: Total Points * Bonus Multiplier * % of Bonus Earned</p>
                    <div class="p-2 bg-white rounded text-center text-xs md:text-sm mb-2"><code>${tech.points.toFixed(3)} (Points) * ${multiplierDisplay} * ${qualityModifier.toFixed(2)} (Earned)</code></div>
                    <div class="flex justify-between font-bold text-lg"><span class="text-blue-900">Final Payout (PHP):</span><span class="text-blue-600 font-mono">${finalPayout.toFixed(2)}</span></div>
                </div>

            </div>`;

            modalBody.innerHTML = bodyHtml;
            modal.classList.remove('hidden');
        }

        function closeModal() {
            const modal = document.getElementById('info-modal');
            modal.classList.add('hidden');
        }

    </script>
</body>
</html>
