<!DOCTYPE html>
<html>
<head>
    <title>123 - Fixpoint Extractor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="icon.png" type="image/png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

    <script src="./buffer.min.js"></script> 

    <script>
        console.log("HEAD SCRIPT (using local buffer.min.js): Attempting to set window.Buffer...");
        if (typeof window.buffer !== 'undefined' && typeof window.buffer.Buffer === 'function') {
            window.Buffer = window.buffer.Buffer;
            console.log("HEAD SCRIPT: window.Buffer has been SET successfully from 'window.buffer.Buffer'.");
        } else if (typeof buffer !== 'undefined' && typeof buffer.Buffer === 'function') {
            window.Buffer = buffer.Buffer;
            console.log("HEAD SCRIPT: window.Buffer has been SET successfully from global 'buffer.Buffer'.");
        } else {
            console.error("HEAD SCRIPT (local buffer.min.js): CRITICAL - The 'buffer' global (from local buffer.min.js) or its 'Buffer' property was NOT found. window.Buffer could not be set here. Ensure buffer.min.js is in the root directory and loaded correctly.");
        }
    </script>

    <script src="./dbf.min.js"></script>

    <style>
        :root {
            /* Define your eye-friendly purple palette (Light Mode) */
            --primary-purple: #8E7DBF; /* Muted Purple */
            --primary-purple-dark: #5B4A8C; /* Deeper Muted Purple */
            --primary-purple-light: #F5F2F9; /* Very light purple for backgrounds */
            --accent-purple: #9C7CDA; /* Slightly brighter accent purple */

            --light-bg: #F8F7FB; /* Soft, almost white background */
            --medium-bg: #EFEFEF; /* Light neutral grey */
            --dark-text: #444444; /* Dark charcoal grey for main text */
            --light-text: #FFFFFF; /* White text */

            /* Softer action colors */
            --info-blue: #64b5f6; /* Light Blue 300 */
            --success-green: #81c784; /* Light Green 300 */
            --warning-orange: #ffb74d; /* Amber 300 */
            --danger-red: #e57373; /* Red 300 */
        }

        /* Dark Mode Colors */
        body.dark-mode {
            --primary-purple: #9C7CDA; /* Brighter muted purple for dark mode */
            --primary-purple-dark: #8E7DBF; /* Still a deep purple, slightly lighter than light mode's dark */
            --primary-purple-light: #3A305D; /* Darker purple for elements */
            --accent-purple: #B08FD9; /* A bit brighter accent */

            --light-bg: #2C273B; /* Deep dark purple background */
            --medium-bg: #443C5C; /* Medium dark purple for elements */
            --dark-text: #E0E0E0; /* Light grey for text */
            --light-text: #222222; /* Dark text for contrast on light elements (e.g. table headers) */

            /* Adjusted action colors for dark mode */
            --info-blue: #64b5f6; /* Keep light blue for visibility */
            --success-green: #81c784; /* Keep light green for visibility */
            --warning-orange: #ffb74d; /* Keep amber for visibility */
            --danger-red: #e57373; /* Keep red for visibility */
        }

        body {
            padding: 20px;
            background-color: var(--light-bg); /* Soft light background */
            font-family: 'Open Sans', sans-serif;
            color: var(--dark-text); /* Dark charcoal text */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition for dark mode */
        }
        h5, h4 {
            font-family: 'Roboto Slab', serif;
            color: var(--primary-purple-dark); /* Deeper muted purple for headings */
            transition: color 0.3s ease; /* Smooth transition for dark mode */
        }
        .container {
            background-color: var(--light-text); /* White in light, dark grey in dark */
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode .container {
            background-color: #3A305D; /* Darker background for container in dark mode */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .container:hover {
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }
        body.dark-mode .container:hover {
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        .result {
            background: var(--primary-purple-light);
            padding: 20px;
            margin-top: 20px;
            white-space: pre-wrap;
            border-left: 4px solid var(--primary-purple);
            font-family: 'Courier New', monospace;
            min-height: 100px;
            border-radius: 8px;
            overflow-x: auto;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        body.dark-mode .result {
            background: #443C5C; /* Darker background for results in dark mode */
            border-left-color: var(--primary-purple);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .result-buttons {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 1;
        }
        .result-buttons .expand-button,
        .result-buttons .view-data-result-button {
            background-color: rgba(0, 0, 0, 0.05);
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            cursor: pointer;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-left: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        body.dark-mode .result-buttons .expand-button,
        body.dark-mode .result-buttons .view-data-result-button {
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .result-buttons .expand-button:hover,
        .result-buttons .view-data-result-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        body.dark-mode .result-buttons .expand-button:hover,
        body.dark-mode .result-buttons .view-data-result-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .result-buttons .expand-button i.material-icons,
        .result-buttons .view-data-result-button i.material-icons {
            font-size: 20px;
            color: var(--dark-text);
        }
        .result table.striped tbody tr:nth-child(odd) {
            background-color: var(--primary-purple-light);
        }
        body.dark-mode .result table.striped tbody tr:nth-child(odd) {
            background-color: #443C5C; /* Darker odd rows */
        }
        .result table.striped tbody tr:nth-child(even) {
            background-color: #ede7f6;
        }
        body.dark-mode .result table.striped tbody tr:nth-child(even) {
            background-color: #3A305D; /* Darker even rows */
        }
        .result table th {
            background-color: var(--primary-purple-dark);
            color: var(--light-text);
            padding: 14px 18px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.dark-mode .result table th {
            background-color: var(--primary-purple-dark);
            color: var(--dark-text); /* Dark text on light header */
        }
        .result table td, .result table th {
            padding: 12px 15px;
            border: 1px solid #d1c4e9;
            transition: border-color 0.3s ease;
        }
        body.dark-mode .result table td, body.dark-mode .result table th {
            border-color: #5B4A8C; /* Darker border */
        }
        .result table {
            border-collapse: collapse;
            width: 100%;
        }
        .modal textarea {
            height: 150px;
            overflow-y: auto;
            resize: none;
        }
        .modal-content textarea.materialize-textarea {
            height: 150px !important;
            overflow-y: auto;
            resize: none;
        }
        .input-field {
            margin-top: 25px;
            margin-bottom: 20px;
        }
        .input-field input:focus + label,
        .input-field textarea:focus + label {
            color: var(--primary-purple) !important;
        }
        .input-field input:focus,
        .input-field textarea:focus {
            border-bottom: 1px solid var(--primary-purple) !important;
            box-shadow: 0 1px 0 0 var(--primary-purple) !important;
        }
        .input-field select:focus {
            outline: 1px solid var(--primary-purple);
        }
        /* Dark Mode Input Field adjustments */
        body.dark-mode .input-field label {
            color: var(--dark-text) !important; /* Light label text */
        }
        body.dark-mode .input-field input,
        body.dark-mode .input-field textarea {
            color: var(--dark-text); /* Light input text */
            border-bottom-color: var(--primary-purple-dark) !important;
        }
        body.dark-mode .input-field input:focus,
        body.dark-mode .input-field textarea:focus {
            border-bottom: 1px solid var(--accent-purple) !important;
            box-shadow: 0 1px 0 0 var(--accent-purple) !important;
        }
        body.dark-mode .input-field input[type=text]:not(.browser-default):focus:not([readonly]) + label,
        body.dark-mode .input-field input[type=password]:not(.browser-default):focus:not([readonly]) + label,
        body.dark-mode .input-field textarea.materialize-textarea:focus:not([readonly]) + label {
            color: var(--accent-purple) !important;
        }
        body.dark-mode .input-field .caret { /* For select dropdown arrow */
            fill: var(--dark-text);
        }
        body.dark-mode .select-wrapper input.select-dropdown {
            color: var(--dark-text);
        }
        body.dark-mode .dropdown-content li > a,
        body.dark-mode .dropdown-content li > span {
            color: var(--dark-text);
        }
        body.dark-mode .dropdown-content {
            background-color: var(--medium-bg);
        }

        /* Button Styling - Modern, subtle shadows, consistent hover */
        .btn, .btn-large, .btn-small, .btn-flat {
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            margin-top: 15px;
            margin-bottom: 15px;
            margin-right: 12px;
            text-transform: none;
            font-weight: 600;
            color: var(--light-text); /* Ensure text color is light for all buttons */
        }
        .btn:hover, .btn-large:hover, .btn-small:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: translateY(-2px);
            opacity: 1;
        }
        .btn i.material-icons.left {
            margin-right: 8px;
        }

        /* Specific Button Colors - Eye-Friendly Purple Theme Mapping */
        .btn.blue, .btn.blue.darken-1 { background-color: var(--primary-purple) !important; }
        .btn.blue:hover, .btn.blue.darken-1:hover { background-color: var(--primary-purple-dark) !important; }

        .btn.green { background-color: var(--success-green) !important; }
        .btn.green:hover { background-color: #66bb6a !important; }

        .btn.orange.darken-2 { background-color: var(--warning-orange) !important; }
        .btn.orange.darken-2:hover { background-color: #ffa726 !important; }

        .btn.red, .btn.red.darken-2 { background-color: var(--danger-red) !important; }
        .btn.red:hover, .btn.red.darken-2:hover { background-color: #ef5350 !important; }

        .btn.purple.darken-2 { background-color: var(--primary-purple-dark) !important; }
        .btn.purple.darken-2:hover { background-color: #4527a0 !important; }

        .btn.deep-purple.darken-2 { background-color: var(--primary-purple-dark) !important; }
        .btn.deep-purple.darken-2:hover { background-color: #4527a0 !important; }

        .btn.grey.darken-1 { background-color: #9e9e9e !important; }
        .btn.grey.darken-1:hover { background-color: #757575 !important; }
        .btn.grey { background-color: #bdbdbd !important; color: #424242 !important} /* Added for cancel button */
        .btn.grey:hover { background-color: #9e9e9e !important; } /* Added for cancel button */


        /* Floating Action Button specific */
        .btn-floating.btn-large.green {
            background-color: var(--accent-purple) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-floating.btn-large.green:hover {
            background-color: #8367d3 !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transform: translateY(-3px);
        }

        /* Dark Mode Toggle Button */
        #dark-mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--medium-bg); /* Use a neutral background */
            color: var(--dark-text); /* Text color changes with theme */
            border-radius: 50%;
            width: 44px; /* Larger touch target */
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            z-index: 999; /* Ensure it's on top */
        }
        #dark-mode-toggle:hover {
            background-color: var(--primary-purple-light); /* Subtle hover effect */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        body.dark-mode #dark-mode-toggle {
            background-color: #5B4A8C; /* Darker background in dark mode */
            color: var(--dark-text); /* Light icon */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        body.dark-mode #dark-mode-toggle:hover {
            background-color: #6A5B9C;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        #dark-mode-toggle i.material-icons {
            font-size: 24px;
        }

        .right-align {
            margin-bottom: 20px;
        }
        .center-align {
            margin-top: 25px;
            margin-bottom: 25px;
        }
        #all-results {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 30px;
        }
        #all-results h5 {
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        body.dark-mode #all-results h5 {
            border-bottom-color: #555; /* Darker border in dark mode */
        }
        .modal-content h5 {
            margin-bottom: 20px;
        }
        .modal-content .input-field {
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .modal-footer a {
            margin-left: 10px;
        }
        /* Modal specific styling for dark mode */
        .modal {
            background-color: #ffffff; /* Default light background */
            transition: background-color 0.3s ease;
        }
        body.dark-mode .modal {
            background-color: #3A305D; /* Dark modal background */
        }
        body.dark-mode .modal .modal-content {
            color: var(--dark-text); /* Light text in modal */
        }
        body.dark-mode .modal .modal-footer {
            background-color: #443C5C; /* Darker footer in dark mode */
            border-top-color: #5B4A8C;
        }

        #login-modal {
            max-width: 450px;
            border-radius: 12px;
            margin: auto;
            overflow: hidden;
        }
        #login-modal .modal-content {
            padding: 35px;
            text-align: center;
            background-color: #ffffff;
        }
        body.dark-mode #login-modal .modal-content {
            background-color: #3A305D; /* Dark mode login modal content */
        }
        #login-modal .modal-content h5 {
            margin-bottom: 30px;
            color: var(--primary-purple-dark);
        }
        #login-modal .input-field {
            margin-bottom: 25px;
        }
        #login-modal .modal-footer {
            padding: 20px;
            text-align: center;
            background-color: var(--primary-purple-light);
            border-top: 1px solid #d1c4e9;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        body.dark-mode #login-modal .modal-footer {
            background-color: #443C5C;
            border-top-color: #5B4A8C;
        }
        #login-modal .btn {
            width: 100%;
            margin-right: 0;
            background-color: var(--primary-purple) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        #login-modal .btn:hover {
            background-color: var(--primary-purple-dark) !important;
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
        }
        #logout-button {
            margin-left: auto;
        }
        #fullscreen-results-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        #fullscreen-results-content {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            max-width: 95%;
            max-height: 95%;
            overflow: auto;
            position: relative;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        body.dark-mode #fullscreen-results-content {
            background-color: #3A305D;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }
        #fullscreen-results-content .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: rgba(255, 255, 255, 0.85);
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 2;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        body.dark-mode #fullscreen-results-content .close-button {
            background-color: rgba(0, 0, 0, 0.3);
            color: var(--dark-text);
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }
        #fullscreen-results-content .close-button:hover {
            background-color: rgba(255, 255, 255, 0.95);
            transform: rotate(90deg);
        }
        body.dark-mode #fullscreen-results-content .close-button:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }
        #fullscreen-results-content .close-button i.material-icons {
            font-size: 22px;
            color: var(--dark-text);
        }
        #view-data-modal {
            max-width: 95%;
            max-height: 95%;
            width: 95%;
            height: 95%;
            top: 2.5% !important;
            transform: translate(-50%, 0%) !important;
            left: 50% !important;
            border-radius: 12px;
        }
        #view-data-modal .modal-content {
            overflow-y: auto;
            max-height: calc(100% - 70px);
            padding-bottom: 0;
        }
        #view-data-modal table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #view-data-modal table th,
        #view-data-modal table td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: left;
            white-space: nowrap;
        }
        body.dark-mode #view-data-modal table th,
        body.dark-mode #view-data-modal table td {
            border-color: #5B4A8C;
        }
        #view-data-modal table th {
            background-color: var(--primary-purple-light);
            color: var(--dark-text);
            font-weight: bold;
        }
        body.dark-mode #view-data-modal table th {
            background-color: var(--primary-purple-dark);
            color: var(--dark-text);
        }
        #view-data-table-container .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
            }
            .btn {
                margin-right: 8px;
                margin-bottom: 12px;
            }
            .center-align {
                margin-top: 15px;
                margin-bottom: 15px;
            }
            #all-results {
                max-height: 400px;
            }
            #fullscreen-results-content {
                max-width: 95%;
                max-height: 95%;
            }
            #view-data-modal {
                max-width: 95%;
                width: 95%;
                height: 95%;
                top: 2.5% !important;
                transform: translate(-50%, 0%) !important;
                left: 50% !important;
            }
            #dark-mode-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
            #dark-mode-toggle i.material-icons {
                font-size: 20px;
            }
        }
        /* Custom styles for Quality and Bonus */
        .quality-green {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        body.dark-mode .quality-green {
            background-color: #2e7d32; /* Darker green background */
            color: #e8f5e9; /* Lighter text */
        }
        .quality-orange {
            background-color: #fff3e0;
            color: #ef6c00;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        body.dark-mode .quality-orange {
            background-color: #ef6c00; /* Darker orange background */
            color: #fff3e0; /* Lighter text */
        }
        .quality-red {
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        body.dark-mode .quality-red {
            background-color: #c62828; /* Darker red background */
            color: #ffebee; /* Lighter text */
        }
        .tech-id-highlight {
            font-weight: bold;
            color: var(--primary-purple-dark);
        }
        .salary-highlight {
            background-color: #f0f0f0;
            color: #333;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        body.dark-mode .salary-highlight {
            background-color: #5B4A8C; /* Darker background for salary */
            color: var(--dark-text); /* Light text */
        }
        .tech-id-red-highlight {
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
        }
        body.dark-mode .tech-id-red-highlight {
            background-color: #c62828;
            color: #ffebee;
        }

        /* Spinner color */
        .spinner-layer.spinner-blue-only .circle-clipper .circle,
        .spinner-layer.spinner-blue-only .gap-patch .circle {
            border-color: var(--primary-purple) !important;
        }
        .preloader-wrapper.active .spinner-layer.spinner-blue-only .circle-clipper.left,
        .preloader-wrapper.active .spinner-layer.spinner-blue-only .circle-clipper.right {
            border-color: var(--primary-purple) !important;
        }
    </style>
</head>
<body>
    <button id="dark-mode-toggle">
        <i class="material-icons">brightness_high</i>
    </button>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h5 class="center-align">Login</h5>
            <div class="input-field">
                <select id="login-role">
                    <option value="" disabled selected>Choose your role</option>
                    <option value="tl">Login as TL</option>
                    <option value="tech">Login as Tech</option>
                </select>
                <label for="login-role">Select Role</label>
            </div>
            <div class="input-field" id="tl-code-input" style="display: none;">
                <input id="tl-login-code" type="password">
                <label for="tl-login-code">TL Login Code</label>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn blue" id="login-button">Login</a>
        </div>
    </div>

    <div class="container" id="main-app-content" style="display: none;">
        <h5 class="center-align">123 EXTRACTOR v2.5</h5>
        <div class="right-align" style="margin-top: 10px;">
            <a class="btn-floating btn-large green modal-trigger" href="#add-project-modal" id="add-project-button">
                <i class="material-icons">add</i>
            </a>
        </div>
        <div class="input-field">
            <select id="project-selector">
                <option value="" disabled selected>Select a saved project</option>
            </select>
            <label for="project-selector">Load Project</label>
        </div>
        <div class="center-align">
            <button class="btn orange darken-2" id="edit-project">
                <i class="material-icons left">edit</i>Edit Project
            </button>
            <button class="btn red darken-2" id="delete-project">
                <i class="material-icons left">delete</i>Delete Project
            </button>
            <button class="btn blue-grey darken-1 modal-trigger" href="#view-data-modal" id="view-project-data-button">
                <i class="material-icons left">table_chart</i>View Data
            </button>
        </div>
        <div class="input-field">
            <input id="tech-id" type="text" placeholder="e.g. TECH123">
            <label for="tech-id">Search TECH ID</label>
        </div>
        <div class="center-align">
            <button class="btn blue" id="search-button">
                <i class="material-icons left">search</i>Search
            </button>
            <button class="btn green" id="calculate-all-button">
                <i class="material-icons left">calculate</i>Per Project Total
            </button>
            <button class="btn purple darken-2 modal-trigger" href="#multiplier-modal" id="calculate-all-projects-button">
                <i class="material-icons left">grid_on</i>All Projects Total
            </button>
        </div>
        <div class="center-align" style="margin-top: 10px;">
            <button class="btn orange" id="export-button">
                <i class="material-icons left">file_download</i>Download CSV
            </button>
            <button class="btn red" id="clear-data-button">
                <i class="material-icons left">clear_all</i>Clear All Data
            </button>
        </div>
        <div class="center-align" style="margin-top: 10px;">
            <button class="btn blue darken-1" id="copy-all-projects-json">
                <i class="material-icons left">content_copy</i>Copy All Projects Data
            </button>
            <button class="btn deep-purple darken-2" id="auto-fetch-external-json">
                <i class="material-icons left">cloud_download</i>Update Projects Online
            </button>
        </div>
        <div id="output" class="result z-depth-1">
        </div>
        <div id="all-results" class="result z-depth-1" style="margin-top: 20px; max-height: 600px; overflow-y: auto;">
        </div>
        <div id="multiplier-modal" class="modal">
            <div class="modal-content">
                <h5>Enter Multiplier</h5>
                <div class="input-field">
                    <input id="total-multiplier" type="number" value="1" step="0.01">
                    <label for="total-multiplier">Multiplier</label>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close btn grey">Cancel</a>
                <a href="#!" class="btn green" id="apply-multiplier">Apply Multiplier</a>
            </div>
        </div>

        <div id="add-project-modal" class="modal"> <div class="modal-content">
                <h5 id="modal-title">Add New Project</h5>
                <div class="input-field">
                    <input id="project-name" type="text">
                    <label for="project-name">Project Name</label>
                </div>

                <div class="file-field input-field" id="dbf-file-upload-field"> <div class="btn blue"> 
                        <span>Import DBF</span>
                        <input type="file" id="dbf-file-input" accept=".dbf">
                    </div>
                    <div class="file-path-wrapper">
                        <input class="file-path validate" type="text" placeholder="Upload a .dbf file (optional)">
                    </div>
                </div>

                <div class="input-field">
                    <textarea id="raw-data" class="materialize-textarea" placeholder="Paste your fixpoints data here or import a DBF file..."></textarea>
                    <label for="raw-data">Fixpoints Data</label>
                </div>
                <div class="row">
                    <div class="input-field col s6">
                        <select id="modal-size">
                            <option value="3in">3IN</option>
                            <option value="9in">9IN</option>
                        </select>
                        <label for="modal-size">Project Size</label>
                    </div>
                    <div class="input-field col s6">
                        <label>
                            <input type="checkbox" id="modal-ir-check" />
                            <span>IR Additive (1.5pts)</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close btn grey">Cancel</a>
                <a href="#!" class="modal-close btn green" id="save-project-modal-button">Save Project</a>
            </div>
        </div>

        <div class="center-align" style="margin-top: 20px;">
            <button class="btn waves-effect waves-light grey darken-1" id="logout-button">
                <i class="material-icons left">logout</i>Logout / Change Role
            </button>
        </div>
    </div>

    <div id="view-data-modal" class="modal">
        <div class="modal-content">
            <h5 id="view-data-modal-title">Project Data</h5>
            <div id="view-data-table-container" style="overflow-x: auto;">
                <div class="spinner-container" id="view-data-spinner" style="display: none;">
                    <div class="preloader-wrapper active">
                        <div class="spinner-layer spinner-blue-only">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn grey">Close</a>
        </div>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h5 id="confirmation-modal-title">Confirm Action</h5>
            <p id="confirmation-modal-message"></p>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close btn grey darken-1" id="confirmation-cancel-button">Cancel</a>
            <a href="#!" class="modal-close btn red darken-2" id="confirmation-confirm-button">Confirm</a>
        </div>
    </div>

    <div id="fullscreen-results-modal">
        <div id="fullscreen-results-content">
            <button class="close-button"><i class="material-icons">close</i></button>
        </div>
    </div>

    <div id="loader-spinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
        <div class="preloader-wrapper active">
            <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                    <div class="circle"></div>
                </div>
                <div class="gap-patch">
                    <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                    <div class="circle"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMContentLoaded event fired. Final check for window.Buffer and Dbf object, which should have been set/available from <head>.");
            let bufferPolyfillLoaded = false;
            if (typeof window.Buffer === 'function') {
                console.log("DOMContentLoaded: window.Buffer IS correctly defined and available.");
                bufferPolyfillLoaded = true;
            } else {
                console.error("DOMContentLoaded: CRITICAL - window.Buffer is STILL NOT DEFINED. The inline script in <head> likely failed to set it because 'buffer.min.js' (local) did not properly define 'buffer' or 'window.buffer' globally. DBF import will fail.");
                alert("Error: A critical component (Buffer polyfill) required for DBF files failed to load or initialize correctly. DBF import functionality will not work. Please ensure 'buffer.min.js' is in the same directory as index.html, check your browser console (F12) for errors related to 'buffer.min.js' (ensure it's loading with status 200 OK and content is not empty), and try disabling browser extensions or ad blockers.");
            }

            let dbfLibraryLoaded = false;
            if (typeof Dbf === 'object' && typeof Dbf.read === 'function') {
                console.log("DOMContentLoaded: Dbf library IS correctly defined and available.");
                dbfLibraryLoaded = true;
            } else {
                console.error("DOMContentLoaded: CRITICAL - Dbf library (dbf.min.js - local) is NOT available or Dbf.read is not a function. DBF import will fail.");
                alert("Error: The DBF reading library (dbf.min.js - local) failed to load or initialize correctly. DBF import functionality will not work. Ensure 'dbf.min.js' is in the same directory as index.html and check your browser console for related errors.");
            }

            // --- Configuration ---
            const HARDCODED_PROJECTS_JSON_URL = 'https://raw.githubusercontent.com/serhgs/project_data.json/refs/heads/main/update.json';
            const HARDCODED_TL_CODE_URL = 'https://raw.githubusercontent.com/gmlorenz/gmlorenz.github.io/refs/heads/main/projects_data.json';
            const PRICES = [
                { "3in": 2.19, "9in": 0.99 }, { "3in": 5.86, "9in": 2.08 }, { "3in": 7.44, "9in": 2.78 },
                { "3in": 2.29, "9in": 1.57 }, { "3in": 1.55, "9in": 0.60 }, { "3in": 1.84, "9in": 0.78 },
                { "3in": 1.00, "9in": 1.00 }, { "3in": 3.74, "9in": 3.74 }, { "3in": 1.73, "9in": 1.73 }
            ];

            // --- DOM Elements ---
            const projectSelector = document.getElementById('project-selector');
            const rawDataInput = document.getElementById('raw-data');
            const projectNameInput = document.getElementById('project-name');
            const techIdInput = document.getElementById('tech-id');
            const outputDiv = document.getElementById('output');
            const allResultsDiv = document.getElementById('all-results');
            const addProjectModalEl = document.querySelector('#add-project-modal');
            const modalTitle = document.getElementById('modal-title');
            const saveProjectModalButton = document.getElementById('save-project-modal-button');
            const clearDataButton = document.getElementById('clear-data-button');
            const addProjectButton = document.getElementById('add-project-button');
            const mainAppContent = document.getElementById('main-app-content');
            const logoutButton = document.getElementById('logout-button');
            const loginModalEl = document.getElementById('login-modal');
            const loginRoleSelect = document.getElementById('login-role');
            const tlCodeInputDiv = document.getElementById('tl-code-input');
            const tlLoginCodeInput = document.getElementById('tl-login-code');
            const loginButtonElement = document.getElementById('login-button');
            const fullscreenResultsModal = document.getElementById('fullscreen-results-modal');
            const fullscreenResultsContent = document.getElementById('fullscreen-results-content');
            const fullscreenCloseButton = fullscreenResultsContent.querySelector('.close-button');
            const viewDataModalEl = document.getElementById('view-data-modal');
            const viewDataTableContainer = document.getElementById('view-data-table-container');
            const viewDataModalTitle = document.getElementById('view-data-modal-title');
            const viewDataSpinner = document.getElementById('view-data-spinner');
            const multiplierInput = document.getElementById('total-multiplier');
            const applyMultiplierButton = document.getElementById('apply-multiplier');
            const modalSizeSelect = document.getElementById('modal-size');
            const modalIrCheck = document.getElementById('modal-ir-check');
            const viewProjectDataButton = document.getElementById('view-project-data-button');
            const autoFetchButton = document.getElementById('auto-fetch-external-json');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const dbfFileInput = document.getElementById('dbf-file-input'); 
            const dbfFileFieldContainer = document.getElementById('dbf-file-upload-field'); // Container for the DBF input field
            const confirmationModalEl = document.getElementById('confirmation-modal');
            const confirmationModalTitle = document.getElementById('confirmation-modal-title');
            const confirmationModalMessage = document.getElementById('confirmation-modal-message');
            const confirmationConfirmButton = document.getElementById('confirmation-confirm-button');
            const confirmationCancelButton = document.getElementById('confirmation-cancel-button');

            let activeProjectData = '';
            let allCalculatedResults = [];
            let lastResult = '';
            let allProjectsAggregatedResults = {};
            let editingProjectName = null;
            let isLoggedInAsTL = false;
            let confirmPromiseResolve = null; 

            function showToast(html, classes = '', duration = 4000) { M.toast({ html, classes, displayLength: duration }); }
            function showLoader() { const l = document.getElementById('loader-spinner'); if (l) l.style.display = 'block'; }
            function hideLoader() { const l = document.getElementById('loader-spinner'); if (l) l.style.display = 'none'; }

            // Conditionally show/hide DBF functionality UI (placed after showToast is defined)
            if (dbfFileFieldContainer) { 
                if (!bufferPolyfillLoaded || !dbfLibraryLoaded) {
                    console.warn("DBF import UI elements will be hidden due to missing dependencies.");
                    dbfFileFieldContainer.style.display = 'none'; 
                    setTimeout(() => { // Delay toast slightly to ensure Materialize is ready for it
                        showToast('DBF import disabled: required components failed to load. Check console (F12).', 'red darken-2', 10000);
                    }, 500);
                } else {
                    console.log("DBF import UI elements are available and will be shown.");
                    dbfFileFieldContainer.style.display = 'block'; 
                }
            } else {
                 console.error("Could not find the DBF file upload field container ('dbf-file-upload-field') to hide/show.");
            }

            function safeSetLocalStorage(key, value) {
                try {
                    const compressedValue = LZString.compressToUTF16(value);
                    if (compressedValue === null) throw new Error("Compression failed.");
                    localStorage.setItem(key, compressedValue); return true;
                } catch (e) {
                    if (e instanceof DOMException && e.name === 'QuotaExceededError') showToast('Local storage full!', 'red');
                    else { showToast(`Error saving to local storage. ${e.message}`, 'red'); console.error("LS save error:", e); }
                    return false;
                }
            }

            function safeGetLocalStorage(key) {
                try {
                    const value = localStorage.getItem(key); if (value === null) return null;
                    let decompressedValue = LZString.decompressFromUTF16(value);
                    if (decompressedValue !== null) return decompressedValue;
                    console.warn(`Decompression failed for key "${key}". Attempting to load as uncompressed data.`); return value;
                } catch (e) { console.error(`Error retrieving or decompressing data for key "${key}":`, e); showToast('Error loading project data. Data might be corrupted.', 'red'); return null; }
            }

            function showCustomConfirm(message, title = 'Confirm Action') {
                return new Promise(resolve => {
                    confirmationModalTitle.textContent = title; confirmationModalMessage.textContent = message;
                    M.Modal.getInstance(confirmationModalEl).open(); confirmPromiseResolve = resolve;
                });
            }

            function loadProjectList() {
                projectSelector.innerHTML = '<option value="" disabled selected>Select a saved project</option>';
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('tl_project_')) {
                        const name = key.replace('tl_project_', '');
                        const option = document.createElement('option'); option.value = name; option.textContent = name;
                        projectSelector.appendChild(option);
                    }
                }
                M.FormSelect.init(projectSelector);
            }

            function addResultButtons(targetDiv) {
                const existingButtons = targetDiv.querySelector('.result-buttons'); if (existingButtons) existingButtons.remove();
                const buttonsContainer = document.createElement('div'); buttonsContainer.className = 'result-buttons';
                if (targetDiv.id === 'output' && lastResult) {
                    const viewDataBtn = document.createElement('button'); viewDataBtn.className = 'view-data-result-button';
                    viewDataBtn.innerHTML = '<i class="material-icons">table_chart</i>'; viewDataBtn.title = 'View Raw Data for this TECH ID';
                    viewDataBtn.addEventListener('click', () => {
                        if (!activeProjectData || !activeProjectData.data) { showToast('No data loaded for the selected project to view.', 'orange'); return; }
                        displayDataTableInModal(activeProjectData.data, lastResult.techID);
                    });
                    buttonsContainer.appendChild(viewDataBtn);
                }
                const expandBtn = document.createElement('button'); expandBtn.className = 'expand-button';
                expandBtn.innerHTML = '<i class="material-icons">fullscreen</i>'; expandBtn.title = 'Expand Results';
                expandBtn.addEventListener('click', () => {
                    let content = targetDiv.cloneNode(true);
                    const clonedButtons = content.querySelector('.result-buttons'); if (clonedButtons) clonedButtons.remove();
                    fullscreenResultsContent.innerHTML = ''; fullscreenResultsContent.appendChild(content);
                    const closeBtn = document.createElement('button'); closeBtn.classList.add('close-button');
                    closeBtn.innerHTML = '<i class="material-icons">close</i>'; closeBtn.addEventListener('click', hideFullscreenModal);
                    fullscreenResultsContent.appendChild(closeBtn); fullscreenResultsModal.style.display = 'flex';
                });
                buttonsContainer.appendChild(expandBtn); targetDiv.prepend(buttonsContainer);
            }
            
            function removeResultButtons(containerElement) { const b = containerElement.querySelector('.result-buttons'); if (b) b.remove(); }
            function hideFullscreenModal() { fullscreenResultsModal.style.display = 'none'; fullscreenResultsContent.innerHTML = ''; }

            function displayDataTableInModal(rawDataString, techIDFilter = '') {
                viewDataTableContainer.innerHTML = ''; viewDataSpinner.style.display = 'flex';
                setTimeout(() => {
                    const rows = String(rawDataString).split(/\r?\n/).filter(r => r.trim() !== "");
                    if (rows.length === 0) { viewDataTableContainer.innerHTML = '<p>No data available for this project.</p>'; }
                    else {
                        const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim()) || [];
                        const fixIdIndex = headers.map(h => h.toUpperCase()).indexOf("FIX1_ID");
                        let tableHtml = '<table class="striped"><thead><tr>';
                        headers.forEach(hText => tableHtml += `<th>${hText}</th>`); tableHtml += '</tr></thead><tbody>';
                        let foundRows = false;
                        rows.forEach(row => {
                            const fields = row.split(/[\t,]/).map(f => f.trim());
                            if (techIDFilter === '' || fixIdIndex === -1 || (fixIdIndex !== -1 && fields[fixIdIndex]?.toUpperCase() === techIDFilter)) {
                                foundRows = true; tableHtml += '<tr>';
                                fields.forEach(f => tableHtml += `<td>${f}</td>`); tableHtml += '</tr>';
                            }
                        });
                        tableHtml += '</tbody></table>';
                        if (foundRows || techIDFilter === '') { viewDataTableContainer.innerHTML = tableHtml; }
                        else { viewDataTableContainer.innerHTML = `<p>No data found for TECH ID: ${techIDFilter}.</p>`; }
                    }
                    let modalT = `Data for Project: ${projectSelector.value || 'Loaded Project'}`;
                    if (techIDFilter) { modalT += ` (Filtered by TECH ID: ${techIDFilter})`; }
                    viewDataModalTitle.textContent = modalT; viewDataSpinner.style.display = 'none';
                    M.Modal.getInstance(viewDataModalEl).open();
                }, 50);
            }

            function viewProjectData() {
                const selProjName = projectSelector.value; if (!selProjName) { showToast('Please select a project to view data.', 'orange'); return; }
                if (!activeProjectData || !activeProjectData.data) { showToast('No data loaded for the selected project.', 'orange'); return; }
                displayDataTableInModal(activeProjectData.data);
            }

            function getBonusPercentage(qualityPercentage) {
                if (qualityPercentage < 77.50) return 0; if (qualityPercentage >= 100.00) return 120;
                const bonusTiers = [ { quality: 77.50, bonus: 5 }, { quality: 78.00, bonus: 10 }, { quality: 78.50, bonus: 15 }, { quality: 79.00, bonus: 20 }, { quality: 79.50, bonus: 25 }, { quality: 80.00, bonus: 30 }, { quality: 80.50, bonus: 35 }, { quality: 81.00, bonus: 40 }, { quality: 81.50, bonus: 45 }, { quality: 82.00, bonus: 50 }, { quality: 82.50, bonus: 55 }, { quality: 83.00, bonus: 57 }, { quality: 83.50, bonus: 60 }, { quality: 84.00, bonus: 62 }, { quality: 84.50, bonus: 64 }, { quality: 85.00, bonus: 66 }, { quality: 85.50, bonus: 68 }, { quality: 86.00, bonus: 70 }, { quality: 86.50, bonus: 73 }, { quality: 87.00, bonus: 75 }, { quality: 87.50, bonus: 78 }, { quality: 88.00, bonus: 80 }, { quality: 88.50, bonus: 83 }, { quality: 89.00, bonus: 85 }, { quality: 89.50, bonus: 87 }, { quality: 90.00, bonus: 88 }, { quality: 90.50, bonus: 90 }, { quality: 91.00, bonus: 91 }, { quality: 91.50, bonus: 93 }, { quality: 92.00, bonus: 94 }, { quality: 92.50, bonus: 95 }, { quality: 93.00, bonus: 96 }, { quality: 93.50, bonus: 97 }, { quality: 94.00, bonus: 98 }, { quality: 94.50, bonus: 99 }, { quality: 95.00, bonus: 100 }, { quality: 95.50, bonus: 102 }, { quality: 96.00, bonus: 104 }, { quality: 96.50, bonus: 106 }, { quality: 97.00, bonus: 108 }, { quality: 97.50, bonus: 110 }, { quality: 98.00, bonus: 112 }, { quality: 98.50, bonus: 114 }, { quality: 99.00, bonus: 116 }, { quality: 99.50, bonus: 118 } ];
                for (let i = bonusTiers.length - 1; i >= 0; i--) { if (qualityPercentage >= bonusTiers[i].quality) return bonusTiers[i].bonus; } return 0;
            }

            function calculateRowDetails(fields, headers, size, ir) {
                const indexes = { category: headers.indexOf("CATEGORY"), i3qa: headers.indexOf("I3QA_CAT"), rv1cat: headers.indexOf("RV1_CAT"), afp1cat: headers.indexOf("AFP1_CAT"), afp2cat: headers.indexOf("AFP2_CAT"), rv2cat: headers.indexOf("RV2_CAT") };
                let rowPoints = 0; let categoryCounts = Array(9).fill(0); let categoryPoints = Array(9).fill(0);
                [indexes.category, indexes.i3qa, indexes.rv1cat, indexes.afp1cat, indexes.afp2cat, indexes.rv2cat].forEach(idx => {
                    if (idx !== -1 && fields[idx]) {
                        const val = parseInt(fields[idx].trim());
                        if (!isNaN(val) && val >= 1 && val <= 9) {
                            const price = PRICES[val - 1][size]; let currentCategoryPoints = price;
                            if (ir) currentCategoryPoints += 1.5;
                            rowPoints += currentCategoryPoints; categoryCounts[val - 1]++; categoryPoints[val - 1] += currentCategoryPoints;
                        }
                    }
                }); return { rowPoints, categoryCounts, categoryPoints };
            }

            function calculateDetailsForTechIDInRaw(raw, techIDValue, size, ir) {
                const rows = String(raw).split(/\r?\n/).filter(r => r.trim() !== "");
                const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim().toUpperCase()) || [];
                const indexes = { fixId: headers.indexOf("FIX1_ID"), afp1stat: headers.indexOf("AFP1_STAT"), rv1label: headers.indexOf("RV1_LABEL"), i3qalabel: headers.indexOf("I3QA_LABEL"), rv2label: headers.indexOf("RV2_LABEL"), category: headers.indexOf("CATEGORY"), i3qa: headers.indexOf("I3QA_CAT"), rv1cat: headers.indexOf("RV1_CAT"), afp1cat: headers.indexOf("AFP1_CAT"), afp2cat: headers.indexOf("AFP2_CAT"), rv2cat: headers.indexOf("RV2_CAT") };
                if (indexes.fixId === -1) return null;
                let totalPoints = 0, additionalFixPoints = 0, excessiveFixPoints = 0, missFixPoints = 0, incorrectCounting = 0, incorrectPointsValue = 0;
                const categoryPoints = Array(9).fill(0); const categoryCounts = Array(9).fill(0);
                const matched = rows.filter(row => { const fields = row.split(/[\t,]/); return fields[indexes.fixId]?.trim().toUpperCase() === techIDValue; });
                matched.forEach(row => {
                    const fields = row.split(/[\t,]/);
                    if (indexes.rv1label !== -1 && fields[indexes.rv1label]) { if (fields[indexes.rv1label].toUpperCase().includes("E")) excessiveFixPoints++; if (fields[indexes.rv1label].toUpperCase().includes("M")) missFixPoints++; if (fields[indexes.rv1label].toUpperCase().includes("I")) incorrectCounting++; }
                    if (indexes.i3qalabel !== -1 && fields[indexes.i3qalabel] && fields[indexes.i3qalabel].toUpperCase().includes("M")) missFixPoints++;
                    if (indexes.rv2label !== -1 && fields[indexes.rv2label]) { if (fields[indexes.rv2label].toUpperCase().includes("E")) excessiveFixPoints++; if (fields[indexes.rv2label].toUpperCase().includes("M")) missFixPoints++; if (fields[indexes.rv2label].toUpperCase().includes("I")) incorrectCounting++; }
                    if (indexes.afp1stat !== -1 && fields[indexes.afp1stat] && fields[indexes.afp1stat].toUpperCase() === "AA") additionalFixPoints++;
                    const rowDetails = calculateRowDetails(fields, headers, size, ir);
                    totalPoints += rowDetails.rowPoints; rowDetails.categoryCounts.forEach((count, index) => categoryCounts[index] += count); rowDetails.categoryPoints.forEach((points, index) => categoryPoints[index] += points);
                    if (indexes.rv1label !== -1 && fields[indexes.rv1label]?.toUpperCase().includes("I")) { const rv1CatValue = parseInt(fields[indexes.rv1cat]?.trim()); if (indexes.rv1cat !== -1 && !isNaN(rv1CatValue) && rv1CatValue >= 1 && rv1CatValue <= 9) { const basePrice = PRICES[rv1CatValue - 1][size]; if (basePrice !== undefined && !isNaN(basePrice)) { let ptsInc = basePrice; if (ir) ptsInc += 1.5; incorrectPointsValue += ptsInc; } } }
                    if (indexes.rv2label !== -1 && fields[indexes.rv2label]?.toUpperCase().includes("I")) { const rv2CatValue = parseInt(fields[indexes.rv2cat]?.trim()); if (indexes.rv2cat !== -1 && !isNaN(rv2CatValue) && rv2CatValue >= 1 && rv2CatValue <= 9) { const basePrice = PRICES[rv2CatValue - 1][size]; if (basePrice !== undefined && !isNaN(basePrice)) { let ptsInc = basePrice; if (ir) ptsInc += 1.5; incorrectPointsValue += ptsInc; } } }
                });
                const correctPoints = totalPoints - incorrectPointsValue; const qualityPercentage = (totalPoints > 0) ? (correctPoints / totalPoints) * 100 : 0;
                const bonusPercentage = getBonusPercentage(qualityPercentage); const qualityBonus = totalPoints * (bonusPercentage / 100); const estimatedSalary = totalPoints + qualityBonus;
                return { techID: techIDValue, totalPoints, additionalFixPoints, excessiveFixPoints, missFixPoints, incorrectCounting, incorrectPointsValue, qualityPercentage, bonusPercentage, qualityBonus, estimatedSalary, categoryPoints, categoryCounts };
            }

            function saveProject() {
                const name = projectNameInput.value.trim(); const data = rawDataInput.value.trim(); const size = modalSizeSelect.value; const ir = modalIrCheck.checked;
                if (!name || !data) { showToast('Please enter a project name and data.', 'red'); return; }
                const payload = JSON.stringify({ data, size, ir }); const storageKey = `tl_project_${name}`;
                if (editingProjectName && editingProjectName !== name) localStorage.removeItem(`tl_project_${editingProjectName}`);
                if (safeSetLocalStorage(storageKey, payload)) {
                    showToast(`Project '${name}' saved!`, 'green'); loadProjectList(); M.Modal.getInstance(addProjectModalEl).close();
                    projectNameInput.value = ''; rawDataInput.value = ''; modalSizeSelect.value = '3in'; modalIrCheck.checked = false;
                    if (dbfFileInput) { dbfFileInput.value = null; const filePathInput = dbfFileInput.closest('.file-field').querySelector('.file-path'); if (filePathInput) filePathInput.value = ''; }
                    M.FormSelect.init(modalSizeSelect); M.updateTextFields(); editingProjectName = null;
                }
            }

            async function deleteSelectedProject() {
                const selected = projectSelector.value; if (!selected) { showToast('No project selected.', 'red'); return; }
                const confirmed = await showCustomConfirm(`Are you sure you want to delete project '${selected}'?`, 'Delete Project');
                if (confirmed) {
                    localStorage.removeItem(`tl_project_${selected}`); showToast(`Project '${selected}' deleted.`, 'orange');
                    loadProjectList(); activeProjectData = ''; outputDiv.textContent = ''; allResultsDiv.innerHTML = '';
                    allCalculatedResults = []; lastResult = ''; allProjectsAggregatedResults = {}; editingProjectName = null;
                }
            }

            function searchTechID() {
                const raw = activeProjectData?.data; const techIDValue = techIdInput.value.trim().toUpperCase(); const size = activeProjectData?.size; const ir = activeProjectData?.ir;
                outputDiv.innerHTML = ''; allResultsDiv.innerHTML = ''; lastResult = ''; allCalculatedResults = []; allProjectsAggregatedResults = {};
                if (!raw || !techIDValue || !size) { outputDiv.innerHTML = '<p>Please load a project first and enter a TECH ID to search.</p>'; addResultButtons(outputDiv); return; }
                const result = calculateDetailsForTechIDInRaw(raw, techIDValue, size, ir);
                if (result) {
                    const techIdHighlightClass = result.techID.length < 6 ? 'tech-id-red-highlight' : 'tech-id-highlight';
                    let outputHtml = `<h5>Search Results for TECH ID: <span class="${techIdHighlightClass}">${result.techID}</span></h5><p><strong>Project Total Points: ${result.totalPoints.toFixed(2)}</strong></p><table class="striped"><thead><tr><th>Metric</th><th>Value</th><th>Count/N/A</th></tr></thead><tbody>`;
                    result.categoryPoints.forEach((total, i) => outputHtml += `<tr><td>CAT ${i + 1}</td><td>${total.toFixed(2)}</td><td>${result.categoryCounts[i]}</td></tr>`);
                    outputHtml += `<tr><td>Additional FixPoints</td><td>N/A</td><td>${result.additionalFixPoints}</td></tr><tr><td>Excessive FixPoints</td><td>N/A</td><td>${result.excessiveFixPoints}</td></tr><tr><td>Miss FixPoints</td><td>N/A</td><td>${result.missFixPoints}</td></tr><tr><td>Incorrect Counting</td><td>N/A</td><td>${result.incorrectCounting}</td></tr><tr><td>Incorrect Points Value</td><td>${result.incorrectPointsValue.toFixed(2)}</td><td>N/A</td></tr><tr><td>Total Points</td><td>${result.totalPoints.toFixed(2)}</td><td>N/A</td></tr><tr><td>Quality Percentage</td><td>${result.qualityPercentage.toFixed(2)}%</td><td>N/A</td></tr><tr><td>Bonus Percentage</td><td>${result.bonusPercentage.toFixed(2)}%</td><td>N/A</td></tr><tr><td>Quality Bonus</td><td>${result.qualityBonus.toFixed(2)}</td><td>N/A</td></tr><tr><td class="salary-highlight">Estimated Salary</td><td class="salary-highlight">${result.estimatedSalary.toFixed(2)}</td><td class="salary-highlight">N/A</td></tr></tbody></table>`;
                    outputDiv.innerHTML = outputHtml; lastResult = result;
                } else { outputDiv.innerHTML = `<p>TECH ID '${techIDValue}' not found or error in data in the loaded project.</p>`; }
                addResultButtons(outputDiv);
            }

            function calculateAllTechIDs() {
                const raw = activeProjectData?.data; const size = activeProjectData?.size; const ir = activeProjectData?.ir;
                if (!raw || !size) { allResultsDiv.innerHTML = '<p>Please load a project first.</p>'; allCalculatedResults = []; allProjectsAggregatedResults = {}; addResultButtons(allResultsDiv); return; }
                const rows = String(raw).split(/\r?\n/).filter(r => r.trim() !== ""); const headers = rows.shift()?.split(/[\t,]/).map(h => h.trim().toUpperCase()) || []; const fixIdIndex = headers.indexOf("FIX1_ID");
                if (fixIdIndex === -1) { allResultsDiv.innerHTML = '<p>Error: FIX1_ID column not found.</p>'; allCalculatedResults = []; allProjectsAggregatedResults = {}; addResultButtons(allResultsDiv); return; }
                const techIDs = new Set(); rows.forEach(row => { const fields = row.split(/[\t,]/); const techID = fields[fixIdIndex]?.trim().toUpperCase(); if (techID) techIDs.add(techID); });
                allCalculatedResults = []; let tableHtml = '<table class="striped"><thead><tr>';
                const tableHeaders = [ 'TECH ID', ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Points`), ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Count`), 'Additional FixPoints', 'Excessive FixPoints', 'Miss FixPoints', 'Incorrect Counting', 'Incorrect Points Value', 'Total Points', 'Quality %', 'Bonus %', 'Quality Bonus', 'Estimated Salary' ];
                tableHeaders.forEach(headerText => tableHtml += `<th>${headerText}</th>`); tableHtml += '</tr></thead><tbody>';
                techIDs.forEach(techID => {
                    const result = calculateDetailsForTechIDInRaw(raw, techID, size, ir);
                    if (result) {
                        allCalculatedResults.push(result);
                        const qualityClass = result.qualityPercentage === 100 ? 'quality-green' : (result.qualityPercentage >= 77.50 ? 'quality-orange' : 'quality-red');
                        const techIdHighlightClass = result.techID.length < 6 ? 'tech-id-red-highlight' : 'tech-id-highlight';
                        let bonusClass = result.bonusPercentage >= 100 ? 'quality-green' : (result.bonusPercentage > 0 ? 'quality-orange' : 'quality-red');
                        tableHtml += `<tr><td class="${techIdHighlightClass}">${techID}</td>`;
                        result.categoryPoints.forEach(total => tableHtml += `<td>${total.toFixed(2)}</td>`); result.categoryCounts.forEach(count => tableHtml += `<td>${count}</td>`);
                        tableHtml += `<td>${result.additionalFixPoints}</td><td>${result.excessiveFixPoints}</td><td>${result.missFixPoints}</td><td>${result.incorrectCounting}</td><td>${result.incorrectPointsValue.toFixed(2)}</td><td>${result.totalPoints.toFixed(2)}</td>`;
                        tableHtml += `<td class="${qualityClass}">${result.qualityPercentage.toFixed(2)}%</td><td class="${bonusClass}">${result.bonusPercentage.toFixed(2)}%</td><td class="${bonusClass}">${result.qualityBonus.toFixed(2)}</td><td class="salary-highlight">${result.estimatedSalary.toFixed(2)}</td></tr>`;
                    }
                }); tableHtml += '</tbody></table>'; allResultsDiv.innerHTML = `<h5>Results for Loaded Project</h5>${tableHtml}`; outputDiv.textContent = ''; allProjectsAggregatedResults = {}; addResultButtons(allResultsDiv);
            }

            function calculateTotalAcrossAllProjects() {
                const multiplier = parseFloat(multiplierInput.value) || 1; allProjectsAggregatedResults = {}; let processingErrors = [];
                const allProjectsRawData = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('tl_project_')) {
                        const projectName = key.replace('tl_project_', ''); const projectDataString = safeGetLocalStorage(key);
                        if (projectDataString !== null) { try { const project = JSON.parse(projectDataString); if (project && typeof project === 'object' && 'data' in project && 'size' in project && 'ir' in project) { allProjectsRawData.push({ name: projectName, data: String(project.data), size: project.size, ir: project.ir }); } else { processingErrors.push(`Project '${projectName}': Invalid project data structure.`); } } catch (e) { processingErrors.push(`Project '${projectName}': Error processing data - ${e.message}`); console.error(`Error processing project '${projectName}':`, e); } } else { processingErrors.push(`Project '${projectName}': Could not retrieve data.`); }
                    }
                }
                const allUniqueTechIDs = new Set();
                allProjectsRawData.forEach(project => { const rows = project.data.split(/\r?\n/).filter(r => r.trim() !== ""); if (rows.length > 0) { const headerRow = rows.shift(); const headers = headerRow.split(/[\t,]/).map(h => h.trim().toUpperCase()); const fixIdIndex = headers.indexOf("FIX1_ID"); if (fixIdIndex === -1) return; rows.forEach(row => { const fields = row.split(/[\t,]/); const techID = fields[fixIdIndex]?.trim().toUpperCase(); if (techID) allUniqueTechIDs.add(techID); }); } });
                allUniqueTechIDs.forEach(techID => {
                    allProjectsAggregatedResults[techID] = { baseTotalPoints: 0, incorrectPointsValue: 0, additionalFixPoints: 0, excessiveFixPoints: 0, missFixPoints: 0, incorrectCounting: 0, categoryPoints: Array(9).fill(0), categoryCounts: Array(9).fill(0), totalPoints: 0, qualityPercentage: 0, bonusPercentage: 0, qualityBonus: 0, estimatedSalary: 0 };
                    allProjectsRawData.forEach(project => {
                        const projectSpecificResult = calculateDetailsForTechIDInRaw(project.data, techID, project.size, project.ir);
                        if (projectSpecificResult) {
                            allProjectsAggregatedResults[techID].baseTotalPoints += projectSpecificResult.totalPoints; allProjectsAggregatedResults[techID].incorrectPointsValue += projectSpecificResult.incorrectPointsValue; allProjectsAggregatedResults[techID].additionalFixPoints += projectSpecificResult.additionalFixPoints; allProjectsAggregatedResults[techID].excessiveFixPoints += projectSpecificResult.excessiveFixPoints; allProjectsAggregatedResults[techID].missFixPoints += projectSpecificResult.missFixPoints; allProjectsAggregatedResults[techID].incorrectCounting += projectSpecificResult.incorrectCounting;
                            projectSpecificResult.categoryPoints.forEach((points, index) => allProjectsAggregatedResults[techID].categoryPoints[index] += points); projectSpecificResult.categoryCounts.forEach((count, index) => allProjectsAggregatedResults[techID].categoryCounts[index] += count);
                        }
                    });
                    const aggregatedResult = allProjectsAggregatedResults[techID]; aggregatedResult.totalPoints = aggregatedResult.baseTotalPoints * multiplier; const correctPointsAggregated = aggregatedResult.baseTotalPoints - aggregatedResult.incorrectPointsValue;
                    aggregatedResult.qualityPercentage = (aggregatedResult.baseTotalPoints > 0) ? (correctPointsAggregated / aggregatedResult.baseTotalPoints) * 100 : 0; aggregatedResult.bonusPercentage = getBonusPercentage(aggregatedResult.qualityPercentage);
                    aggregatedResult.qualityBonus = aggregatedResult.baseTotalPoints * (aggregatedResult.bonusPercentage / 100); aggregatedResult.estimatedSalary = aggregatedResult.totalPoints + aggregatedResult.qualityBonus;
                });
                let grandTotal = 0; Object.values(allProjectsAggregatedResults).forEach(result => grandTotal += result.totalPoints);
                let tableHtml = `<h5>Totals Across All Projects (Multiplier: ${multiplier.toFixed(2)})</h5>`;
                if (Object.keys(allProjectsAggregatedResults).length === 0) { tableHtml += '<p>No TECH IDs found across all projects.</p>'; }
                else {
                    tableHtml += '<table class="striped"><thead><tr>'; const aggregatedHeaders = [ 'TECH ID', ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Points`), ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Count`), 'Additional FixPoints', 'Excessive FixPoints', 'Miss FixPoints', 'Incorrect Counting', 'Incorrect Points Value', 'Total Points (w/ Multiplier)', 'Quality %', 'Bonus %', 'Quality Bonus', 'Estimated Salary' ];
                    aggregatedHeaders.forEach(headerText => tableHtml += `<th>${headerText}</th>`); tableHtml += '</tr></thead><tbody>';
                    Object.entries(allProjectsAggregatedResults).sort((a, b) => a[0].localeCompare(b[0])).forEach(([techID, result]) => {
                        const qualityClass = result.qualityPercentage === 100 ? 'quality-green' : (result.qualityPercentage >= 77.50 ? 'quality-orange' : 'quality-red'); const techIdHighlightClass = techID.length < 6 ? 'tech-id-red-highlight' : 'tech-id-highlight'; let bonusClass = result.bonusPercentage >= 100 ? 'quality-green' : (result.bonusPercentage > 0 ? 'quality-orange' : 'quality-red');
                        tableHtml += `<tr><td class="${techIdHighlightClass}">${techID}</td>`; result.categoryPoints.forEach(total => tableHtml += `<td>${total.toFixed(2)}</td>`); result.categoryCounts.forEach(count => tableHtml += `<td>${count}</td>`);
                        tableHtml += `<td>${result.additionalFixPoints}</td><td>${result.excessiveFixPoints}</td><td>${result.missFixPoints}</td><td>${result.incorrectCounting}</td><td>${result.incorrectPointsValue.toFixed(2)}</td><td>${result.totalPoints.toFixed(2)}</td>`;
                        tableHtml += `<td class="${qualityClass}">${result.qualityPercentage.toFixed(2)}%</td><td class="${bonusClass}">${result.bonusPercentage.toFixed(2)}%</td><td class="${bonusClass}">${result.qualityBonus.toFixed(2)}</td><td class="salary-highlight">${result.estimatedSalary.toFixed(2)}</td></tr>`;
                    }); tableHtml += '</tbody></table>'; tableHtml += `<h4 style="margin-top: 20px;">Team Total Points: ${grandTotal.toFixed(2)} points</h4>`;
                }
                if (processingErrors.length > 0) { tableHtml += '<div class="card red lighten-5"><div class="card-content red-text text-darken-4"><span class="card-title">Processing Warnings/Errors</span><ul>'; processingErrors.forEach(error => tableHtml += `<li>${error}</li>`); tableHtml += '</ul></div></div>'; }
                allResultsDiv.innerHTML = tableHtml; outputDiv.textContent = ''; allCalculatedResults = []; addResultButtons(allResultsDiv); M.Modal.getInstance(document.getElementById('multiplier-modal')).close();
            }

            function exportToCsv(filename, data) {
                if (!data || (Array.isArray(data) && data.length === 0)) { showToast('No data to export.', 'red'); return; }
                let csvContent = "data:text/csv;charset=utf-8,"; let headers = [];
                if (Array.isArray(data)) { headers = [ 'TECH ID', ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Points`), ...Array.from({ length: 9 }, (_, i) => `CAT ${i + 1} Count`), 'Additional FixPoints', 'Excessive FixPoints', 'Miss FixPoints', 'Incorrect Counting', 'Incorrect Points Value', 'Total Points (w/ Multiplier)', 'Quality %', 'Bonus %', 'Quality Bonus', 'Estimated Salary' ]; } else { headers = ['Metric', 'Value', 'Count/N/A']; }
                csvContent += headers.join(",") + "\n";
                if (Array.isArray(data)) { data.forEach(item => { let row = [ item.techID, ...item.categoryPoints.map(p => p.toFixed(2)), ...item.categoryCounts, item.additionalFixPoints, item.excessiveFixPoints, item.missFixPoints, item.incorrectCounting, item.incorrectPointsValue.toFixed(2), item.totalPoints.toFixed(2), item.qualityPercentage.toFixed(2) + '%', item.bonusPercentage.toFixed(2) + '%', item.qualityBonus.toFixed(2), item.estimatedSalary.toFixed(2) ]; csvContent += row.join(",") + "\n"; }); }
                else { csvContent += `"Total Points",${data.totalPoints.toFixed(2)},N/A\n`; data.categoryPoints.forEach((total, i) => csvContent += `"CAT ${i + 1}",${total.toFixed(2)},${data.categoryCounts[i]}\n`); csvContent += `"Additional FixPoints",N/A,${data.additionalFixPoints}\n`; csvContent += `"Excessive FixPoints",N/A,${data.excessiveFixPoints}\n`; csvContent += `"Miss FixPoints",N/A,${data.missFixPoints}\n`; csvContent += `"Incorrect Counting",N/A,${data.incorrectCounting}\n`; csvContent += `"Incorrect Points Value",${data.incorrectPointsValue.toFixed(2)},N/A\n`; csvContent += `"Quality Percentage",${data.qualityPercentage.toFixed(2)}%,N/A\n`; csvContent += `"Bonus Percentage",${data.bonusPercentage.toFixed(2)}%,N/A\n`; csvContent += `"Quality Bonus",${data.qualityBonus.toFixed(2)},N/A\n`; csvContent += `"Estimated Salary",${data.estimatedSalary.toFixed(2)},N/A\n`; }
                const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", filename); document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast('CSV exported successfully!', 'green');
            }

            async function autoFetchExternalJson() {
                showLoader(); showToast('Attempting to update projects online...', 'blue');
                try {
                    const response = await fetch(HARDCODED_PROJECTS_JSON_URL); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const compressedText = await response.text(); const decompressedText = LZString.decompressFromBase64(compressedText); if (decompressedText === null) throw new Error("Decompression failed.");
                    const externalProjects = JSON.parse(decompressedText); if (!Array.isArray(externalProjects)) throw new Error("External JSON is not an array.");
                    let updatedCount = 0, addedCount = 0;
                    for (const project of externalProjects) { if (project.name && typeof project.data === 'object' && project.data !== null && 'data' in project.data && 'size' in project.data && 'ir' in project.data) { const storageKey = `tl_project_${project.name}`; const newPayload = JSON.stringify(project.data); const existingStoredString = safeGetLocalStorage(storageKey); let existingParsedData = null; if (existingStoredString) { try { existingParsedData = JSON.parse(existingStoredString); } catch (parseError) { console.warn(`Error parsing existing project '${project.name}' during auto-fetch:`, parseError); } } if (!existingParsedData || JSON.stringify(existingParsedData) !== newPayload) { if (safeSetLocalStorage(storageKey, newPayload)) { if (existingParsedData) updatedCount++; else addedCount++; } } } else { console.warn("Skipping invalid project entry from online source:", project); } }
                    loadProjectList(); showToast(`Projects updated! Added: ${addedCount}, Updated: ${updatedCount}`, 'green');
                } catch (e) { showToast(`Failed to update projects: ${e.message}`, 'red'); console.error("Auto-fetch error:", e); } finally { hideLoader(); }
            }

            async function verifyTlLoginCode(enteredCode) {
                try { const response = await fetch(HARDCODED_TL_CODE_URL); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const tlCodeData = await response.json(); return tlCodeData.code === enteredCode; }
                catch (e) { showToast(`Error fetching TL login code: ${e.message}`, 'red'); console.error("TL code fetch error:", e); return false; }
            }

            function updateButtonVisibility() {
                const tlButtons = [addProjectButton, document.getElementById('edit-project'), document.getElementById('delete-project'), document.getElementById('copy-all-projects-json')];
                tlButtons.forEach(button => { if (button) button.style.display = isLoggedInAsTL ? 'inline-block' : 'none'; });
                const commonButtons = [ 'calculate-all-button', 'calculate-all-projects-button', 'export-button', 'search-button', 'view-project-data-button', 'auto-fetch-external-json', 'clear-data-button' ];
                commonButtons.forEach(id => { const btn = document.getElementById(id); if (btn) btn.style.display = 'inline-block'; });
            }

            async function handleDbfFileSelect(event) {
                const file = event.target.files[0];
                const filePathInput = event.target.closest('.file-field').querySelector('.file-path'); 

                if (!file) {
                    if (filePathInput && filePathInput.value !== '') filePathInput.value = '';
                    event.target.value = null; return;
                }
                if (!file.name.toLowerCase().endsWith('.dbf')) {
                    showToast('Please select a .DBF file.', 'red');
                    event.target.value = null; if (filePathInput) filePathInput.value = ''; return;
                }

                if (typeof window.Buffer !== 'function') {
                    showToast('DBF Error: Buffer component not available. Cannot process file.', 'red', 6000);
                    console.error("handleDbfFileSelect: window.Buffer is not a function. This should have been caught by initial checks in DOMContentLoaded.");
                    return;
                }
                if (typeof Dbf !== 'object' || typeof Dbf.read !== 'function') {
                    showToast('DBF Error: DBF reader library not available. Cannot process file.', 'red', 6000);
                    console.error("handleDbfFileSelect: Dbf object or Dbf.read is not available. This should have been caught by initial checks in DOMContentLoaded.");
                    return;
                }

                showLoader();
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        const datatable = Dbf.read(Buffer.from(arrayBuffer)); // Uses window.Buffer
                        if (datatable && datatable.rows && datatable.columns) {
                            let outputString = datatable.columns.map(col => col.name).join("\t") + "\n";
                            datatable.rows.forEach(row => {
                                const rowValues = datatable.columns.map(col => {
                                    const value = row[col.name];
                                    return (value !== undefined && value !== null) ? String(value).replace(/\r?\n|\r/g, ' ') : "";
                                });
                                outputString += rowValues.join("\t") + "\n";
                            });
                            rawDataInput.value = outputString;
                            M.textareaAutoResize(rawDataInput); M.updateTextFields(); 
                            showToast('DBF file imported successfully!', 'green');
                        } else { showToast('Could not parse DBF data. File empty, corrupted, or unsupported.', 'red'); }
                    } catch (error) { console.error("Error parsing DBF file:", error); showToast(`Error parsing DBF: ${error.message}`, 'red');
                    } finally {
                        hideLoader(); event.target.value = null; 
                        if (filePathInput) filePathInput.value = ''; 
                    }
                };
                reader.onerror = function() {
                    hideLoader(); showToast('Error reading file.', 'red');
                    event.target.value = null; if (filePathInput) filePathInput.value = '';
                };
                reader.readAsArrayBuffer(file);
            }

            // --- Event Listeners Setup ---
            document.getElementById('search-button').addEventListener('click', searchTechID);
            document.getElementById('calculate-all-button').addEventListener('click', calculateAllTechIDs);
            document.getElementById('calculate-all-projects-button').addEventListener('click', () => M.Modal.getInstance(document.getElementById('multiplier-modal')).open());
            applyMultiplierButton.addEventListener('click', calculateTotalAcrossAllProjects);
            projectSelector.addEventListener('change', () => {
                const selectedProjectName = projectSelector.value; const projectDataString = safeGetLocalStorage(`tl_project_${selectedProjectName}`);
                if (projectDataString) { try { activeProjectData = JSON.parse(projectDataString); showToast(`Project '${selectedProjectName}' loaded.`, 'blue'); outputDiv.textContent = ''; allResultsDiv.innerHTML = ''; lastResult = ''; allCalculatedResults = []; allProjectsAggregatedResults = {}; if (isLoggedInAsTL) { rawDataInput.value = activeProjectData.data; projectNameInput.value = selectedProjectName; modalSizeSelect.value = activeProjectData.size; modalIrCheck.checked = activeProjectData.ir; M.updateTextFields(); M.FormSelect.init(modalSizeSelect); editingProjectName = selectedProjectName; } } catch (e) { showToast(`Error parsing project data for '${selectedProjectName}'.`, 'red'); console.error("Project data parse error:", e); activeProjectData = ''; } }
                else { activeProjectData = ''; outputDiv.textContent = ''; allResultsDiv.innerHTML = ''; lastResult = ''; allCalculatedResults = []; allProjectsAggregatedResults = {}; if (isLoggedInAsTL) { projectNameInput.value = ''; rawDataInput.value = ''; modalSizeSelect.value = '3in'; modalIrCheck.checked = false; M.updateTextFields(); M.FormSelect.init(modalSizeSelect); } editingProjectName = null; }
            });
            document.getElementById('edit-project').addEventListener('click', () => {
                const selectedProjectName = projectSelector.value; if (!selectedProjectName) { showToast('Please select a project to edit.', 'red'); return; }
                const projectDataString = safeGetLocalStorage(`tl_project_${selectedProjectName}`);
                if (projectDataString) { try { const project = JSON.parse(projectDataString); projectNameInput.value = selectedProjectName; rawDataInput.value = project.data; modalSizeSelect.value = project.size; modalIrCheck.checked = project.ir; if (dbfFileInput) { dbfFileInput.value = null; const filePathInput = dbfFileInput.closest('.file-field').querySelector('.file-path'); if (filePathInput) filePathInput.value = ''; } M.updateTextFields(); M.FormSelect.init(modalSizeSelect); modalTitle.textContent = 'Edit Project'; saveProjectModalButton.textContent = 'Update Project'; editingProjectName = selectedProjectName; M.Modal.getInstance(addProjectModalEl).open(); } catch (e) { showToast(`Error loading project data for editing '${selectedProjectName}'.`, 'red'); console.error("Edit project data load error:", e); } } else { showToast('Error: Could not load project data for editing.', 'red'); }
            });
            document.getElementById('delete-project').addEventListener('click', deleteSelectedProject);
            addProjectButton.addEventListener('click', () => { 
                modalTitle.textContent = 'Add New Project'; saveProjectModalButton.textContent = 'Save Project'; projectNameInput.value = ''; rawDataInput.value = ''; modalSizeSelect.value = '3in'; modalIrCheck.checked = false; if (dbfFileInput) { dbfFileInput.value = null; const filePathInput = dbfFileInput.closest('.file-field').querySelector('.file-path'); if (filePathInput) filePathInput.value = ''; } M.updateTextFields(); M.FormSelect.init(modalSizeSelect); editingProjectName = null; 
            });
            saveProjectModalButton.addEventListener('click', saveProject);
            clearDataButton.addEventListener('click', async () => { const confirmed = await showCustomConfirm('Are you sure you want to clear ALL saved projects? This cannot be undone.', 'Clear All Data'); if (confirmed) { for (let i = localStorage.length - 1; i >= 0; i--) { const key = localStorage.key(i); if (key.startsWith('tl_project_')) localStorage.removeItem(key); } loadProjectList(); activeProjectData = ''; outputDiv.textContent = ''; allResultsDiv.innerHTML = ''; allCalculatedResults = []; lastResult = ''; allProjectsAggregatedResults = {}; showToast('All projects cleared!', 'green'); } });
            document.getElementById('export-button').addEventListener('click', () => { if (Object.keys(allProjectsAggregatedResults).length > 0) { exportToCsv('all_projects_summary.csv', Object.values(allProjectsAggregatedResults)); } else if (allCalculatedResults.length > 0) { exportToCsv('per_project_summary.csv', allCalculatedResults); } else if (lastResult) { exportToCsv(`tech_id_${lastResult.techID}_details.csv`, lastResult); } else { showToast('No results to export.', 'red'); } });
            document.getElementById('copy-all-projects-json').addEventListener('click', () => { const allProjectsDataForExport = []; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith('tl_project_')) { const projectName = key.replace('tl_project_', ''); const projectDataString = safeGetLocalStorage(key); if (projectDataString !== null) { try { allProjectsDataForExport.push({ name: projectName, data: JSON.parse(projectDataString) }); } catch (e) { console.error(`Error parsing project JSON for key ${key} during copy:`, e); showToast(`Error copying project '${projectName}'.`, 'red'); } } } } if (allProjectsDataForExport.length === 0) { showToast('No saved projects to copy.', 'orange'); return; } try { const compressed = LZString.compressToBase64(JSON.stringify(allProjectsDataForExport)); navigator.clipboard.writeText(compressed).then(() => showToast('All project data (compressed) copied!', 'green')).catch(err => { showToast('Failed to copy.', 'red'); console.error('Copy fail: ', err); }); } catch (e) { showToast('Compression error during copy.', 'red'); console.error('Copy compression error:', e); } });
            autoFetchButton.addEventListener('click', autoFetchExternalJson);
            loginRoleSelect.addEventListener('change', () => { tlCodeInputDiv.style.display = loginRoleSelect.value === 'tl' ? 'block' : 'none'; if (loginRoleSelect.value === 'tl') tlLoginCodeInput.setAttribute('required', 'required'); else tlLoginCodeInput.removeAttribute('required'); M.updateTextFields(); });
            loginButtonElement.addEventListener('click', async () => { const selectedRole = loginRoleSelect.value; if (selectedRole === 'tl') { if (await verifyTlLoginCode(tlLoginCodeInput.value)) { isLoggedInAsTL = true; showToast('Logged in as TL!', 'green'); M.Modal.getInstance(loginModalEl).close(); mainAppContent.style.display = 'block'; loadProjectList(); updateButtonVisibility(); } else { showToast('Incorrect TL code.', 'red'); isLoggedInAsTL = false; } } else if (selectedRole === 'tech') { isLoggedInAsTL = false; showToast('Logged in as Tech!', 'green'); M.Modal.getInstance(loginModalEl).close(); mainAppContent.style.display = 'block'; loadProjectList(); updateButtonVisibility(); } else { showToast('Please select a role.', 'orange'); } });
            logoutButton.addEventListener('click', () => { isLoggedInAsTL = false; showToast('Logged out.', 'blue'); mainAppContent.style.display = 'none'; outputDiv.textContent = ''; allResultsDiv.innerHTML = ''; lastResult = ''; allCalculatedResults = []; allProjectsAggregatedResults = {}; loginRoleSelect.value = ''; tlLoginCodeInput.value = ''; tlCodeInputDiv.style.display = 'none'; M.FormSelect.init(loginRoleSelect); M.updateTextFields(); M.Modal.getInstance(loginModalEl).open(); });
            if (fullscreenCloseButton) fullscreenCloseButton.addEventListener('click', hideFullscreenModal);
            fullscreenResultsModal.addEventListener('click', (event) => { if (event.target === fullscreenResultsModal) hideFullscreenModal(); });
            if (viewProjectDataButton) viewProjectDataButton.addEventListener('click', viewProjectData);
            if (dbfFileInput) dbfFileInput.addEventListener('change', handleDbfFileSelect);
            
            function applyDarkModePreference() {
                let isDarkMode = localStorage.getItem('darkMode') || 'disabled'; 
                if (localStorage.getItem('darkMode') === null) localStorage.setItem('darkMode', 'disabled');
                if (isDarkMode === 'enabled') { document.body.classList.add('dark-mode'); darkModeToggle.querySelector('i').textContent = 'brightness_4'; } 
                else { document.body.classList.remove('dark-mode'); darkModeToggle.querySelector('i').textContent = 'brightness_high'; }
            }
            darkModeToggle.addEventListener('click', () => { localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'disabled' : 'enabled'); applyDarkModePreference(); });
            
            // --- Materialize Initializations & App Start ---
            document.body.style.display = 'none'; 
            applyDarkModePreference(); 

            M.Modal.init(document.querySelectorAll('.modal'), {
                dismissible: false, 
                onOpenEnd: (modalEl_instance) => { // modalEl is the DOM element, not instance here
                    if (modalEl_instance.id === 'add-project-modal') {
                        M.textareaAutoResize(rawDataInput); 
                        if (dbfFileInput) { 
                            dbfFileInput.value = null;
                            const filePathInput = dbfFileInput.closest('.file-field').querySelector('.file-path');
                            if (filePathInput) filePathInput.value = '';
                        }
                         M.updateTextFields(); 
                    }
                }
            });
            const loginModalInstance = M.Modal.getInstance(loginModalEl); 
            if (loginModalInstance) loginModalInstance.options.dismissible = false;

            confirmationConfirmButton.addEventListener('click', () => { if (confirmPromiseResolve) { confirmPromiseResolve(true); confirmPromiseResolve = null; } });
            confirmationCancelButton.addEventListener('click', () => { if (confirmPromiseResolve) { confirmPromiseResolve(false); confirmPromiseResolve = null; } });

            M.FormSelect.init(projectSelector); 
            M.FormSelect.init(loginRoleSelect); 
            M.FormSelect.init(modalSizeSelect); 
            
            document.body.style.display = 'block'; 

            if (loginModalInstance) loginModalInstance.open();
            else {
                console.error("Login modal not found/initialized.");
                if (mainAppContent) mainAppContent.style.display = 'block'; 
                loadProjectList(); updateButtonVisibility();
            }
        }); // End of main DOMContentLoaded listener
    </script>
</body>
</html>
